<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="record thinking and exploring">
<meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="https://kujourinka.github.io/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="record thinking and exploring">
<meta property="og:locale">
<meta property="article:author" content="Kujou Rinka">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.0.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Rinka çš„éšç¬”</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Suche"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Suche"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://kujourinka.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main">
  
    <article id="post-re0_ss1" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/08/08/re0_ss1/" class="article-date">
  <time class="dt-published" datetime="2023-08-08T15:00:00.000Z" itemprop="datePublished">2023-08-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/08/08/re0_ss1/">ä»é›¶å†™ä¸€ä¸ª shadowsocksï¼ˆ1ï¼‰</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h3 id="0-å¼•è¨€"><a href="#0-å¼•è¨€" class="headerlink" title="0. å¼•è¨€"></a>0. å¼•è¨€</h3><p>ç±»ä¼¼ shadowsocksï¼Œv2rayï¼Œtrojan ä¹‹ç±»çš„ä»£ç†è½¯ä»¶åŸç†ï¼Œç”¨ä¸€å¼ å¾ˆè€çš„å›¾å°±èƒ½æ¦‚æ‹¬ï¼š<br><img src="https://raw.githubusercontent.com/KujouRinka/flowchart/master/20230808/ss.png" alt="ssåŸç†"></p>
<p>æ˜¯ä¸æ˜¯å¾ˆç®€å•å‘€ï¼Ÿé‚£ä¹ˆä»Šå¤©æˆ‘ä»¬å°±æ¥ç®€å•å®ç°ä¸€ä¸‹ã€‚ä¸è¿‡é‰´äºè¿™ç§åŸºçŸ³è½¯ä»¶ç”¨çš„äººæ•°ä¹‹å¤šï¼Œç½‘ä¸Šæƒ³å¿…ä¹Ÿæœ‰å¾ˆå¤šç±»ä¼¼çš„æ–‡ç« ï¼Œæˆ‘å†å†™è¿™ç§é™ˆè¯æ»¥è°ƒä¸€æ˜¯æ— èŠï¼ŒäºŒæ˜¯æ— ç”¨ã€‚æ‰€ä»¥æˆ‘æ‰“ç®—åŠ ä¸€ç‚¹æ–°é²œä¸œè¥¿ï¼Œè®²è¿°ä¸€ä¸ªä»£ç†è½¯ä»¶æ˜¯å¦‚ä½•ä¸€æ­¥æ­¥å°†ç®€å•çš„è½¬å‘æµé‡çš„åŠŸèƒ½æ‹“å±•åˆ°ï¼š</p>
<ul>
<li>å¤šä¸ªç›‘å¬å’Œè½¬å‘ç«¯å£</li>
<li>æ”¯æŒå¤šç§åè®®</li>
<li>è·¯ç”±åŠŸèƒ½</li>
<li>â€¦</li>
</ul>
<p>æœ€ä¸»è¦çš„è¿˜æ˜¯è®°å½•ä¸‹æˆ‘å¯¹è¿™ç§è½¯ä»¶çš„å„ä¸ªéƒ¨ä»¶å¦‚ä½•è®¾è®¡å’Œç»„ç»‡çš„ç†è§£ã€‚</p>
<p>å› æ­¤ï¼Œå†™ä¸‹æœ¬æ–‡çš„ä¸»è¦ç›®çš„æ˜¯ï¼š</p>
<ul>
<li>è®°å½•ä»£ç†è½¯ä»¶çš„åŸç†å’Œå®ç°</li>
<li>æç»˜æ•´ä¸ªè½¯ä»¶çš„è®¾è®¡æ¡†æ¶</li>
<li><del>å›é¡¾ä¸‹æˆ‘æ˜¯æ€ä¹ˆå†™å‡ºè¿™ç ´ä»£ç çš„</del></li>
</ul>
<p>æ•´ä¸ªé¡¹ç›®ä½¿ç”¨ C++ ç¼–å†™ï¼Œå…¶ä¸­æˆ‘ä½¿ç”¨äº† <a target="_blank" rel="noopener" href="https://think-async.com/Asio/">asio</a> åº“ï¼ŒçœŸçš„å¾ˆå¥½ç”¨ï¼Œè°ç”¨è°çŸ¥é“ï¼</p>
<p>Letâ€™s go!</p>
<h3 id="1-å¼€å§‹"><a href="#1-å¼€å§‹" class="headerlink" title="1. å¼€å§‹"></a>1. å¼€å§‹</h3><h5 id="ä»å“ªå¼€å§‹ï¼Ÿ"><a href="#ä»å“ªå¼€å§‹ï¼Ÿ" class="headerlink" title="ä»å“ªå¼€å§‹ï¼Ÿ"></a>ä»å“ªå¼€å§‹ï¼Ÿ</h5><p>å°±åƒè€ç‰›åƒå—ç“œâ€”â€”æ— ä»ä¸‹å£ï¼Œæˆ‘ä»¬åº”è¯¥ä»å“ªé‡Œå¼€å§‹ï¼Ÿä»£ç†è½¯ä»¶çš„æ ¸å¿ƒæ˜¯è½¬å‘æµé‡ï¼Œç”¨ v2ray ä¸­çš„åè¯ï¼Œä¸ç®¡æ˜¯ local ç«¯è¿˜æ˜¯ server ç«¯ï¼Œéƒ½éœ€è¦ inboundï¼ˆå…¥ç«™ï¼‰å’Œ outboundï¼ˆå‡ºç«™ï¼‰ã€‚ç”±äº local ç«¯å’Œ server ç«¯è¿è¡Œçš„æ˜¯åŒä¸€å¥—è½¯ä»¶ï¼Œæˆ‘ä»¬åªéœ€æš‚æ—¶å°†æ³¨æ„åŠ›é›†ä¸­åœ¨ local ä¸Šçš„è®¾è®¡å³å¯ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å†æ¬¡å°†é—®é¢˜ç®€åŒ–ï¼Œè®¾è®¡ä¸€ä¸ªä»…å°†æµé‡åŸå°ä¸åŠ¨åœ°è½¬å‘åˆ°äº’è”ç½‘çš„ä¸œè¥¿ï¼Œå®ƒçœ‹èµ·æ¥å°±åƒï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">         socks  +---------+          +----------+</span><br><span class="line">browser &lt;======&gt;| inbound |&lt;========&gt;| outbound |&lt;======&gt; internet</span><br><span class="line">                +---------+          +----------+</span><br></pre></td></tr></table></figure>

<h5 id="ç›‘å¬æœ¬åœ°"><a href="#ç›‘å¬æœ¬åœ°" class="headerlink" title="ç›‘å¬æœ¬åœ°"></a>ç›‘å¬æœ¬åœ°</h5><p>æ—¢ç„¶è¦è½¬å‘æµé‡ï¼Œé¦–å…ˆå°±è¦ç›‘å¬åˆ°æµé‡ï¼Œæˆ‘ä»¬ä½¿ç”¨ <code>127.0.0.1:8888 </code> ä½œä¸ºç›‘å¬åœ°å€ç›‘å¬æœ¬åœ°æµé‡ã€‚æˆ‘ä»¬éœ€è¦é€šè¿‡è¿™ä¸ª socket ä¸æ–­ accept æµè§ˆå™¨çš„è¯·æ±‚ï¼Œéšåå†é€šè¿‡è¯»å†™é€šè¿‡ accept å¾—åˆ°çš„ socket å¤„ç†åç»­è¿æ¥ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> io_context ctx;</span><br><span class="line"><span class="type">static</span> ip::<span class="function">tcp::acceptor <span class="title">listen_sock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">    ip::tcp::endpoint(ip::address::from_string(<span class="string">&quot;127.0.0.1&quot;</span>), <span class="number">8888</span>)</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> tcp_sock = ip::tcp::socket;</span><br><span class="line"><span class="keyword">using</span> tcp_sock_p = shared_ptr&lt;tcp_sock&gt;;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">to_listen</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">tcp_sock_p <span class="title">sp</span><span class="params">(<span class="keyword">new</span> tcp_sock(ctx))</span></span>;</span><br><span class="line">  listen_sock.<span class="built_in">async_accept</span>(*sp, [sp](<span class="type">const</span> error_code err) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!err) &#123;</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> åœ¨è¿™é‡Œå¤„ç†é€šè¿‡ accept å¾—åˆ°çš„ socket</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">to_listen</span>();</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="built_in">to_listen</span>();</span><br><span class="line">  ctx.<span class="built_in">run</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢å°±æ˜¯æ•´ä¸ªç¨‹åºçš„å…¥å£ï¼Œ<code>to_listen()</code> ä¸­é€šè¿‡è°ƒç”¨ <code>listen_sock.async_accept()</code>ï¼Œæˆ‘ä»¬ä¼šæŠŠ remote sock çš„ä¿¡æ¯å†™å…¥åˆ°ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œè€Œä½œä¸ºç¬¬äºŒä¸ªå‚æ•°çš„ lambda å‡½æ•°æ˜¯ <code>async_accept()</code> çš„ callbackï¼Œè¿™ä¸ªå‡½æ•°ä¼šåœ¨ accept å·¥ä½œå®Œæˆï¼Œå³ï¼Œç¬¬ä¸€ä¸ªå‚æ•°è¢«å†™å…¥ remote sock çš„ä¿¡æ¯åè¢«è°ƒç”¨ï¼›äºæ˜¯è¿™ä¸ª callback å‡½æ•°çš„é€»è¾‘å°±å¾ˆæ¸…æ™°äº†ï¼šå¤„ç† remote sockï¼Œå¹¶è°ƒç”¨ <code>to_listen()</code> ç»§ç»­ç›‘å¬ä¸‹ä¸€ä¸ªåˆ°æ¥çš„è¿æ¥ã€‚</p>
<p>éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š</p>
<ul>
<li>è¿™é‡Œå¤„ç† remote sock çš„ä»£ç å¿…é¡»ä¹Ÿæ˜¯å¼‚æ­¥çš„ï¼Œå¦åˆ™ä¼šé˜»å¡ç›‘å¬ä¸‹ä¸€ä¸ª sock</li>
<li>ä¼ å…¥ <code>async_accept()</code> çš„ sock å¿…é¡»åˆ†é…åœ¨å †ä¸Šã€‚åŸå› æ˜¯ <code>async_accept()</code> ä½œä¸ºå¼‚æ­¥å‡½æ•°ä¼šç«‹å³è¿”å›ï¼Œ<code>to_listen()</code> å¯èƒ½åœ¨ <code>async_accept()</code> å®Œæˆå·¥ä½œå‰å°±æ—©æ—©è¿”å›ï¼Œå¦‚æœ sock åˆ†é…åœ¨æ ˆä¸Šå¯èƒ½ä¼šè¢«è¿‡æ—©å›æ”¶ã€‚</li>
</ul>
<p>æˆ‘ä»¬å·²ç»å¾—åˆ°äº†éœ€è¦è¿›è¡Œè¯»å†™æ“ä½œçš„ sockï¼Œè€Œæˆ‘ä»¬åº”è¯¥å¦‚ä½•ç»§ç»­å¤„ç†è¿™ä¸ªçƒ«æ‰‹å±±èŠ‹å‘¢ï¼Ÿ</p>
<p>ã¤ã¥ã</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kujourinka.github.io/2023/08/08/re0_ss1/" data-id="cll2gun8u0007d8p07hfyaha0" data-title="ä»é›¶å†™ä¸€ä¸ª shadowsocksï¼ˆ1ï¼‰" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-simple_impl_for_lazy" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/04/20/simple_impl_for_lazy/" class="article-date">
  <time class="dt-published" datetime="2023-04-20T09:00:00.000Z" itemprop="datePublished">2023-04-20</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/04/20/simple_impl_for_lazy/">ç®€è®°ä¸€æ¬¡ rCore ä¸­ sys_sbrk() ä¸ lazy allocation çš„å®ç°</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="sbrk-çš„ä½œç”¨"><a href="#sbrk-çš„ä½œç”¨" class="headerlink" title="sbrk() çš„ä½œç”¨"></a>sbrk() çš„ä½œç”¨</h4><p><code>sbrk()</code> ç³»ç»Ÿæ˜¯åšä»€ä¹ˆçš„ï¼Œå¯ä»¥å‚è€ƒ<a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/brk.2.html">è¿™é‡Œ</a>ï¼Œç®€è¦æ¥è¯´ï¼Œå°±æ˜¯è°ƒæ•´ç”¨æˆ·ç¨‹åºçš„å †ï¼ˆheapï¼‰é¡¶ä½ç½®ï¼Œè¡¨ç°ä¸ºå¯¹å †å¤§å°çš„å¢å¤§æˆ–ç¼©å°ã€‚</p>
<h4 id="rCore-çš„åœ°å€ç©ºé—´å¸ƒå±€ä¸è°ƒæ•´"><a href="#rCore-çš„åœ°å€ç©ºé—´å¸ƒå±€ä¸è°ƒæ•´" class="headerlink" title="rCore çš„åœ°å€ç©ºé—´å¸ƒå±€ä¸è°ƒæ•´"></a>rCore çš„åœ°å€ç©ºé—´å¸ƒå±€ä¸è°ƒæ•´</h4><p>è¿™é‡Œçš„ <code>sbrk()</code> å®ç°ä»…ä¸ç”¨æˆ·è™šæ‹Ÿåœ°å€ç©ºé—´æœ‰å…³ã€‚å‚è€ƒ<a target="_blank" rel="noopener" href="http://rcore-os.cn/rCore-Tutorial-Book-v3/chapter4/5kernel-app-spaces.html#term-vm-app-addr-space">è¿™é‡Œ</a>ã€‚</p>
<p>å¯¹äº rCore åŸå§‹å¸ƒå±€ï¼Œåœ¨ä½åœ°å€éƒ¨åˆ†ï¼Œä»ä½åœ°å€å¾€é«˜åœ°å€ä¾æ¬¡ä¸ºï¼š<code>.text</code>ï¼Œ<code>.rodata</code>ï¼Œ<code>.data</code>ï¼Œ<code>.bss</code>ï¼Œ<code>guard page</code>ï¼Œ<code>user stack</code>ï¼Œéšåæ‰æ˜¯ <code>heap</code>ï¼š</p>
<p><img src="https://raw.githubusercontent.com/rcore-os/rCore-Tutorial-Book-v3/main/source/chapter4/app-as-full.png" alt="application address space"></p>
<p>ä½†æˆ‘å¯¹è¿™ä¸ªå¸ƒå±€ä¸å¤ªæ»¡æ„ï¼Œäºæ˜¯é€šè¿‡ä¿®æ”¹ <code>mm::memory_set::MemorySet::from_elf()</code>ï¼Œå°†ç©ºé—´å¸ƒå±€ä¿®æ”¹ä¸ºå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">/// High 256GB</span><br><span class="line">/// +-------------------+</span><br><span class="line">/// |  Trampoline Code  |</span><br><span class="line">/// +-------------------+  &lt;- TRAMPOLINE</span><br><span class="line">/// |    TrapContext    |</span><br><span class="line">/// +-------------------+  &lt;- TRAP_CONTEXT, user_stack_top</span><br><span class="line">/// |    User Stack     |</span><br><span class="line">/// +-------------------+  &lt;- user_stack_bottom</span><br><span class="line">/// |       ...         |</span><br><span class="line">///</span><br><span class="line">/// Low 256GB</span><br><span class="line">/// |       ...         |</span><br><span class="line">/// +-------------------+</span><br><span class="line">/// |    Heap Memory    |</span><br><span class="line">/// +-------------------+  &lt;- heap_bottom</span><br><span class="line">/// |      .bss         |</span><br><span class="line">/// +-------------------+</span><br><span class="line">/// |      .data        |</span><br><span class="line">/// +-------------------+</span><br><span class="line">/// |      .rodata      |</span><br><span class="line">/// +-------------------+</span><br><span class="line">/// |      .text        |</span><br><span class="line">/// +-------------------+  &lt;- BASE_ADDRESS (0x10000 va)</span><br></pre></td></tr></table></figure>

<p>heap ç´§æŒ¨ç€ bss æ®µï¼Œè€Œ user stack è°ƒæ•´åˆ°é«˜åœ°å€å¤„ã€‚è¿™ä¹ˆåšçš„åŸå› æ˜¯å½“ç‰©ç†åœ°å€ç†è®ºè¶³å¤Ÿçš„æƒ…å†µä¸‹ï¼Œå¯ä»¥æ–¹ä¾¿ heap å’Œ user stack çš„æ‹“å±•ï¼ŒåŒæ—¶ç”±äºäºŒè€…ä½ç½®ç›¸å·®å¤§ï¼Œä¸å¤ªå¯èƒ½é‡å ï¼Œè€ŒåŸå®ç°ç›¸è¾ƒäºæ­¤ï¼Œuser stack çš„å¤§å°é™åˆ¶ä¸º 8Kï¼ˆå³ä¸¤ä¸ª PAGE SIZEï¼‰ï¼Œç”±ç”±äºå…¶ä½ç½®çš„ç‰¹æ®Šæ€§ï¼Œä¸Šæœ‰ heap ç©ºé—´ï¼Œä¸‹æœ‰ guard pageï¼Œkernel æ®µï¼Œéš¾ä»¥æ‹“å±•ã€‚è¿™ä¸ªä¿®æ”¹å¾ˆç®€å•ï¼Œæˆ‘ä»¬çš„é‡ç‚¹ä¸åœ¨è¿™é‡Œã€‚</p>
<h4 id="sbrk"><a href="#sbrk" class="headerlink" title="sbrk()"></a>sbrk()</h4><p>ä¸å…¶ä»–çš„ç³»ç»Ÿè°ƒç”¨å®ç°ä¸€æ ·ï¼Œå…ˆæ·»åŠ ç³»ç»Ÿè°ƒç”¨æ¥å£ï¼Œå†å®ç°å…·ä½“çš„é€»è¾‘ã€‚</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">sys_sbrk</span>(size: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">isize</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> <span class="variable">Some</span>(old_brk) = <span class="title function_ invoke__">change_program_brk</span>(size) &#123;</span><br><span class="line">    <span class="keyword">return</span> old_brk <span class="keyword">as</span> <span class="type">isize</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    -<span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¡ºç€è°ƒç”¨é“¾ï¼Œæˆ‘ä»¬æ¥åˆ° <code>task::task::TaskControlBlock::change_brk()</code>ï¼Œè¿™æ˜¯å®é™…çš„ sbrk çš„å®ç°ã€‚ä¸»è¦çš„é€»è¾‘ä¸ºæ ¹æ®åˆ¤æ–­ä¼ å…¥çš„å‚æ•°çš„æ­£è´Ÿåˆ¤æ–­å †ç©ºé—´çš„ç¼©å‡ï¼Œå¹¶æ›´æ–°ç›¸åº”çš„å †é¡¶æŒ‡é’ˆï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">let</span> <span class="variable">old_brk</span> = <span class="keyword">self</span>.program_brk;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">new_brk</span> = <span class="keyword">self</span>.program_brk <span class="keyword">as</span> <span class="type">isize</span> + size <span class="keyword">as</span> <span class="type">isize</span>;</span><br><span class="line"><span class="keyword">let</span> <span class="variable">result</span> = <span class="keyword">if</span> size &lt; <span class="number">0</span> &#123;</span><br><span class="line">  <span class="comment">// shrink heap</span></span><br><span class="line">  <span class="keyword">self</span>.memory_set.<span class="title function_ invoke__">shrink_to</span>(...)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// extend heap</span></span><br><span class="line">  <span class="keyword">self</span>.memory_set.<span class="title function_ invoke__">append_to</span>(...)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">if</span> result &#123;</span><br><span class="line">  <span class="keyword">self</span>.program_brk = new_brk <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">  <span class="title function_ invoke__">Some</span>(old_brk)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="literal">None</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¼©å°å’Œæ‰©å¤§ heap ç©ºé—´åˆ†åˆ«å¯¹åº” <code>shrink_to</code> å’Œ <code>append_to</code> ä¸¤ä¸ªå‡½æ•°ï¼Œè€ŒäºŒè€…çš„é€»è¾‘è¾ƒä¸ºç›¸ä¼¼ï¼Œè¿™é‡Œä»¥ <code>append_to</code> ä¸ºä¾‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">append_to</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, page_table: &amp;<span class="keyword">mut</span> PageTable, new_end: VirtPageNum) &#123;</span><br><span class="line">  <span class="keyword">for</span> <span class="variable">vpn</span> <span class="keyword">in</span> VPNRange::<span class="title function_ invoke__">new</span>(<span class="keyword">self</span>.vpn_range.<span class="title function_ invoke__">get_end</span>(), new_end) &#123;</span><br><span class="line">    <span class="keyword">self</span>.<span class="title function_ invoke__">map_one</span>(page_table, vpn);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">self</span>.vpn_range = VPNRange::<span class="title function_ invoke__">new</span>(<span class="keyword">self</span>.vpn_range.<span class="title function_ invoke__">get_start</span>(), new_end);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å³æœ´å®åœ°ä¸ºæ¯ä¸€é¡µåœ¨ PageTable é‡Œåˆ›å»ºä¸€ä¸ªæ˜ å°„ï¼Œå¹¶æ²¡æœ‰ä»€ä¹ˆèŠ±é‡Œèƒ¡å“¨çš„ä¸œè¥¿ã€‚</p>
<h4 id="lazy-alloc"><a href="#lazy-alloc" class="headerlink" title="lazy alloc"></a>lazy alloc</h4><p>lazy alloc å¯ä»¥æ¦‚æ‹¬ä¸ºï¼šåªæ ‡è®°ï¼Œéœ€è¦æ—¶åˆ†é…ã€‚</p>
<p>å…·ä½“æ¥è¯´ï¼š</p>
<ul>
<li>å½“è°ƒç”¨ <code>sbrk()</code> ç”³è¯·æ‹“å±• heap ç©ºé—´ï¼Œå†…æ ¸åªå¢åŠ å †é¡¶æŒ‡é’ˆï¼ˆåœ¨è¿™é‡Œæ˜¯ <code>TaskControlBlock::program_brk</code>ï¼‰çš„å€¼ï¼Œä¸åšå®é™…çš„å†…å­˜åˆ†é…ï¼Œæ·»åŠ æ˜ å°„ã€‚ç”¨æˆ·ç¨‹åºè®¿é—®è¿™æ®µå†…å­˜ä¼šå¼•èµ· PageFaultï¼Œæˆ‘ä»¬åœ¨å¤„ç†è¯¥ Trap çš„æ—¶å€™é€šè¿‡ <code>stval</code> å¯„å­˜å™¨åˆ¤æ–­è¯¥åœ°å€æ˜¯å¦ä½äº <code>heap_bottom</code> å’Œ <code>program_brk</code> ä¹‹é—´ï¼Œè‹¥æ˜¯ï¼Œåˆ†é…å®é™…å†…å­˜ï¼Œæ·»åŠ é¡µè¡¨æ˜ å°„ï¼›</li>
<li>å½“è°ƒç”¨ <code>sbrk()</code> ç”³è¯·ç¼©å° heap ç©ºé—´ï¼Œéœ€è¦å‡å° <code>program_brk</code> çš„å€¼ï¼ŒåŒæ—¶æ”¶å›åŸå †é¡¶å’Œç°å †é¡¶ä¹‹é—´çš„ pageã€‚</li>
</ul>
<h5 id="æ‹“å±•-PageTable"><a href="#æ‹“å±•-PageTable" class="headerlink" title="æ‹“å±• PageTable"></a>æ‹“å±• PageTable</h5><p>ç”±äºåŸå®ç°ä¸­ <code>PageTable::map()</code> å’Œ <code>PageTable::unmap()</code> åœ¨æ¥å£æ–¹é¢å®ç°è¾ƒä¸ºæœ‰é™ï¼Œæˆ‘å°†å…¶è¿›è¡Œäº†æ‹“å±•ï¼Œå°†</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">map</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, vpn: VirtPageNum, ppn: PhysPageNum, flags: PTEFlags, <span class="keyword">mut</span> frame: <span class="type">Option</span>&lt;FrameTracker&gt;);</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">unmap</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, vpn: VirtPageNum, dealloc: <span class="type">bool</span>);</span><br></pre></td></tr></table></figure>

<p>ä¿®æ”¹ä¸ºï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">map</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, args: MapArgs) &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">MapArgs</span> &#123; vpn, ppn, flags, <span class="keyword">mut</span> frame &#125; = args;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">unmap</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, args: UnmapArgs) &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">vpn</span> = args.vpn;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">pte</span> = <span class="keyword">match</span> <span class="keyword">self</span>.<span class="title function_ invoke__">find_pte</span>(vpn) &#123;</span><br><span class="line">    <span class="title function_ invoke__">Some</span>(pte) <span class="keyword">if</span> pte.<span class="title function_ invoke__">is_valid</span>() =&gt; pte,</span><br><span class="line">    _ =&gt; <span class="keyword">if</span> args.panic &#123;</span><br><span class="line">      <span class="built_in">panic!</span>(<span class="string">&quot;vpn &#123;:?&#125; should mapped but not&quot;</span>, vpn);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç›®å‰ï¼Œ<code>MapArgs</code> å’Œ <code>UnmapArgs</code> ä¸­å­—æ®µè¶³å¤Ÿä½¿ç”¨ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">MapArgs</span> &#123;</span><br><span class="line">  vpn: VirtPageNum,</span><br><span class="line">  ppn: PhysPageNum,</span><br><span class="line">  flags: PTEFlags,</span><br><span class="line">  frame: <span class="type">Option</span>&lt;FrameTracker&gt;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">pub</span> <span class="keyword">struct</span> <span class="title class_">UnmapArgs</span> &#123;</span><br><span class="line">  vpn: VirtPageNum,</span><br><span class="line">  dealloc: <span class="type">bool</span>,</span><br><span class="line">  panic: <span class="type">bool</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¸¤ä¸ªå†…ä»¥è®¾è®¡æ¨¡å¼ä¸­çš„ Builder è®¾è®¡ï¼Œä½¿ç”¨ä¸€ç³»åˆ—çš„ <code>with_...</code> æˆå‘˜å‡½æ•°è°ƒæ•´å‚æ•°ã€‚</p>
<p>ä¸ºäº†ä¾¿äºæ§åˆ¶åç»­è¯¾ç¨‹ä¸­ lazy_alloc çš„ä½¿ç”¨ä¸å¦ï¼Œä¸º lazy alloc æ–°å¢ä¸€ä¸ª feature å¹¶ä½¿ç”¨æ¡ä»¶ç¼–è¯‘ï¼š</p>
<figure class="highlight toml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Cargo.toml</span></span><br><span class="line"><span class="comment"># ...</span></span><br><span class="line"><span class="section">[features]</span></span><br><span class="line"><span class="attr">default</span> = [<span class="string">&quot;sbrk_lazy_alloc&quot;</span>]</span><br><span class="line"><span class="attr">sbrk_lazy_alloc</span> = []</span><br></pre></td></tr></table></figure>

<h5 id="Trap"><a href="#Trap" class="headerlink" title="Trap"></a>Trap</h5><p><code>trap_handler</code> ä¸­ä¸º lazy alloc æ·»åŠ çš„å…¥å£ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Trap::<span class="title function_ invoke__">Exception</span>(Exception::StoreFault)</span><br><span class="line">| Trap::<span class="title function_ invoke__">Exception</span>(Exception::StorePageFault)</span><br><span class="line">| Trap::<span class="title function_ invoke__">Exception</span>(Exception::LoadFault)</span><br><span class="line">| Trap::<span class="title function_ invoke__">Exception</span>(Exception::LoadPageFault) =&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">tcb</span> = <span class="title function_ invoke__">get_current_tcb_ref</span>();</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">ok</span> = <span class="keyword">if</span> stval &gt;= tcb.heap_bottom &amp;&amp; stval &lt; tcb.program_brk &#123;</span><br><span class="line">    <span class="comment">// lazy allocation for sbrk()</span></span><br><span class="line">    <span class="meta">#[cfg(feature = <span class="string">&quot;sbrk_lazy_alloc&quot;</span>)]</span> &#123;</span><br><span class="line">      <span class="title function_ invoke__">lazy_alloc_page</span>(stval.<span class="title function_ invoke__">into</span>())</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">#[cfg(not(feature = <span class="string">&quot;sbrk_lazy_alloc&quot;</span>))]</span> &#123;</span><br><span class="line">      <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>å½“åˆ¤æ–­ <code>stval</code> ä¸­çš„åœ°å€ä¸º heap ä¸­çš„æœ‰æ•ˆåœ°å€æ—¶ï¼Œä½¿ç”¨ <code>lazy_alloc_page()</code> åˆ†é…ä¸€é¡µå†…å­˜ï¼Œå®ç°è¾ƒä¸ºç®€å•ï¼Œè¿™é‡Œä¸è¿‡åˆ†è¯´æ˜ã€‚</p>
<h5 id="change-brk"><a href="#change-brk" class="headerlink" title="change_brk()"></a>change_brk()</h5><p>æˆ‘ä»¬çš„é‡ç‚¹æ˜¯ <code>change_brk()</code> çš„ä¿®æ”¹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">change_brk</span>(&amp;<span class="keyword">mut</span> <span class="keyword">self</span>, size: <span class="type">i32</span>) <span class="punctuation">-&gt;</span> <span class="type">Option</span>&lt;<span class="type">usize</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">old_brk</span> = <span class="keyword">self</span>.program_brk;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">new_brk</span> = <span class="keyword">self</span>.program_brk <span class="keyword">as</span> <span class="type">isize</span> + size <span class="keyword">as</span> <span class="type">isize</span>;</span><br><span class="line">  <span class="keyword">if</span> new_brk &lt; <span class="keyword">self</span>.heap_bottom <span class="keyword">as</span> <span class="type">isize</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> <span class="variable">ok</span>;</span><br><span class="line">  cfg_if! &#123;</span><br><span class="line">    <span class="keyword">if</span> <span class="meta">#[cfg(feature = <span class="string">&quot;sbrk_lazy_alloc&quot;</span>)]</span> &#123;</span><br><span class="line">      ok = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">if</span> size &lt; <span class="number">0</span> &#123;</span><br><span class="line">        <span class="keyword">self</span>.memory_set</span><br><span class="line">          .<span class="title function_ invoke__">remove_framed_area</span>(</span><br><span class="line">            VirtAddr::<span class="title function_ invoke__">from</span>(new_brk <span class="keyword">as</span> <span class="type">usize</span>),</span><br><span class="line">            VirtAddr::<span class="title function_ invoke__">from</span>(<span class="keyword">self</span>.program_brk),</span><br><span class="line">          );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ok &#123;</span><br><span class="line">    <span class="keyword">self</span>.program_brk = new_brk <span class="keyword">as</span> <span class="type">usize</span>;</span><br><span class="line">    <span class="title function_ invoke__">Some</span>(old_brk)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="literal">None</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œå½“ <code>size &gt; 0</code> æˆ‘ä»¬ä»…ä»…å¢åŠ äº† <code>program_brk</code> çš„å€¼å°±è¿”å›ï¼Œå…¶ä»–ä»€ä¹ˆäº‹ä¹Ÿä¸åšï¼Œè€Œå½“è¯¥å€¼å°äº 0ï¼Œåªå¢åŠ äº†ä¸€ç‚¹å¾®ä¸è¶³é“çš„æ“ä½œï¼šé‡Šæ”¾å‡å°‘çš„é‚£æ®µç©ºé—´ã€‚</p>
<p>è‡³äºä¸ºä»€ä¹ˆæˆ‘æ‹“å±•äº† PageTable çš„å‚æ•°ï¼Œä¸‹é¢ä»¥ <code>remove_framed_area</code> ä¸ºä¾‹ï¼š</p>
<figure class="highlight rust"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">pub</span> <span class="keyword">fn</span> <span class="title function_">remove_framed_area</span>(</span><br><span class="line">  &amp;<span class="keyword">mut</span> <span class="keyword">self</span>,</span><br><span class="line">  start_va: VirtAddr,</span><br><span class="line">  end_va: VirtAddr,</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">for</span> <span class="variable">vpn</span> <span class="keyword">in</span> VPNRange::<span class="title function_ invoke__">new</span>(start_va.<span class="title function_ invoke__">ceil</span>(), end_va.<span class="title function_ invoke__">floor</span>()) &#123;</span><br><span class="line">    <span class="keyword">self</span>.page_table.<span class="title function_ invoke__">unmap</span>(</span><br><span class="line">      UnmapArgs::<span class="title function_ invoke__">builder</span>(vpn)</span><br><span class="line">        .<span class="title function_ invoke__">with_dealloc</span>(<span class="literal">true</span>)</span><br><span class="line">        .<span class="title function_ invoke__">with_panic</span>(<span class="literal">false</span>),</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬é€šè¿‡é“¾å¼æ„é€ ä¸€æ­¥ä¸€æ­¥å¯¹ <code>UnmapArgs</code> åšå‡ºäº†è¦æ±‚ï¼Œæˆ‘ä»¬è¦æ±‚é‡Šæ”¾ç‰©ç†åœ°å€ï¼Œå¹¶ä¸”ä¿è¯ä¸ä¼š panicã€‚è¿™é‡Œæˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ä¿è¯ä¸ä¼š panicï¼Ÿç”±äºåŸå®ç°ä¸­çš„ <code>unmap()</code>ï¼Œè®¾è®¡é»˜è®¤è®¤ä¸ºä¼ ç»™å®ƒçš„å‚æ•°ä¸€å®šç»è¿‡æ˜ å°„ï¼Œå½“æ— æ³•æ‰¾åˆ°æœ€åä¸€çº§é¡µè¡¨æ—¶ï¼Œä¼šè®¤ä¸ºæ˜¯å†…æ ¸è®¾è®¡å‡ºç°äº† bugï¼Œäºæ˜¯ç›´æ¥é€šè¿‡ <code>unwarp()</code> è¿›è¡Œäº† panicã€‚</p>
<p>è€Œè¿™é‡Œæˆ‘ä»¬é‡Šæ”¾ heap ç©ºé—´ï¼Œç”±äº lazy alloc çš„å­˜åœ¨ï¼Œæˆ‘ä»¬å¹¶ä¸èƒ½äº‹å…ˆçŸ¥é“å“ªäº› page è¢«æ˜ å°„äº†è€Œå“ªäº›æ²¡æœ‰ï¼Œæˆ‘ä»¬åˆä¸æƒ³ä»˜å‡ºé¢å¤–çš„å­˜å‚¨ä»£ä»·ï¼Œäºæ˜¯é€‰æ‹©å¯¹è¿™æ®µé‡Šæ”¾çš„ç©ºé—´çš„æ¯ä¸€ page è¿›è¡Œéå†ï¼Œå…¶ä¸­æœ‰å¾ˆå¤§æ¦‚ç‡ä¼šé‡è§ç”±äºä»æœªè¯»å†™è€Œæœªè¿›è¡Œåˆ†é…çš„ pageï¼Œè¿™æ ·ç›´æ¥ä½œä¸ºå‚æ•°ä¼ ç»™åŸæ¥çš„ <code>unmap()</code> å¿…ç„¶ä¼šå¯¼è‡´å†…æ ¸ panicï¼Œäºæ˜¯æŠ½è±¡å‡ºäº† <code>unmap()</code> çš„å‚æ•°ï¼Œä¸ºå…¶æ·»åŠ  <code>panic</code> å­—æ®µï¼Œç”¨äºæç¤º <code>unmap()</code> æ˜¯å¦èƒ½å¤Ÿ panicã€‚</p>
<p>æœ€ç»ˆçš„å®ç°è§ <a target="_blank" rel="noopener" href="https://github.com/KujouRinka/rCore/tree/876012b64189dd9c65e72743d4dbec9e72f22884">#876012b</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kujourinka.github.io/2023/04/20/simple_impl_for_lazy/" data-id="cll2gun8u0008d8p04qw9f7n0" data-title="ç®€è®°ä¸€æ¬¡ rCore ä¸­ sys_sbrk() ä¸ lazy allocation çš„å®ç°" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-nic_driver_kara_syscall_he" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/03/21/nic_driver_kara_syscall_he/" class="article-date">
  <time class="dt-published" datetime="2023-03-21T15:00:00.000Z" itemprop="datePublished">2023-03-21</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/03/21/nic_driver_kara_syscall_he/">ä»ç½‘å¡é©±åŠ¨åˆ°ç³»ç»Ÿè°ƒç”¨</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="placeholder"><a href="#placeholder" class="headerlink" title="placeholder"></a>placeholder</h4><p>éšç€é¸½äº†åŠå¹´çš„æ“ä½œç³»ç»Ÿçš„ lab çš„å®Œæˆï¼Œæˆ‘å¯¹æ“ä½œç³»ç»Ÿçš„å®ç°çš„æ¦‚å¿µæœ‰äº†ä¸€å®šçš„äº†è§£ï¼Œæ¥ä¸‹æ¥ä¾¿æ˜¯å¯¹ä¸€äº›æ¦‚å¿µçš„ç†Ÿæ‚‰äº†ã€‚</p>
<p>ä¸è¿‡åœ¨æ­¤æ¬¡å‰ï¼Œæˆ‘æƒ³è®°å½•ä¸€ä¸‹æˆ‘ä¸ªäººè§‰å¾—æœ€æœ‰æ„æ€çš„ä¸€éƒ¨åˆ†ï¼šå†™ä¸€ä¸ªç®€é™‹çš„ç½‘å¡é©±åŠ¨ã€‚ç®€å•çš„ä»»åŠ¡æ¶µç›–äº†è®¸å¤šæ–¹é¢ï¼Œè¿™ä¹Ÿæ˜¯æ ‡é¢˜çš„ç”±æ¥ã€‚</p>
<p>å…ˆé¸½ä¸€ä¸‹ï¼Œè¿‡å‡ å¤©æœ‰æ—¶é—´ç»§ç»­å†™ğŸ¦</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kujourinka.github.io/2023/03/21/nic_driver_kara_syscall_he/" data-id="cll2gun8t0006d8p0dqtj1jga" data-title="ä»ç½‘å¡é©±åŠ¨åˆ°ç³»ç»Ÿè°ƒç”¨" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-6824_lab2a_leader_election" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2023/02/08/6824_lab2a_leader_election/" class="article-date">
  <time class="dt-published" datetime="2023-02-08T12:00:00.000Z" itemprop="datePublished">2023-02-08</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2023/02/08/6824_lab2a_leader_election/">6.824 Lab2A Leader Election å¯è¡Œæ–¹æ¡ˆ</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h4 id="ä¸€äº›ç¢ç¢å¿µ"><a href="#ä¸€äº›ç¢ç¢å¿µ" class="headerlink" title="ä¸€äº›ç¢ç¢å¿µ"></a>ä¸€äº›ç¢ç¢å¿µ</h4><p>ä¹¦æ¥ä¸Šå›ï¼Œè¿™æ˜¯ 6.824 çš„ <a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/labs/lab-raft.html">lab2A</a>ï¼Œå®ç° raft åè®®ä¸­çš„ leader electionã€‚å…³äº raft çš„æ›´å¤šè¯¦ç»†å†…å®¹ï¼Œ<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/papers/raft-extended.pdf">raft paper</a> å’Œç½‘ç»œä¸Šå¤§å¤šæ•°æ–‡ç« ä¸€å®šä¼šæ¯”æˆ‘åœ¨è¿™é‡Œä»‹ç»å¾—è¯¦ç»†ï¼Œè¿™é‡Œåªç»™å‡ºä¸€ä¸ªé“¾æ¥ï¼Œä»¥åŠ¨å›¾çš„æ–¹å¼åŠ©äºç†è§£ raft çš„å·¥ä½œåŸç†ï¼š<a target="_blank" rel="noopener" href="http://thesecretlivesofdata.com/raft/">Raft</a>ï¼Œ<a target="_blank" rel="noopener" href="https://raft.github.io/">https://raft.github.io/</a> ä¹Ÿæä¾›äº†ä¸€ä¸ªå¯äº¤äº’çš„åŠ¨ç”»ï¼Œå¤§å®¶å¯ä»¥å»ç©ä¸€ç©ã€‚</p>
<p>ä¸ªäººçš„è¿™ä¸ªå®ç°ç›¸è¾ƒäºç½‘ä¸Šçš„å„ç§ç‰ˆæœ¬ï¼Œä»£ç é‡è¾ƒå¤§ï¼Œä½†ä¸ªäººæ„Ÿè§‰é€»è¾‘æ›´åŠ æ¸…æ™°ã€‚</p>
<p>ä¸ä¿è¯ bug freeï¼Œä½†ä½¿ç”¨è¯¾ç¨‹ä¸­çš„ test æµ‹è¯•äº†è¿‘ 1000 è½®æ— ä¸€å¤±è´¥ã€‚</p>
<h4 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h4><p>å®ç° raft åè®®ä¸­çš„ leader electionã€‚ç”± paper ä¸­å¯çŸ¥é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¼šé€‰å‡ºä¸€ä¸ª leader èŠ‚ç‚¹ï¼Œé€‰å‡º leader åå…¶ä½™èŠ‚ç‚¹å‡ä¸º followerã€‚å¯¹é›†ç¾¤çš„å„ç§æ“ä½œéƒ½éœ€è¦ç»è¿‡ leader ä¹‹æ‰‹ï¼Œå…·ä½“è¡¨ç°ä¸º client ç›´æ¥å‘ leader è¿›è¡Œè¯·æ±‚ï¼Œæˆ–å‘ follower è¯·æ±‚ï¼Œéšåè¯¥ follower å°†è¯·æ±‚é‡å®šå‘åˆ° leaderã€‚</p>
<p>å¯¹äºå•ä¸ªèŠ‚ç‚¹ï¼Œæœ‰ä¸‰ç§å¯èƒ½çš„çŠ¶æ€ï¼š</p>
<ul>
<li>follower</li>
<li>candidate</li>
<li>leader</li>
</ul>
<p>å¯¹äºæ¯ä¸ªèŠ‚ç‚¹ï¼Œæœ‰ä»¥ä¸‹å‡ ç§äº‹ä»¶ä¼šå¯¼è‡´çŠ¶æ€é—´çš„è½¬ç§»ï¼š</p>
<ul>
<li>è¶…æ—¶äº‹ä»¶</li>
<li><strong>æ¥æ”¶</strong>åˆ°æ¥è‡ª RequestVote RPC çš„è¯·æ±‚</li>
<li><strong>æ¥æ”¶</strong>åˆ°æ¥è‡ª AppendEntries RPC çš„è¯·æ±‚</li>
</ul>
<p>åŒæ—¶ç”±äºå¤„äº candidate å’Œ leader çŠ¶æ€ä¸‹çš„èŠ‚ç‚¹åˆ†åˆ«ä¼š<strong>å‘å‡º</strong> RequestVote å’Œ AppendEntries è¯·æ±‚ï¼Œè¿˜åº”è¯¥åœ¨ä¸Šé¢ä¸‰ä¸ªäº‹ä»¶ä¸­åŠ å…¥ï¼š</p>
<ul>
<li>æ¥è‡ª RequestVote RPC è¯·æ±‚çš„å›åº”</li>
<li>æ¥è‡ª AppendEntries RPC è¯·æ±‚çš„å›åº”</li>
</ul>
<p>äºæ˜¯ï¼Œæ•´ä¸ª leader election å˜æˆäº†ä¸€ä¸ªå¡«è¡¨æ¸¸æˆï¼š</p>
<table>
<thead>
<tr>
<th align="center">äº‹ä»¶\è¡Œä¸º\çŠ¶æ€</th>
<th align="center">follower</th>
<th align="center">candidate</th>
<th align="center">leader</th>
</tr>
</thead>
<tbody><tr>
<td align="center">timeout</td>
<td align="center">a</td>
<td align="center">d</td>
<td align="center">h</td>
</tr>
<tr>
<td align="center">RequestVote recv</td>
<td align="center">b</td>
<td align="center">e</td>
<td align="center">i</td>
</tr>
<tr>
<td align="center">AppendEntries recv</td>
<td align="center">c</td>
<td align="center">f</td>
<td align="center">j</td>
</tr>
<tr>
<td align="center">RequestVote callback</td>
<td align="center">&#x2F;</td>
<td align="center">g</td>
<td align="center">&#x2F;</td>
</tr>
<tr>
<td align="center">AppendEntries callback</td>
<td align="center">&#x2F;</td>
<td align="center">&#x2F;</td>
<td align="center">k</td>
</tr>
</tbody></table>
<p>å½“è¡¨å¡«å®Œï¼Œæ•´ä¸ªæµç¨‹å°±åŸºæœ¬å®Œæˆäº†ã€‚</p>
<h4 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h4><h5 id="æ‚é¡¹"><a href="#æ‚é¡¹" class="headerlink" title="æ‚é¡¹"></a>æ‚é¡¹</h5><h5 id="rpc-go"><a href="#rpc-go" class="headerlink" title="rpc.go"></a>rpc.go</h5><p>ä¾ç…§ paper å¯¹ <code>rpc.go</code> è¿›è¡Œäº†ä¸€äº›ä¿®æ”¹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ---------- for RequestVote ----------</span></span><br><span class="line"><span class="keyword">type</span> RequestVoteArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Your data here (2A, 2B).</span></span><br><span class="line">	Term        <span class="type">int</span> <span class="comment">// candidate&#x27;s curTerm</span></span><br><span class="line">	CandidateId <span class="type">int</span> <span class="comment">// candidate requesting vote</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> RequestVoteReply <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Your data here (2A).</span></span><br><span class="line">	Term        <span class="type">int</span>  <span class="comment">// currentTerm, for candidate to update itself</span></span><br><span class="line">	VoteGranted <span class="type">bool</span> <span class="comment">// true means candidate received vote</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> voteParam <span class="keyword">struct</span> &#123;</span><br><span class="line">	args   *RequestVoteArgs</span><br><span class="line">	reply  *RequestVoteReply</span><br><span class="line">	notify <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> RequestVote(args *RequestVoteArgs, reply *RequestVoteReply) &#123;</span><br><span class="line">	<span class="comment">// Your code here (2A, 2B).</span></span><br><span class="line">	notify := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	rf.voteChan &lt;- voteParam&#123;args, reply, notify&#125;</span><br><span class="line">	&lt;-notify</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> sendRequestVote(server <span class="type">int</span>, args *RequestVoteArgs, reply *RequestVoteReply) <span class="type">bool</span> &#123;</span><br><span class="line">	ok := rf.peers[server].Call(<span class="string">&quot;Raft.RequestVote&quot;</span>, args, reply)</span><br><span class="line">	<span class="keyword">return</span> ok</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ---------- for AppendEntries ----------</span></span><br><span class="line"><span class="keyword">type</span> AppendEntriesArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">	Term     <span class="type">int</span> <span class="comment">// leader&#x27;s curTerm</span></span><br><span class="line">	LeaderId <span class="type">int</span> <span class="comment">// so follower can redirect clients</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> AppendEntriesReply <span class="keyword">struct</span> &#123;</span><br><span class="line">	Term    <span class="type">int</span>  <span class="comment">// currentTerm, for leader to update itself</span></span><br><span class="line">	Success <span class="type">bool</span> <span class="comment">// true if follower contained entry matching prevLogIndex and prevLogTerm</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> appendEntryParam <span class="keyword">struct</span> &#123;</span><br><span class="line">	args   *AppendEntriesArgs</span><br><span class="line">	reply  *AppendEntriesReply</span><br><span class="line">	notify <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> AppendEntries(args *AppendEntriesArgs, reply *AppendEntriesReply) &#123;</span><br><span class="line">	notify := <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	rf.entryChan &lt;- appendEntryParam&#123;args, reply, notify&#125;</span><br><span class="line">	&lt;-notify</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> sendAppendEntries(server <span class="type">int</span>, args *AppendEntriesArgs, reply *AppendEntriesReply) <span class="type">bool</span> &#123;</span><br><span class="line">	ok := rf.peers[server].Call(<span class="string">&quot;Raft.AppendEntries&quot;</span>, args, reply)</span><br><span class="line">	<span class="keyword">return</span> ok</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘å¹¶æ²¡æœ‰å°†å¤„ç†çš„é€»è¾‘ç›´æ¥å†™åˆ° RPC å¤„ç†å‡½æ•°ä¸­ï¼Œè€Œæ˜¯å°†å…¶å°è£…åˆ°ä¸€ä¸ªç»“æ„ä¸­ï¼Œå‘é€åˆ°ä¸€ä¸ªä¸“é—¨ç”¨äºæ¥å—è¿™ä¸ªå‚æ•°çš„ channel ä¸­ï¼Œå¹¶ä¼ å…¥ä¸€ä¸ªç©º channel ä½œåŒæ­¥ä½œç”¨ã€‚</p>
<h5 id="raft-go"><a href="#raft-go" class="headerlink" title="raft.go"></a>raft.go</h5><p>åœ¨ <code>type Raft struct</code> ä¸­å¢åŠ äº†ä¸€äº› paper ä¸­æåˆ°çš„æœ¬å®ç°éœ€è¦ç”¨åˆ°çš„å­—æ®µï¼ŒåŒ…æ‹¬ä¸Šé¢æåˆ°çš„æ¥å— RPC å‚æ•°çš„ channelï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Your data here (2A, 2B, 2C).</span></span><br><span class="line"><span class="comment">// Look at the paper&#x27;s Figure 2 for a description of what</span></span><br><span class="line"><span class="comment">// state a Raft server must maintain.</span></span><br><span class="line">curTerm  <span class="type">int</span>    <span class="comment">// current curTerm</span></span><br><span class="line">state    RState <span class="comment">// current state</span></span><br><span class="line">votedFor <span class="type">int</span>    <span class="comment">// candidate id that received vote in current curTerm</span></span><br><span class="line"></span><br><span class="line">voteChan  <span class="keyword">chan</span> voteParam        <span class="comment">// channel for vote request</span></span><br><span class="line">entryChan <span class="keyword">chan</span> appendEntryParam <span class="comment">// channel for entry request</span></span><br></pre></td></tr></table></figure>

<p>æœ‰å…³ <code>RState interface</code> å’Œå…·ä½“çš„å®ç°ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> RState <span class="keyword">interface</span> &#123;</span><br><span class="line">	Run(tf *Raft)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> Follower <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="keyword">type</span> Candidate <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line"><span class="keyword">type</span> Leader <span class="keyword">struct</span>&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçš„è®¾è®¡å‚è€ƒäº†<a target="_blank" rel="noopener" href="https://book.douban.com/subject/34262305/">è®¾è®¡æ¨¡å¼ï¼šå¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€</a>ä¸€ä¹¦ä¸­çš„ State æ¨¡å¼ï¼Œäºæ˜¯ï¼Œä¾¿æœ‰äº† <code>GetState</code> å‡½æ•°çš„å¦‚ä¸‹å†™æ³•ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> GetState() (<span class="type">int</span>, <span class="type">bool</span>) &#123;</span><br><span class="line">	rf.mu.Lock()</span><br><span class="line">	<span class="keyword">defer</span> rf.mu.Unlock()</span><br><span class="line">	<span class="keyword">return</span> rf.curTerm, reflect.TypeOf(rf.state) == reflect.TypeOf(&amp;Leader&#123;&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ticker</code> å‡½æ•°ä¹Ÿå˜å¾—æ ¼å¤–ç®€å•ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(rf *Raft)</span></span> ticker() &#123;</span><br><span class="line">	<span class="keyword">for</span> !rf.killed() &#123;</span><br><span class="line">		rf.state.Run(rf)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Make</code> å‡½æ•°åªéœ€è¦åˆå§‹åŒ–æˆ‘ä»¬æ·»åŠ çš„å‡ ä¸ªå­—æ®µå³å¯ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Make</span><span class="params">(peers []*labrpc.ClientEnd, me <span class="type">int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">	persister *Persister, applyCh <span class="keyword">chan</span> ApplyMsg)</span></span> *Raft &#123;</span><br><span class="line">	rf := &amp;Raft&#123;&#125;</span><br><span class="line">	rf.peers = peers</span><br><span class="line">	rf.persister = persister</span><br><span class="line">	rf.me = me</span><br><span class="line"></span><br><span class="line">	rf.curTerm = <span class="number">0</span></span><br><span class="line">	rf.state = &amp;Follower&#123;&#125;</span><br><span class="line">	rf.votedFor = <span class="number">-1</span></span><br><span class="line"></span><br><span class="line">	rf.voteChan = <span class="built_in">make</span>(<span class="keyword">chan</span> voteParam)</span><br><span class="line">	rf.entryChan = <span class="built_in">make</span>(<span class="keyword">chan</span> appendEntryParam)</span><br><span class="line">	rf.readPersist(persister.ReadRaftState())</span><br><span class="line"></span><br><span class="line">	<span class="comment">// start ticker goroutine to start elections</span></span><br><span class="line">	<span class="keyword">go</span> rf.ticker()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> rf</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="common-go"><a href="#common-go" class="headerlink" title="common.go"></a>common.go</h5><p>å®šä¹‰ä¸€äº›å¸¸ç”¨å‡½æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	ReElectLower = <span class="number">150</span></span><br><span class="line">	ReElectUpper = <span class="number">300</span></span><br><span class="line"></span><br><span class="line">	HeartBeatTimeout = <span class="number">100</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">randBetween</span><span class="params">(lower, upper <span class="type">int</span>)</span></span> <span class="type">int</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> rand.Intn(upper-lower) + lower</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">electionTimeout</span><span class="params">()</span></span> time.Duration &#123;</span><br><span class="line">	<span class="keyword">return</span> time.Duration(randBetween(ReElectLower, ReElectUpper)) * time.Millisecond</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">heartbeatTimeout</span><span class="params">()</span></span> time.Duration &#123;</span><br><span class="line">	<span class="keyword">return</span> time.Duration(HeartBeatTimeout) * time.Millisecond</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">resetTimer</span><span class="params">(timer *time.Timer, timeout time.Duration)</span></span> &#123;</span><br><span class="line">	<span class="keyword">if</span> !timer.Stop() &#123;</span><br><span class="line">		&lt;-timer.C</span><br><span class="line">	&#125;</span><br><span class="line">	timer.Reset(timeout)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="é‡å¤´æˆ"><a href="#é‡å¤´æˆ" class="headerlink" title="é‡å¤´æˆ"></a>é‡å¤´æˆ</h4><p>ä¸‹é¢æ­£ç‰‡å¼€å§‹ï¼Œæˆ‘å°†ä¸åŒçŠ¶æ€çš„é€»è¾‘åˆ†å¼€å†™ï¼Œè™½ç„¶ä»£ç çœ‹ä¸Šå»æŒºé•¿çš„ï¼Œä½†æ˜¯æˆ‘æ„Ÿè§‰é€»è¾‘æŒºæ¸…æ™°çš„</p>
<h5 id="follower-go"><a href="#follower-go" class="headerlink" title="follower.go"></a>follower.go</h5><p>follower æ˜¯æœ€ç®€å•çš„ä¸€ä¸ªå®ç°å¯¹ç…§æˆ‘ä¸Šé¢ç”»çš„ä¸€ä¸ªè¡¨ï¼Œåªéœ€è¦å¤„ç†ä¸‰ä¸ªäº‹ä»¶ï¼Œå¤§è‡´æ¡†æ¶å¦‚ä¸‹ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(f *Follower)</span></span> Run(rf *Raft) &#123;</span><br><span class="line">	timer := time.NewTimer(electionTimeout())</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-timer.C:</span><br><span class="line">		<span class="comment">// a å¤„ç†è¶…æ—¶</span></span><br><span class="line">		<span class="keyword">case</span> vote := &lt;-rf.voteChan:</span><br><span class="line">		<span class="comment">// b å¤„ç† RequestVote è¯·æ±‚</span></span><br><span class="line">		<span class="keyword">case</span> entry := &lt;-rf.entryChan:</span><br><span class="line">		<span class="comment">// c å¤„ç† AppendEntries è¯·æ±‚</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å½“ follower è¶…æ—¶ï¼Œè‡ªåŠ¨å˜ä¸º candidateï¼Œå¹¶ä¸ºè‡ªå·±æŠ•ç¥¨ï¼Œå› æ­¤ï¼Œa å¤„å¡«å†™ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">rf.mu.Lock()</span><br><span class="line">rf.state = &amp;Candidate&#123;&#125;</span><br><span class="line">rf.votedFor = rf.me</span><br><span class="line">rf.mu.Unlock()</span><br><span class="line"><span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<p>å½“ candidate æ”¶åˆ° RequestVote RPC çš„è¯·æ±‚ï¼Œé¦–å…ˆæ£€æŸ¥ <code>Term</code>ï¼Œè‹¥å°äº <code>curTerm</code> åˆ™æ‹’ç»ä¸ºå…¶æŠ•ç¥¨ï¼›è‹¥æ»¡è¶³ <code>Term &gt; curTerm</code> æˆ–è€… <code>Term == curTerm &amp;&amp; vote.args.CandidateId</code>ï¼ŒåŒæ„ä¸ºå…¶æŠ•ç¥¨ï¼Œå¹¶é‡ç½®è¶…æ—¶è®¡æ—¶å™¨ã€‚b å¤„å¡«å†™ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">vote.reply.Term = vote.args.Term</span><br><span class="line">vote.reply.VoteGranted = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">vote.args.CandidateId)</span><br><span class="line">rf.mu.Lock()</span><br><span class="line"><span class="keyword">if</span> vote.args.Term &lt; rf.curTerm &#123;</span><br><span class="line">	rf.mu.Unlock()</span><br><span class="line">	vote.notify &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">	<span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// grant vote, update curTerm</span></span><br><span class="line"><span class="keyword">if</span> vote.args.Term &gt; rf.curTerm ||</span><br><span class="line">	(vote.args.Term == rf.curTerm &amp;&amp; rf.votedFor == vote.args.CandidateId) &#123;</span><br><span class="line">	rf.curTerm = vote.args.Term</span><br><span class="line">	rf.votedFor = vote.args.CandidateId</span><br><span class="line">	vote.reply.Term = rf.curTerm</span><br><span class="line">	vote.reply.VoteGranted = <span class="literal">true</span></span><br><span class="line">	<span class="comment">// reset timer</span></span><br><span class="line">	resetTimer(timer, electionTimeout())</span><br><span class="line">&#125;</span><br><span class="line">rf.mu.Unlock()</span><br><span class="line">vote.notify &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæä¸€å˜´ï¼Œ<code>time.Timer</code> å’Œ <code>time.Ticker</code> çœŸçš„å¾ˆå®¹æ˜“ç”¨é”™ï¼Œè¿™é‡Œå»ºè®®å‚è€ƒ golang å…³äºè¿™ä¸¤è€…çš„<a target="_blank" rel="noopener" href="https://pkg.go.dev/time">æ–‡æ¡£</a>ã€‚</p>
<p>å½“æ”¶åˆ° AppendEntries RPCï¼ŒåŒæ ·ä¾ç…§ paper ä¸­æ‰€è¯´çš„æ£€æŸ¥ä»»æœŸç­‰ç­‰é€»è¾‘å¦‚æ³•ç‚®åˆ¶ï¼Œc å¤„å¡«å†™ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">entry.args.LeaderId)</span><br><span class="line">rf.mu.Lock()</span><br><span class="line"><span class="keyword">if</span> entry.args.Term &lt; rf.curTerm &#123;</span><br><span class="line">	<span class="comment">// stale curTerm, do nothing</span></span><br><span class="line">	entry.reply.Term = rf.curTerm</span><br><span class="line">	entry.reply.Success = <span class="literal">false</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> entry.args.Term &gt; rf.curTerm &#123;</span><br><span class="line">	<span class="comment">// larger curTerm, may this server is out of date</span></span><br><span class="line">	rf.curTerm = entry.args.Term</span><br><span class="line">	rf.votedFor = entry.args.LeaderId</span><br><span class="line">	entry.reply.Term = rf.curTerm</span><br><span class="line">	entry.reply.Success = <span class="literal">true</span></span><br><span class="line">	resetTimer(timer, electionTimeout())</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	<span class="comment">// same curTerm, reset timer</span></span><br><span class="line">	entry.reply.Term = rf.curTerm</span><br><span class="line">	entry.reply.Success = <span class="literal">true</span></span><br><span class="line">	resetTimer(timer, electionTimeout())</span><br><span class="line">&#125;</span><br><span class="line">rf.mu.Unlock()</span><br><span class="line">entry.notify &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br></pre></td></tr></table></figure>

<h5 id="candidate-go"><a href="#candidate-go" class="headerlink" title="candidate.go"></a>candidate.go</h5><p>å…ˆç»™å‡ºæ¡†æ¶ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Candidate)</span></span> Run(rf *Raft) &#123;</span><br><span class="line">	rf.mu.Lock()</span><br><span class="line">	rf.curTerm++</span><br><span class="line"></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> send RequestVote RPC</span></span><br><span class="line">	rf.mu.Unlock()</span><br><span class="line"></span><br><span class="line">	timer := time.NewTimer(electionTimeout())</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-timer.C:</span><br><span class="line">		<span class="comment">// d è¶…æ—¶</span></span><br><span class="line">		<span class="keyword">case</span> reply := &lt;-replyChan:</span><br><span class="line">		<span class="comment">// g RequestVote å›ç­”</span></span><br><span class="line">		<span class="keyword">case</span> vote := &lt;-rf.voteChan:</span><br><span class="line">		<span class="comment">// e RequestVote è¯·æ±‚</span></span><br><span class="line">		<span class="keyword">case</span> entry := &lt;-rf.entryChan:</span><br><span class="line">		<span class="comment">// f AppendEntries è¯·æ±‚</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆè‡ªå¢ curTermï¼Œå‘é€ RequestVote è¯·æ±‚å…¶ä»–èŠ‚ç‚¹çš„é€‰ç¥¨ï¼Œéšåå¼€å¯å¾ªç¯ç­‰å¾…äº‹ä»¶é©±åŠ¨ï¼Œå…¶ä¸­ dï¼Œeï¼Œf éµéš paper æ‰€æè¿°å³å¯ï¼Œåªéœ€è¦æ³¨æ„åŠ é”é‡Šæ”¾é”çš„æ—¶æœºï¼Œè¿™é‡Œç®€å•è´´ä¸€ä¸‹ä»£ç ï¼š</p>
<p>dï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<p>eï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">rf.mu.Lock()</span><br><span class="line"><span class="keyword">if</span> vote.args.Term &gt; rf.curTerm &#123;</span><br><span class="line">	rf.curTerm = vote.args.Term</span><br><span class="line">	rf.votedFor = vote.args.CandidateId</span><br><span class="line">	rf.state = &amp;Follower&#123;&#125;</span><br><span class="line">	rf.mu.Unlock()</span><br><span class="line">	vote.reply.VoteGranted = <span class="literal">true</span></span><br><span class="line">	vote.reply.Term = vote.args.Term</span><br><span class="line">	vote.notify &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> vote.args.Term &lt; rf.curTerm &#123;</span><br><span class="line">	vote.reply.VoteGranted = <span class="literal">false</span></span><br><span class="line">	vote.reply.Term = rf.curTerm</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	vote.reply.VoteGranted = <span class="literal">false</span></span><br><span class="line">	vote.reply.Term = rf.curTerm</span><br><span class="line">&#125;</span><br><span class="line">rf.mu.Unlock()</span><br><span class="line">vote.notify &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>fï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">rf.mu.Lock()</span><br><span class="line"><span class="comment">// a leader send AppendEntries, if args.term &gt;= curTerm</span></span><br><span class="line"><span class="comment">// acknowledge the leader and become follower</span></span><br><span class="line"><span class="comment">// or reject the request then stay as candidate</span></span><br><span class="line"><span class="keyword">if</span> entry.args.Term &gt;= rf.curTerm &#123;</span><br><span class="line">	rf.curTerm = entry.args.Term</span><br><span class="line">	rf.votedFor = entry.args.LeaderId</span><br><span class="line">	rf.state = &amp;Follower&#123;&#125;</span><br><span class="line">	rf.mu.Unlock()</span><br><span class="line">	entry.reply.Term = entry.args.Term</span><br><span class="line">	entry.reply.Success = <span class="literal">true</span></span><br><span class="line">	entry.notify &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">	entry.reply.Term = rf.curTerm</span><br><span class="line">	entry.reply.Success = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line">rf.mu.Unlock()</span><br><span class="line">entry.notify &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>è€Œ candidate ç›¸è¾ƒäº follower å¤šå‡ºæ¥çš„é€»è¾‘éƒ¨åˆ†å°±å…¨éƒ¨åœ¨ä¸‹é¢äº†ï¼Œæˆ‘ä»¬éœ€è¦åœ¨è¿›å…¥å¾ªç¯å‰ä»¥ç±»ä¼¼å¼‚æ­¥çš„æ–¹å¼å‘é€ RequestVote è¯·æ±‚ï¼Œå¹¶åœ¨å¾ªç¯ä¸­é€šè¿‡æ·»åŠ äº†ä¸€ä¸ª replyChan è¿›è¡Œå¤„ç† RequestVote è¯·æ±‚çš„å›ç­”ã€‚è¿™æ ·å°†è¯·æ±‚å’Œäº‹ä»¶åˆ†å¼€ï¼Œé€»è¾‘æ²¡æœ‰é‚£ä¹ˆæ··ä¹±ã€‚äºæ˜¯ï¼Œå‘é€è¯·æ±‚çš„ä»£ç ä¸ºï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// send RequestVote RPC</span></span><br><span class="line">replyChan := <span class="built_in">make</span>(<span class="keyword">chan</span> RequestVoteReply, <span class="built_in">len</span>(rf.peers)<span class="number">-1</span>)</span><br><span class="line">args := RequestVoteArgs&#123;</span><br><span class="line">	Term:        rf.curTerm,</span><br><span class="line">	CandidateId: rf.me,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> rf.peers &#123;</span><br><span class="line">	<span class="keyword">if</span> i == rf.me &#123;</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(pees *labrpc.ClientEnd)</span></span> &#123;</span><br><span class="line">		<span class="keyword">var</span> reply RequestVoteReply</span><br><span class="line">		<span class="keyword">if</span> pees.Call(<span class="string">&quot;Raft.RequestVote&quot;</span>, &amp;args, &amp;reply) &#123;</span><br><span class="line">			replyChan &lt;- reply</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;(rf.peers[i])</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">grantedCnt := <span class="number">1</span></span><br><span class="line">minVote := <span class="built_in">len</span>(rf.peers)/<span class="number">2</span> + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>è€Œå¯¹åº”çš„äº‹ä»¶å¤„ç†ï¼Œå½“æ”¶åˆ°çš„é€‰ç¥¨å¤§äºé›†ç¾¤æ•°é‡çš„ä¸€åŠæ—¶ï¼Œè½¬æ¢ä¸º leaderï¼Œä½†åŒæ—¶ä»è¦å¤„ç†ä»»æœŸ <code>Term</code>ï¼Œgï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">rf.mu.Lock()</span><br><span class="line"><span class="keyword">if</span> reply.Term &gt; rf.curTerm &#123;</span><br><span class="line">	<span class="comment">// received larger term, become follower</span></span><br><span class="line">	rf.curTerm = reply.Term</span><br><span class="line">	rf.votedFor = <span class="number">-1</span></span><br><span class="line">	rf.state = &amp;Follower&#123;&#125;</span><br><span class="line">	rf.mu.Unlock()</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> reply.Term == rf.curTerm &amp;&amp; reply.VoteGranted &#123;</span><br><span class="line">	<span class="comment">// received a grantVote</span></span><br><span class="line">	grantedCnt++</span><br><span class="line">	<span class="keyword">if</span> grantedCnt &gt;= minVote &#123;</span><br><span class="line">		rf.state = &amp;Leader&#123;&#125;</span><br><span class="line">		rf.mu.Unlock()</span><br><span class="line">		<span class="keyword">return</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">rf.mu.Unlock()</span><br></pre></td></tr></table></figure>

<h5 id="leader-go"><a href="#leader-go" class="headerlink" title="leader.go"></a>leader.go</h5><p>æ¡†æ¶ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(l *Leader)</span></span> Run(rf *Raft) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> send heartbeat</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> send AppendEntries RPCs to all other servers</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// make heartbeat timer</span></span><br><span class="line">	timer := time.NewTimer(heartbeatTimeout())</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-timer.C:</span><br><span class="line">		<span class="comment">// h è¶…æ—¶</span></span><br><span class="line">		<span class="keyword">case</span> reply := &lt;-replyChan:</span><br><span class="line">		<span class="comment">// k AppendEntries å›ç­”</span></span><br><span class="line">		<span class="keyword">case</span> vote := &lt;-rf.voteChan:</span><br><span class="line">		<span class="comment">// i RequestVote è¯·æ±‚</span></span><br><span class="line">		<span class="keyword">case</span> entry := &lt;-rf.entryChan:</span><br><span class="line">		<span class="comment">// j AppendEntries è¯·æ±‚</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>h: è¶…æ—¶ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span></span><br></pre></td></tr></table></figure>

<p>iï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">rf.mu.Lock()</span><br><span class="line"><span class="keyword">if</span> vote.args.Term &gt; rf.curTerm &#123;</span><br><span class="line">	rf.curTerm = vote.args.Term</span><br><span class="line">	rf.votedFor = vote.args.CandidateId</span><br><span class="line">	rf.state = &amp;Follower&#123;&#125;</span><br><span class="line">	vote.reply.VoteGranted = <span class="literal">true</span></span><br><span class="line">	vote.reply.Term = rf.curTerm</span><br><span class="line">	rf.mu.Unlock()</span><br><span class="line">	vote.notify &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> vote.args.Term &lt;= rf.curTerm &#123;</span><br><span class="line">	vote.reply.VoteGranted = <span class="literal">false</span></span><br><span class="line">	vote.reply.Term = rf.curTerm</span><br><span class="line">&#125;</span><br><span class="line">rf.mu.Unlock()</span><br><span class="line">vote.notify &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>jï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">rf.mu.Lock()</span><br><span class="line"><span class="keyword">if</span> entry.args.Term &gt; rf.curTerm &#123;</span><br><span class="line">	rf.curTerm = entry.args.Term</span><br><span class="line">	rf.votedFor = entry.args.LeaderId</span><br><span class="line">	rf.state = &amp;Follower&#123;&#125;</span><br><span class="line">	entry.reply.Success = <span class="literal">true</span></span><br><span class="line">	entry.reply.Term = rf.curTerm</span><br><span class="line">	rf.mu.Unlock()</span><br><span class="line">	entry.notify &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> entry.args.Term &lt;= rf.curTerm &#123;</span><br><span class="line">	entry.reply.Success = <span class="literal">false</span></span><br><span class="line">	entry.reply.Term = rf.curTerm</span><br><span class="line">&#125;</span><br><span class="line">rf.mu.Unlock()</span><br><span class="line">entry.notify &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>æ¨¡ä»¿ RequestVote çš„å‘é€æ–¹å¼ï¼Œå‘é€ AppendEntries è¯·æ±‚ï¼Œè¿™ä¸ªå®éªŒä¸­åªéœ€è¦å‘é€ heartbeatï¼Œå®ç°èµ·æ¥å¹¶ä¸å›°éš¾ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// send heartbeat</span></span><br><span class="line">rf.mu.Lock()</span><br><span class="line">replyChan := <span class="built_in">make</span>(<span class="keyword">chan</span> AppendEntriesReply, <span class="built_in">len</span>(rf.peers))</span><br><span class="line">args := AppendEntriesArgs&#123;</span><br><span class="line">	Term:     rf.curTerm,</span><br><span class="line">	LeaderId: rf.me,</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// send AppendEntries RPCs to all other servers</span></span><br><span class="line"><span class="keyword">for</span> i := <span class="keyword">range</span> rf.peers &#123;</span><br><span class="line">	<span class="keyword">if</span> i == rf.me &#123;</span><br><span class="line">		<span class="keyword">continue</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(peer *labrpc.ClientEnd)</span></span> &#123;</span><br><span class="line">		<span class="keyword">var</span> reply AppendEntriesReply</span><br><span class="line">		<span class="keyword">if</span> peer.Call(<span class="string">&quot;Raft.AppendEntries&quot;</span>, &amp;args, &amp;reply) &#123;</span><br><span class="line">			replyChan &lt;- reply</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;(rf.peers[i])</span><br><span class="line">&#125;</span><br><span class="line">rf.mu.Unlock()</span><br></pre></td></tr></table></figure>

<p>kï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">rf.mu.Lock()</span><br><span class="line"><span class="keyword">if</span> vote.args.Term &gt; rf.curTerm &#123;</span><br><span class="line">	rf.curTerm = vote.args.Term</span><br><span class="line">	rf.votedFor = vote.args.CandidateId</span><br><span class="line">	rf.state = &amp;Follower&#123;&#125;</span><br><span class="line">	vote.reply.VoteGranted = <span class="literal">true</span></span><br><span class="line">	vote.reply.Term = rf.curTerm</span><br><span class="line">	rf.mu.Unlock()</span><br><span class="line">	vote.notify &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">	<span class="keyword">return</span></span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> vote.args.Term &lt;= rf.curTerm &#123;</span><br><span class="line">	vote.reply.VoteGranted = <span class="literal">false</span></span><br><span class="line">	vote.reply.Term = rf.curTerm</span><br><span class="line">&#125;</span><br><span class="line">rf.mu.Unlock()</span><br><span class="line">vote.notify &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æœ€å"><a href="#æœ€å" class="headerlink" title="æœ€å"></a>æœ€å</h4><p>æ•´ä¸ªå®éªŒåšä¸‹æ¥çš„æ„Ÿè§‰ï¼šéš¾ï¼Œä½†æ˜¯è±ç„¶å¼€æœ—ã€‚æ˜ç™½äº†å¾ˆå¤šä¸œè¥¿ï¼Œå¾ˆå¤šç»†èŠ‚éœ€è¦å¤„ç†ï¼Œä»¥åŠå¦‚ä½•æŠŠæ¡æ•´ä¸ªæ¡†æ¶ã€‚å†™è¿™ä¹ˆå¤æ‚çš„çŠ¶æ€æ¡†æ¶çš„åŸå› æ˜¯ä¸ºäº†åç»­å®éªŒçš„æ›´å¥½æ‹“å±•ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kujourinka.github.io/2023/02/08/6824_lab2a_leader_election/" data-id="cll2gun8n0001d8p0hzet6zcz" data-title="6.824 Lab2A Leader Election å¯è¡Œæ–¹æ¡ˆ" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-6824_lab1_MapReduce" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/12/23/6824_lab1_MapReduce/" class="article-date">
  <time class="dt-published" datetime="2022-12-23T14:00:00.000Z" itemprop="datePublished">2022-12-23</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/12/23/6824_lab1_MapReduce/">6.824 Lab1 MapReduce å¿«é€Ÿå®ç°</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>è¿™ä¸ªæ˜¯ MIT 6.824 åˆ†å¸ƒå¼ç³»ç»Ÿï¼ˆDistributed Systemsï¼‰2022 å¹´çš„ lab1ï¼Œ<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/labs/lab-mr.html">lab é“¾æ¥</a>ã€‚å­—æœ‰ç‚¹å¤šï¼Œéœ€è¦èŠ±äº›æ—¶é—´è€å¿ƒè¯»ä¸€ä¸‹ã€‚</p>
<p>ä¸ªäººè®¤ä¸ºè¿™ä¸ª Lab åœ¨å¯¹ Golang æœ‰ä¸€å®šäº†è§£çš„æƒ…å†µä¸‹ä¸æ˜¯å¾ˆéš¾å®ç°ï¼Œä¸€å®šè¦æŠŠé¢˜æ„ç†è§£æ¸…æ¥šï¼Œç”»ä¸€ä¸ªå¤§è‡´æ¡†æ¶å†åŠ¨æ‰‹ã€‚æˆ‘ç”¨äº†ä¸¤å¤©æ—¶é—´ï¼Œç¬¬ä¸€å¤©ä¸»è¦æ˜¯è¯»é¢˜ï¼ˆå†æ¬¡åæ§½ä¸€ä¸‹å­—æœ‰ç‚¹å¤šï¼‰å’Œç”»å¤§è‡´æ¡†æ¶ï¼Œç¬¬äºŒå¤©èŠ±äº†ä¸€ä¸‹åˆå‡ ä¸ªå°æ—¶å†™äº†ä»£ç ã€‚Debug æ²¡æœ‰éš¾åº¦ï¼Œå¯èƒ½æ˜¯æˆ‘è¿æ°”æ¯”è¾ƒå¥½ï¼Œä¸€æŠŠè¿‡2333</p>
<p>ä¸‹é¢å¼€å§‹è®²ä¸ªäººçš„å®ç°ï¼Œä»£ç é‡ä¸å¤§ï¼Œç®—ä¸Šæ³¨é‡Šå¤§è‡´ 200 è¡Œã€‚</p>
<p><a target="_blank" rel="noopener" href="https://github.com/KujouRinka/6.824-2022/commit/2f3c87aff43fc548f341853307b424d8ab37438e">rpc.go çš„ä¿®æ”¹</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/KujouRinka/6.824-2022/commit/9b3fc49785e57b2846145c9082a162769456a2c7">coordinator.go çš„ä¿®æ”¹</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/KujouRinka/6.824-2022/commit/e6833214404b7fb567d85ba9edc62444781ad9e7">worker.go çš„ä¿®æ”¹</a></p>
<h4 id="å¤è¿°"><a href="#å¤è¿°" class="headerlink" title="å¤è¿°"></a>å¤è¿°</h4><p>å®ç° Google æ›¾ç»ä½¿ç”¨çš„ <a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.824/papers/mapreduce.pdf">MapReduce</a> çš„ä¸€ä¸ªç®€å•ç‰ˆæœ¬ã€‚å…·ä½“çš„ï¼Œä¿®æ”¹<code>mr</code> ç›®å½•ä¸‹çš„ <code>coordinator.go</code>ï¼Œ<code>rpc.go</code>ï¼Œ<code>worker.go</code> ä¸‰ä¸ªæ–‡ä»¶å®ç° MapReduce</p>
<h4 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h4><p>ä¸»è¦æ˜¯ä¿®æ”¹ <code>coordinator.go</code> å’Œ <code>worker.go</code>ï¼Œåˆ†åˆ«å¯¹äº pdf æ–‡æ¡£ä¸­çš„ Master å’Œ Workerã€‚å‰è€…è´Ÿè´£è°ƒåº¦ä»»åŠ¡ï¼Œæ¯”å¦‚å¦‚ä½•åˆ†é…æ–‡ä»¶ï¼Œå¦‚ä½•è§„å®šè¶…æ—¶ä»»åŠ¡çš„é‡æ–°å®‰æ’ç­‰ç­‰ï¼›åè€…è´Ÿè´£å®é™…æ‰§è¡Œ <code>map</code> å’Œ <code>reduce</code> å‡½æ•°ã€‚</p>
<p>ç”±äºå®é™…ç¼–å†™çš„æ˜¯ coordinator å’Œ woker çš„åˆ†å¸ƒå¼ç‰ˆæœ¬ï¼Œæˆ‘ä»¬éœ€è¦æ¨¡æ‹Ÿè¿™ä¸¤ä¸ªå‡½æ•°å®é™…æ˜¯åœ¨ä¸åŒçš„æœºå™¨ä¸Šè¿è¡Œçš„ï¼Œæ‰€ä»¥ coordinator å’Œ worker ä¸¤è€…çš„é€šä¿¡æ–¹å¼éœ€è¦ä½¿ç”¨ RPCã€‚äºæ˜¯ï¼Œæˆ‘ä»¬éœ€è¦ç®€å•å®šä¹‰ä¸€ä¸‹ä¸¤è€…çš„é€šä¿¡æ–¹å¼ï¼š</p>
<ul>
<li>æˆ‘ä»¬éœ€è¦çŸ¥é“ï¼Œéœ€è¦å…ˆå¯åŠ¨å•ä¸ª coordinatorï¼Œéšåå†å¯åŠ¨å¤šä¸ª workerï¼Œè¿™ä¸ªæµ‹è¯•è„šæœ¬ä¸ºæˆ‘ä»¬åšäº†ï¼Œæˆ‘ä»¬åªéœ€è¦äº†è§£ã€‚</li>
<li>worker é€šè¿‡ <strong>RPC</strong> å‘ coordinator å‘é€è¯·æ±‚ï¼Œè¡¨ç¤ºâ€œæˆ‘ç°åœ¨ç©ºé—²ï¼Œè¯·ç»™æˆ‘ä¸€ä¸ªä»»åŠ¡â€ã€‚</li>
<li>ç”±äº coordinator å·²ç»æ³¨å†Œäº† RPC æœåŠ¡ï¼ˆæˆ‘ä»¬æ— éœ€å…³æ³¨ï¼‰ï¼Œå…¶å¯ä»¥æ”¶åˆ°æ¥è‡ª worker çš„ RPC è¯·æ±‚ï¼Œæˆ‘ä»¬ä» coordinator çš„ä»»åŠ¡é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªä»»åŠ¡å‘é€ç»™ workerï¼Œå¹¶åŒæ—¶å¯åŠ¨ä¸€ä¸ªç”¨äºæ¥æ”¶ worker å®Œæˆä»»åŠ¡çš„æ–¹æ³•å’Œä¸€ä¸ªè¶…æ—¶è®¡æ—¶å™¨ã€‚å‰è€…ç”¨äºå½“ worker å®Œæˆä»»åŠ¡æ—¶é€šçŸ¥ coordinatorï¼›åè€…ç”¨äºå½“ worker æ²¡æœ‰æŒ‰æ—¶å®Œæˆä»»åŠ¡æ—¶ï¼ˆpaper ä¸­è§£é‡Šçš„ï¼Œå¯èƒ½ worker å´©æºƒäº†ï¼Œæˆ–è€…ç½‘ç»œé˜»å¡ç­‰ç­‰ï¼‰ï¼Œç”¨äºå°†ä»»åŠ¡é‡æ–°å®‰æ’ç»™ä¸€ä¸ª workerã€‚</li>
<li>å½“ worker é€šè¿‡ RPC è·å–åˆ°ä»»åŠ¡æ—¶ï¼Œè¿›è¡Œå®é™…çš„å·¥ä½œã€‚å¦‚æœä»»åŠ¡å‡ºé”™ï¼Œç›´æ¥ç»ˆæ­¢ç­‰å¾…ä¸‹ä¸ªä»»åŠ¡å³å¯ï¼Œå› ä¸º coordinator çš„è®¡æ—¶å™¨ä¼šå¸®æˆ‘ä»¬é‡æ–°å®‰æ’è¿™ä¸ªä»»åŠ¡ï¼›å¦‚æœä»»åŠ¡æˆåŠŸï¼Œå†é€šè¿‡ RPC å‘ŠçŸ¥ coordinator ä»»åŠ¡å·²å®Œæˆã€‚è‹¥å¯¹ coordinator çš„ RPC è°ƒç”¨å¤±è´¥ï¼Œæˆ‘ä»¬è®¤ä¸º coordinator å·²ç»ä¼ è¾“äº†æ‰€æœ‰çš„ä»»åŠ¡å·²é€€å‡ºï¼Œworker å¯ä»¥ç»ˆæ­¢ã€‚</li>
</ul>
<p>ç®€å•çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KujouRinka/flowchart/master/cw_rpc.svg" alt="cw_rpc"></p>
<p>ç¨‹åºçš„æµç¨‹æ˜¯ï¼š</p>
<ul>
<li>æˆ‘ä»¬é€šè¿‡å¯¹æ¯ä¸ªåŸå§‹æ–‡ä»¶çš„å†…å®¹ä½œä¸º map å‡½æ•°çš„å‚æ•°è¾“å…¥ï¼Œå¾—åˆ°ä¸€ç»„ <code>KeyValue</code>ï¼Œå¯¹äºä¸åŒçš„ <code>Key</code> é€šè¿‡ <code>ihash(key) % nReduce</code> è®¡ç®—å‡ºä¸åŒçš„ <code>key</code> çš„ <code>reduceId</code> å°†è¿™ä¸ªç»“æœä¿å­˜åœ¨ <code>mr-&#123;taskId&#125;-&#123;reduceId&#125;</code> è¿™ä¸ªä¸­é—´æ–‡ä»¶ï¼ˆintermediateï¼‰ä¸­ã€‚</li>
<li>å½“æ‰€æœ‰åŸå§‹æ–‡ä»¶å…¨éƒ¨ç”Ÿæˆå®Œå¯¹åº”çš„ <code>mr-&#123;taskId&#125;-&#123;reduceId&#125;</code> æ–‡ä»¶åï¼Œcoordinator å¼€å§‹åˆ†é… reduce å‡½æ•°çš„ä»»åŠ¡ï¼Œäºæ˜¯æ¯ä¸ª worker åªéœ€è¦æŸ¥æ‰¾å…¨éƒ¨å¯¹åº”çš„ <code>reduceId</code> çš„æ–‡ä»¶ï¼ˆå…·ä½“çš„ï¼š<code>mr-*-&#123;reduceId&#125;</code>ï¼‰è¿›è¡Œåˆå¹¶å¤„ç†å’Œ  <code>reduce</code> è°ƒç”¨å³å¯ã€‚å¯¹äºæ¯ä¸ª <code>reduceId</code> ï¼Œç”Ÿæˆå¯¹åº”çš„ <code>mr-out-&#123;reduceId&#125;</code> æ–‡ä»¶ã€‚</li>
</ul>
<p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯ï¼š<code>pg*.txt</code> â€“&gt; <code>mr-1-0</code>, <code>mr-1-1</code>, â€¦, <code>mr-2-0</code>, <code>mr-2-1</code>, â€¦ â€“&gt; <code>mr-out-0</code>, <code>mr-out-1</code>,â€¦ è¿™ä¸ªæµç¨‹ã€‚</p>
<h4 id="ä»£ç ä¿®æ”¹"><a href="#ä»£ç ä¿®æ”¹" class="headerlink" title="ä»£ç ä¿®æ”¹"></a>ä»£ç ä¿®æ”¹</h4><p>ç”±äºæ²¡æœ‰åˆ é™¤çš„ä»£ç ï¼Œä¸‹é¢åªåˆ—å‡ºæ·»åŠ çš„ä»£ç ï¼š</p>
<h5 id="rpc-go"><a href="#rpc-go" class="headerlink" title="rpc.go"></a>rpc.go</h5><p>é¦–å…ˆæ·»åŠ ä¸€äº› rpc çš„å®šä¹‰ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Task <span class="keyword">struct</span> &#123;</span><br><span class="line">	Type     <span class="type">int</span>		<span class="comment">// ä»»åŠ¡çš„ç±»å‹ï¼ŒåŒ…æ‹¬ Map å’Œ Reduce</span></span><br><span class="line">	Filename <span class="type">string</span>		<span class="comment">// å½“ Type ä¸º Map æ—¶å­—æ®µæœ‰æ•ˆï¼Œè¡¨ç¤ºéœ€è¦ä½œç”¨ Map å‡½æ•°çš„æ–‡ä»¶çš„æ–‡ä»¶å</span></span><br><span class="line">	TaskId   <span class="type">int</span>		<span class="comment">// ç”¨äºæ ‡è®°è¿™ä¸ª Task çš„ Idï¼Œåœ¨å¯¹ Coordinator å›é¦ˆç»“æœçš„æ—¶å€™ä½œä¸ºå‚æ•°è¿”å›</span></span><br><span class="line">	ReduceId <span class="type">int</span>		<span class="comment">// Coordinator è¦æ±‚è¿™ä¸ª Worker ç»Ÿè®¡çš„ Reduce çš„ Id</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> (</span><br><span class="line">	Map = <span class="literal">iota</span></span><br><span class="line">	Reduce</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªå¯¹åº” Map çš„ Task ç»“æ„</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewMapTask</span><span class="params">(filename <span class="type">string</span>, taskId <span class="type">int</span>)</span></span> Task &#123;</span><br><span class="line">	<span class="keyword">return</span> Task&#123;</span><br><span class="line">		Type:     Map,</span><br><span class="line">		Filename: filename,</span><br><span class="line">		TaskId:   taskId,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªå¯¹åº” Reduce çš„ Task çš„ç»“æ„</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewReduceTask</span><span class="params">(reduceId, taskId <span class="type">int</span>)</span></span> Task &#123;</span><br><span class="line">	<span class="keyword">return</span> Task&#123;</span><br><span class="line">		Type:     Reduce,</span><br><span class="line">		TaskId:   taskId,</span><br><span class="line">		ReduceId: reduceId,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NeedWork RPC: ç”¨äºè¯·æ±‚ Coordinator åˆ†é…æ–°çš„ä»»åŠ¡</span></span><br><span class="line"><span class="comment">// NeedWork çš„å‚æ•°</span></span><br><span class="line"><span class="keyword">type</span> NeedWorkArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NeedWork çš„è¿”å›å€¼</span></span><br><span class="line"><span class="keyword">type</span> NeedWorkReply <span class="keyword">struct</span> &#123;</span><br><span class="line">	T         Task</span><br><span class="line">	ReduceCnt <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FinishWork RPC: ç”¨äºå‘ŠçŸ¥ Coordinator ä»»åŠ¡å·²å®Œæˆ</span></span><br><span class="line"><span class="comment">// FinishWork çš„å‚æ•°</span></span><br><span class="line"><span class="keyword">type</span> FinishWorkArgs <span class="keyword">struct</span> &#123;</span><br><span class="line">	TaskId <span class="type">int</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FinishWork çš„è¿”å›å€¼</span></span><br><span class="line"><span class="keyword">type</span> FinishWorkReply <span class="keyword">struct</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="worker-go"><a href="#worker-go" class="headerlink" title="worker.go"></a>worker.go</h5><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ·»åŠ çš„ import</span></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;encoding/json&quot;</span></span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;io&quot;</span></span><br><span class="line">	<span class="string">&quot;os&quot;</span></span><br><span class="line">	<span class="string">&quot;sort&quot;</span></span><br><span class="line">	<span class="string">&quot;strings&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¼•å…¥çš„æ’åº interfaceï¼Œä» mrsequential.go copy æ¥</span></span><br><span class="line"><span class="comment">// for sorting by key.</span></span><br><span class="line"><span class="keyword">type</span> ByKey []KeyValue</span><br><span class="line"></span><br><span class="line"><span class="comment">// for sorting by key.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a ByKey)</span></span> Len() <span class="type">int</span>           &#123; <span class="keyword">return</span> <span class="built_in">len</span>(a) &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a ByKey)</span></span> Swap(i, j <span class="type">int</span>)      &#123; a[i], a[j] = a[j], a[i] &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(a ByKey)</span></span> Less(i, j <span class="type">int</span>) <span class="type">bool</span> &#123; <span class="keyword">return</span> a[i].Key &lt; a[j].Key &#125;</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯ <code>Worker</code> å‡½æ•°çš„å®šä¹‰ï¼Œå…¨æ˜¯æ„Ÿæƒ…ï¼Œæ²¡æœ‰ä»»ä½• Go çš„æŠ€å·§ :)</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Worker</span><span class="params">(mapf <span class="keyword">func</span>(<span class="type">string</span>, <span class="type">string</span>)</span></span> []KeyValue,</span><br><span class="line">	reducef <span class="function"><span class="keyword">func</span><span class="params">(<span class="type">string</span>, []<span class="type">string</span>)</span></span> <span class="type">string</span>) &#123;</span><br><span class="line">	<span class="keyword">for</span> &#123;</span><br><span class="line">		needWordReply := NeedWorkReply&#123;&#125;</span><br><span class="line">		ok := call(<span class="string">&quot;Coordinator.NeedWork&quot;</span>, &amp;NeedWorkArgs&#123;&#125;, &amp;needWordReply)</span><br><span class="line">		<span class="keyword">if</span> !ok &#123;</span><br><span class="line">			<span class="comment">// å½“ RPC è°ƒç”¨å¤±è´¥ï¼Œæˆ‘ä»¬è®¤ä¸º Coordinator ä»»åŠ¡å®Œæˆé€€å‡ºï¼Œ</span></span><br><span class="line">			<span class="comment">// æ‰€ä»¥ Worker ç†åº”é€€å‡ºç»ˆæ­¢</span></span><br><span class="line">			<span class="comment">// Coordinator finish its work</span></span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> needWordReply.T.Type == Map &#123;</span><br><span class="line">			<span class="comment">// å¤„ç† Map ä»»åŠ¡çš„é€»è¾‘</span></span><br><span class="line">			filename := needWordReply.T.Filename</span><br><span class="line">			file, err := os.Open(filename)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Fatalf(<span class="string">&quot;cannot open %v&quot;</span>, filename)</span><br><span class="line">			&#125;</span><br><span class="line">			content, err := io.ReadAll(file)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Fatalf(<span class="string">&quot;cannot read %v&quot;</span>, filename)</span><br><span class="line">			&#125;</span><br><span class="line">			file.Close()</span><br><span class="line">			<span class="comment">// å¾—åˆ°å•ä¸ªæ–‡ä»¶çš„ Key-Value</span></span><br><span class="line">			kva := mapf(filename, <span class="type">string</span>(content))</span><br><span class="line"></span><br><span class="line">			<span class="comment">// ç”Ÿæˆ intermediate æ–‡ä»¶çš„é€»è¾‘</span></span><br><span class="line">			<span class="comment">// é¦–å…ˆè®¡ç®—æ¯ä¸ª Key çš„ reduceIdï¼Œä¿å­˜åœ¨ intermediate è¿™ä¸ªäºŒç»´åˆ‡ç‰‡ä¸­</span></span><br><span class="line">			intermediate := <span class="built_in">make</span>([][]KeyValue, needWordReply.ReduceCnt)</span><br><span class="line">			<span class="keyword">for</span> _, kv := <span class="keyword">range</span> kva &#123;</span><br><span class="line">				reduceTask := ihash(kv.Key) % needWordReply.ReduceCnt</span><br><span class="line">				intermediate[reduceTask] = <span class="built_in">append</span>(intermediate[reduceTask], kv)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="comment">// intermediate[i] å¯¹åº” mr-&#123;taskId&#125;-&#123;i&#125; è¿™ä¸ªä¸­é—´æ–‡ä»¶</span></span><br><span class="line">			<span class="comment">// ä»¥ paper ä¸­æç¤ºçš„ä½¿ç”¨ json çš„æ–¹å¼å†™å…¥</span></span><br><span class="line">			<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; needWordReply.ReduceCnt; i++ &#123;</span><br><span class="line">				ofilename := fmt.Sprintf(<span class="string">&quot;mr-%d-%d&quot;</span>, needWordReply.T.TaskId, i)</span><br><span class="line">				<span class="comment">// ofile, _ := os.Create(ofilename)</span></span><br><span class="line">				tf, _ := os.CreateTemp(<span class="string">&quot;./&quot;</span>, ofilename)</span><br><span class="line">				enc := json.NewEncoder(tf)</span><br><span class="line">				<span class="keyword">for</span> _, kv := <span class="keyword">range</span> intermediate[i] &#123;</span><br><span class="line">					enc.Encode(&amp;kv)</span><br><span class="line">				&#125;</span><br><span class="line">				tf.Close()</span><br><span class="line">				os.Rename(tf.Name(), ofilename)</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> <span class="keyword">if</span> needWordReply.T.Type == Reduce &#123;</span><br><span class="line">			<span class="comment">// å¤„ç† Reduce ä»»åŠ¡çš„é€»è¾‘</span></span><br><span class="line">			<span class="comment">// æ‰¾å‡ºç›®å½•ä¸‹æ‰€æœ‰å¯¹åº”è¯¥ Reduce çš„æ–‡ä»¶å</span></span><br><span class="line">			<span class="comment">// find all files corresponding to this reduce task</span></span><br><span class="line">			<span class="keyword">var</span> filenames []<span class="type">string</span></span><br><span class="line">			files, err := os.ReadDir(<span class="string">&quot;.&quot;</span>)</span><br><span class="line">			<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">				log.Fatalf(<span class="string">&quot;cannot read current directory&quot;</span>)</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">for</span> _, file := <span class="keyword">range</span> files &#123;</span><br><span class="line">				<span class="keyword">if</span> file.IsDir() &#123;</span><br><span class="line">					<span class="keyword">continue</span></span><br><span class="line">				&#125;</span><br><span class="line">				filename := file.Name()</span><br><span class="line">				prefix := <span class="string">&quot;mr-&quot;</span></span><br><span class="line">				suffix := fmt.Sprintf(<span class="string">&quot;-%d&quot;</span>, needWordReply.T.ReduceId)</span><br><span class="line">				<span class="keyword">if</span> strings.HasPrefix(filename, prefix) &amp;&amp; strings.HasSuffix(filename, suffix) &#123;</span><br><span class="line">					filenames = <span class="built_in">append</span>(filenames, filename)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// å¯¹æ‰€æœ‰å·²æ‰¾åˆ°çš„æ–‡ä»¶è¿›è¡Œè¯»å–</span></span><br><span class="line">			<span class="comment">// do reduce job</span></span><br><span class="line">			<span class="keyword">var</span> kva []KeyValue</span><br><span class="line">			<span class="keyword">for</span> _, filename := <span class="keyword">range</span> filenames &#123;</span><br><span class="line">				file, err := os.Open(filename)</span><br><span class="line">				<span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">					log.Fatalf(<span class="string">&quot;cannot open %v&quot;</span>, filename)</span><br><span class="line">				&#125;</span><br><span class="line">				dec := json.NewDecoder(file)</span><br><span class="line">				<span class="keyword">for</span> &#123;</span><br><span class="line">					<span class="keyword">var</span> kv KeyValue</span><br><span class="line">					<span class="keyword">if</span> err := dec.Decode(&amp;kv); err != <span class="literal">nil</span> &#123;</span><br><span class="line">						<span class="keyword">break</span></span><br><span class="line">					&#125;</span><br><span class="line">					kva = <span class="built_in">append</span>(kva, kv)</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// å¯¹è¯¥ä»»åŠ¡è¿›è¡Œ Reduce è°ƒç”¨ï¼Œé€»è¾‘å’Œ mrsequential.go å®Œå…¨ä¸€è‡´ï¼Œä»£ç ç›´æ¥ copy</span></span><br><span class="line">			<span class="comment">// copy from mrsequential.go</span></span><br><span class="line">			sort.Sort(ByKey(kva))</span><br><span class="line">			oname := fmt.Sprintf(<span class="string">&quot;mr-out-%d&quot;</span>, needWordReply.T.ReduceId)</span><br><span class="line">			ofile, _ := os.Create(oname)</span><br><span class="line">			i := <span class="number">0</span></span><br><span class="line">			<span class="keyword">for</span> i &lt; <span class="built_in">len</span>(kva) &#123;</span><br><span class="line">				j := i + <span class="number">1</span></span><br><span class="line">				<span class="keyword">for</span> j &lt; <span class="built_in">len</span>(kva) &amp;&amp; kva[j].Key == kva[i].Key &#123;</span><br><span class="line">					j++</span><br><span class="line">				&#125;</span><br><span class="line">				values := []<span class="type">string</span>&#123;&#125;</span><br><span class="line">				<span class="keyword">for</span> k := i; k &lt; j; k++ &#123;</span><br><span class="line">					values = <span class="built_in">append</span>(values, kva[k].Value)</span><br><span class="line">				&#125;</span><br><span class="line">				output := reducef(kva[i].Key, values)</span><br><span class="line">				fmt.Fprintf(ofile, <span class="string">&quot;%v %v\n&quot;</span>, kva[i].Key, output)</span><br><span class="line">				i = j</span><br><span class="line">			&#125;</span><br><span class="line">			ofile.Close()</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="comment">// unknown task type</span></span><br><span class="line">			log.Fatalf(<span class="string">&quot;unknown task type: %v&quot;</span>, needWordReply.T.Type)</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// è¿è¡Œåˆ°æ­¤ä»£è¡¨è¯¥ä»»åŠ¡æˆåŠŸå®Œæˆï¼Œé€šè¿‡ RPC å‘ŠçŸ¥ Coordinator ä»»åŠ¡å®Œæˆ</span></span><br><span class="line">		<span class="comment">// make FinishWork RPC call</span></span><br><span class="line">		call(<span class="string">&quot;Coordinator.FinishWork&quot;</span>, &amp;FinishWorkArgs&#123;TaskId: needWordReply.T.TaskId&#125;, &amp;FinishWorkReply&#123;&#125;)</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// log.Printf(&quot;Worker: %v exit&quot;, os.Getpid())</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="coordinator-go"><a href="#coordinator-go" class="headerlink" title="coordinator.go"></a>coordinator.go</h5><p>ä¸ªäººè®¤ä¸º <code>coordinator.go</code> çš„å®ç°é¢‡å…·æŠ€å·§ï¼Œç½‘ç»œä¸Šå¾ˆå¤šå®ç°æœ‰å¤§é‡è¯„è®ºä»£ç â€œå¾ˆä¸ Goâ€ï¼Œæ²¡æœ‰ Go çš„é£æ ¼ã€‚</p>
<p>æˆ‘è™½è¯´ä¸æ˜¯ Go çš„é«˜æ‰‹ï¼Œä½†ä¹Ÿæœ‰ä¸€æ®µæ—¶é—´å…·ä½“å­¦ä¹ äº†ä¸€ä¸‹ Go è¿™é—¨è¯­è¨€ï¼Œå‚åŠ äº†ä¸€äº›å¼€æºé¡¹ç›®ï¼Œå¯¹è‡ªå·±çš„ä»£ç é£æ ¼è¿˜æœ‰æœ‰äº›ä¿¡å¿ƒï¼Œåœ¨è¿™é‡Œè‡ªå–è‡ªå¤¸ä¸€ä¸‹2333ï¼Œè¯ä¸å¤šè¯´ï¼Œå…ˆæ˜¯ importï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line">	<span class="string">&quot;fmt&quot;</span></span><br><span class="line">	<span class="string">&quot;log&quot;</span></span><br><span class="line">	<span class="string">&quot;sync&quot;</span></span><br><span class="line">	<span class="string">&quot;time&quot;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>å¯¹ <code>Coordinator</code> ç»“æ„ä½“çš„ä¿®æ”¹ï¼Œæ·»åŠ äº†ä¸€äº›å­—æ®µç”¨äºæ“ä½œï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Coordinator <span class="keyword">struct</span> &#123;</span><br><span class="line">	<span class="comment">// Your definitions here.</span></span><br><span class="line">	<span class="comment">// ä¿å­˜ä¸€ä¸‹ nReduce</span></span><br><span class="line">	nReduce <span class="type">int</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// å®šä¹‰ä»»åŠ¡é˜Ÿåˆ—å’Œä»»åŠ¡çš„è®¡æ•°å™¨ï¼Œ</span></span><br><span class="line">	<span class="comment">// ç”¨äºä»»åŠ¡çš„å‘é€ï¼Œåˆ¤æ–­ Map å’Œ Reduce ä»»åŠ¡çš„äº¤ç•Œä»¥åŠä½•æ—¶å…³é—­ Coordinator</span></span><br><span class="line">	<span class="comment">// task sending definition</span></span><br><span class="line">	taskQueue <span class="keyword">chan</span> Task</span><br><span class="line">	taskWg    sync.WaitGroup</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä»»åŠ¡ Id è®¡æ•°å™¨ï¼Œè‡ªå¢</span></span><br><span class="line">	<span class="comment">// task id counter</span></span><br><span class="line">	taskIdCounter <span class="type">int</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä¿å­˜ç”¨äºé€šçŸ¥ä»»åŠ¡å®Œæˆçš„ chan çš„å­—æ®µï¼Œ</span></span><br><span class="line">	<span class="comment">// è‹¥ Worker å®Œæˆå¹¶è°ƒç”¨ RPCï¼Œå¤„ç†å‡½æ•°ä¼šå‘å¯¹åº”çš„ channel å‘é€ä¸€ä¸ªä¿¡å·</span></span><br><span class="line">	<span class="comment">// task notification record</span></span><br><span class="line">	taskNotifyMap  <span class="keyword">map</span>[<span class="type">int</span>]<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;</span><br><span class="line">	taskNotifyLock sync.Mutex</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ç”¨äºæ ‡è®°æ‰€æœ‰ä»»åŠ¡æ˜¯å¦å®Œæˆ</span></span><br><span class="line">	<span class="comment">// done flag</span></span><br><span class="line">	done     <span class="type">bool</span></span><br><span class="line">	doneLock sync.Mutex</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å¾—ä¸€ä¸ªæ–°çš„ taskId</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> NewTaskId() <span class="type">int</span> &#123;</span><br><span class="line">	c.taskIdCounter++</span><br><span class="line">	<span class="keyword">return</span> c.taskIdCounter</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Done å‡½æ•°ï¼Œè¿”å›æ‰€æœ‰ä»»åŠ¡æ˜¯å¦å·²ç»å®Œæˆ</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> Done() <span class="type">bool</span> &#123;</span><br><span class="line">	c.doneLock.Lock()</span><br><span class="line">	ret := c.done</span><br><span class="line">	c.doneLock.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Your code here.</span></span><br><span class="line">	<span class="keyword">return</span> ret</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>MakeCoordinator</code> å‡½æ•°çš„è®¾è®¡ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">MakeCoordinator</span><span class="params">(files []<span class="type">string</span>, nReduce <span class="type">int</span>)</span></span> *Coordinator &#123;</span><br><span class="line">	<span class="comment">// åˆå§‹åŒ–ä¸€ä¸ª Coordinator</span></span><br><span class="line">	c := Coordinator&#123;</span><br><span class="line">		nReduce:       nReduce,</span><br><span class="line">		taskQueue:     <span class="built_in">make</span>(<span class="keyword">chan</span> Task, <span class="number">100</span>),</span><br><span class="line">		taskWg:        sync.WaitGroup&#123;&#125;,</span><br><span class="line">		taskIdCounter: <span class="number">0</span>,</span><br><span class="line">		taskNotifyMap: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="type">int</span>]<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;),</span><br><span class="line">		done:          <span class="literal">false</span>,</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// log.Printf(&quot;%d file found\n&quot;, len(files))</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// ç”±äº Reduce ä»»åŠ¡å¿…é¡»åœ¨æ‰€æœ‰ Map ä»»åŠ¡å®Œæˆåæ‰èƒ½å¼€å§‹</span></span><br><span class="line">	<span class="comment">// æ·»åŠ  Map ä»»åŠ¡è®¡æ•°åˆ° WaitGroupï¼Œç”¨äºæ ‡è¯†æ‰€æœ‰çš„ Map ä»»åŠ¡æ˜¯å¦å®Œæˆ</span></span><br><span class="line">	c.taskWg.Add(<span class="built_in">len</span>(files))</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Your code here.</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// å¼€å¯ä¸€ä¸ªæ–°çš„ goroutine å‘ c.taskQueue channel ä¸­å‘é€ä»»åŠ¡</span></span><br><span class="line">	<span class="comment">// make send task goroutine</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(files []<span class="type">string</span>)</span></span> &#123;</span><br><span class="line">		<span class="comment">// å‘é€ Map ä»»åŠ¡</span></span><br><span class="line">		<span class="comment">// send map task</span></span><br><span class="line">		<span class="keyword">for</span> _, filename := <span class="keyword">range</span> files &#123;</span><br><span class="line">			c.taskQueue &lt;- NewMapTask(filename, c.NewTaskId())</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">// log.Println(&quot;all task sent, waiting for next reduce task&quot;)</span></span><br><span class="line">		<span class="comment">// ç­‰å¾…æ‰€æœ‰ Map ä»»åŠ¡å®Œæˆï¼Œè¿™æ—¶æ‰èƒ½å‘é€ Reduce ä»»åŠ¡</span></span><br><span class="line">		<span class="comment">// wait for all map task done</span></span><br><span class="line">		c.taskWg.Wait()</span><br><span class="line">		<span class="comment">// log.Println(&quot;start sending reduce task&quot;)</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// æ·»åŠ  Reduce ä»»åŠ¡çš„è®¡æ•°</span></span><br><span class="line">		<span class="comment">// send reduce task</span></span><br><span class="line">		c.taskWg.Add(nReduce)</span><br><span class="line">        </span><br><span class="line">		<span class="comment">// ä¸‹é¢è¿™ä¸ª goroutine çš„ä½œç”¨æ˜¯</span></span><br><span class="line">		<span class="comment">// ç­‰å¾… WaitGroup å€¼ä¸º 0 æ—¶ï¼Œæ­¤æ—¶è¡¨ç¤ºæ‰€æœ‰çš„ Reduce ä»»åŠ¡ä¹Ÿå®Œæˆäº†</span></span><br><span class="line">		<span class="comment">// æ‰€ä»¥å¯ä»¥å°† c.done ç½®ä¸º trueï¼Œè¡¨ç¤º Coordinator å¯ä»¥ç»“æŸäº†</span></span><br><span class="line">		<span class="comment">// make Done() check goroutine</span></span><br><span class="line">		<span class="comment">// log.Println(&quot;waiting exit goroutine created&quot;)</span></span><br><span class="line">		<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line">			c.taskWg.Wait()</span><br><span class="line">			c.doneLock.Lock()</span><br><span class="line">			c.done = <span class="literal">true</span></span><br><span class="line">			c.doneLock.Unlock()</span><br><span class="line">		&#125;()</span><br><span class="line">		<span class="comment">// log.Println(&quot;sending reduce task&quot;)</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">// å‘é€ Reduce ä»»åŠ¡</span></span><br><span class="line">		<span class="keyword">for</span> i := <span class="number">0</span>; i &lt; nReduce; i++ &#123;</span><br><span class="line">			c.taskQueue &lt;- NewReduceTask(i, c.NewTaskId())</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;(files)</span><br><span class="line"></span><br><span class="line">	c.server()</span><br><span class="line">	<span class="keyword">return</span> &amp;c</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>NeedWork</code> RPC å‡½æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> NeedWork(args *NeedWorkArgs, reply *NeedWorkReply) <span class="type">error</span> &#123;</span><br><span class="line">	<span class="comment">// ä»ä»»åŠ¡é˜Ÿåˆ— c.taskQueue ä¸­å–å‡ºä¸€ä¸ªä»»åŠ¡ä½œä¸º RPC è¿”å›å€¼</span></span><br><span class="line">	task, ok := &lt;-c.taskQueue</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		<span class="keyword">return</span> fmt.Errorf(<span class="string">&quot;cannot get task from task queue&quot;</span>)</span><br><span class="line">	&#125;</span><br><span class="line">	reply.T = task</span><br><span class="line">	reply.ReduceCnt = c.nReduce</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ä½¿ç”¨ taskId ä½œä¸ºå”¯ä¸€ä»»åŠ¡æ ‡è¯†ï¼Œåˆ›å»ºä¸€ä¸ª struct&#123;&#125; channel</span></span><br><span class="line">	<span class="comment">// ç”¨äº FinishWork RPC å‡½æ•°é€šçŸ¥ä»»åŠ¡å·²è¢« Worker å®Œæˆ</span></span><br><span class="line">	<span class="comment">// æ³¨æ„é”çš„ä¸´ç•ŒåŒºï¼Œå¦åˆ™ä¼šå¯¼è‡´ condition race</span></span><br><span class="line">	<span class="comment">// make task notification channel</span></span><br><span class="line">	c.taskNotifyLock.Lock()</span><br><span class="line">	c.taskNotifyMap[task.TaskId] = <span class="built_in">make</span>(<span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span><br><span class="line">	<span class="comment">// å¯åŠ¨ goroutine å®šæ—¶</span></span><br><span class="line">	<span class="comment">// set timer for task</span></span><br><span class="line">	<span class="keyword">go</span> <span class="function"><span class="keyword">func</span><span class="params">(taskChan <span class="keyword">chan</span> <span class="keyword">struct</span>&#123;&#125;)</span></span> &#123;</span><br><span class="line">		<span class="keyword">select</span> &#123;</span><br><span class="line">		<span class="keyword">case</span> &lt;-taskChan:</span><br><span class="line">			<span class="comment">// ä»»åŠ¡å®Œæˆ</span></span><br><span class="line">			<span class="comment">// task done</span></span><br><span class="line">			<span class="keyword">return</span></span><br><span class="line">		<span class="keyword">case</span> &lt;-time.After(<span class="number">10</span> * time.Second):</span><br><span class="line">			<span class="comment">// ä»»åŠ¡è¶…æ—¶ï¼Œé‡æ–°å°†ä»»åŠ¡æ”¾å›ä»»åŠ¡é˜Ÿåˆ—ä¸­</span></span><br><span class="line">			c.taskQueue &lt;- task</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;(c.taskNotifyMap[task.TaskId])</span><br><span class="line">	c.taskNotifyLock.Unlock()</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>FinishWork</code> RPC å‡½æ•°ï¼š</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(c *Coordinator)</span></span> FinishWork(args *FinishWorkArgs, reply *FinishWorkReply) <span class="type">error</span> &#123;</span><br><span class="line">	taskId := args.TaskId</span><br><span class="line">	c.taskNotifyLock.Lock()</span><br><span class="line">	<span class="comment">// æ€è€ƒè¿™é‡Œä¸ºä»€ä¹ˆè¦æ£€æŸ¥ taskId æ‰€å¯¹åº”çš„å€¼æ˜¯å¦æœ‰æ•ˆ</span></span><br><span class="line">	<span class="comment">// è‹¥è€ƒè™‘ç½‘ç»œå»¶è¿Ÿä¹‹ç±»çš„ä¸ç¡®å®šå› ç´ ï¼Œå¯èƒ½å¯¼è‡´åŒä¸€ä¸ª taskId è°ƒç”¨ä¸¤æ¬¡ FinishWork å‡½æ•°</span></span><br><span class="line">	notifyChan, ok := c.taskNotifyMap[taskId]</span><br><span class="line">	<span class="keyword">if</span> !ok &#123;</span><br><span class="line">		c.taskNotifyLock.Unlock()</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">// å‘å¯¹åº” channel å‘é€ä¿¡å·è¡¨ç¤ºä»»åŠ¡å®Œæˆï¼ŒåŒæ—¶ä»»åŠ¡è®¡æ•° -1</span></span><br><span class="line">	<span class="comment">// notify task done</span></span><br><span class="line">	notifyChan &lt;- <span class="keyword">struct</span>&#123;&#125;&#123;&#125;</span><br><span class="line">	c.taskWg.Done()</span><br><span class="line">	<span class="comment">// log.Printf(&quot;task %d done\n&quot;, taskId)</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// åˆ é™¤å¯¹åº”çš„ channel</span></span><br><span class="line">	<span class="comment">// delete task notification channel</span></span><br><span class="line">	<span class="built_in">delete</span>(c.taskNotifyMap, taskId)</span><br><span class="line">	c.taskNotifyLock.Unlock()</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>é€šè¿‡è¿™ä¸ªå®éªŒæˆ‘å¤§è‡´ææ˜ç™½äº†ä¸€ä¸ªç®€å•çš„åˆ†å¸ƒå¼ç³»ç»Ÿç”±å“ªäº›éƒ¨åˆ†ç»„æˆã€‚è‡³æ­¤ï¼Œåˆ†å¸ƒå¼ç³»ç»Ÿçš„ Lab1 å®Œæˆï¼Œæˆ‘è®¤ä¸ºéš¾ç‚¹ä¸åœ¨ä»£ç çš„å®ç°ï¼Œè€Œæ˜¯é¢˜ç›®çš„ç†è§£ã€‚æ›´å¹²å‡€çš„ä»£ç å®ç°è§æœ¬äººçš„ <a target="_blank" rel="noopener" href="https://github.com/KujouRinka/6.824-2022/commits/master">github commit history</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kujourinka.github.io/2022/12/23/6824_lab1_MapReduce/" data-id="cll2gun8i0000d8p061q241v7" data-title="6.824 Lab1 MapReduce å¿«é€Ÿå®ç°" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-6s018_lab5cow" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/12/04/6s018_lab5cow/" class="article-date">
  <time class="dt-published" datetime="2022-12-04T05:00:00.000Z" itemprop="datePublished">2022-12-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/12/04/6s018_lab5cow/">6.s018 lab5 cow(Copy-on-write fork) è¸©å‘æŒ‡å—</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>å¦‚é¢˜ï¼Œä¸è®²åºŸè¯ï¼Œç›´æ¥å¼€å§‹ã€‚2020 å¹´çš„ labï¼Œ<a target="_blank" rel="noopener" href="https://pdos.csail.mit.edu/6.828/2020/labs/cow.html">lab é“¾æ¥</a></p>
<h4 id="å¤è¿°"><a href="#å¤è¿°" class="headerlink" title="å¤è¿°"></a>å¤è¿°</h4><p>å®ç°è°ƒç”¨ <code>fork()</code> æ—¶çš„å†™æ—¶å¤åˆ¶ï¼Œå³ copy-on-writeã€‚</p>
<h4 id="æ€è·¯"><a href="#æ€è·¯" class="headerlink" title="æ€è·¯"></a>æ€è·¯</h4><p>æ ¹æ®æç¤ºï¼š</p>
<ul>
<li><p>ä¿®æ”¹ <code>uvmcopy()</code> å‡½æ•°ã€‚è¯¥å‡½æ•°ä»…ä¼šè¢« <code>fork()</code> è°ƒç”¨ï¼ŒåŸæœ¬ç”¨äºå°†<strong>çˆ¶è¿›ç¨‹</strong>çš„ pagetable ä¸­æ‰€å«çš„æ‰€æœ‰ page å¤åˆ¶åˆ°<strong>å­è¿›ç¨‹</strong>çš„ pagetable ä¸­ï¼Œç±»ä¼¼ deepcopyï¼›ä¿®æ”¹åçš„ <code>uvmcopy()</code> å‡½æ•°ä½¿ç”¨æµ…æ‹·è´ï¼Œå­è¿›ç¨‹çš„ pagetable ç»“æ„ä¸çˆ¶è¿›ç¨‹å®Œå…¨ä¸€è‡´ã€‚<strong>ä½†åŒæ—¶</strong>ï¼Œæˆ‘ä»¬éœ€è¦æŠŠçˆ¶è¿›ç¨‹å’Œå­è¿›<strong>ä¸¤è€…</strong>çš„ pagetable ä¸­çš„æ‰€æœ‰ pte ä¸­ï¼Œ<code>PTE_W</code> æœ‰æ•ˆçš„ pte çš„è¿™ä¸€ä½æ¸…ç©ºï¼Œå…·ä½“è¡¨ç°ä¸ºä½¿ç”¨ <code>*pte &amp;= ~PTE_W</code>ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦ä½¿ç”¨ pte ä¸­ <code>RSW</code> ä¸­çš„å…¶ä¸­ä¸€ä½ï¼Œç”¨äºæ ‡è®°è¿™ä¸ª pte å®ç°äº† cowï¼Œè¿™é‡Œæˆ‘é€‰æ‹©äº†ä½¿ç”¨ç¬¬ 8 ä½ä½œä¸ºæ ‡è®°ï¼Œå®šä¹‰ä¸ºï¼š<code>#define PTE_COWPG (1L &lt;&lt; 8)</code> å¯¹ pte åš <code>*pte |= PTE_COW</code> æ“ä½œã€‚</p>
</li>
<li><p>ä¿®æ”¹ <code>usertrap()</code> å‡½æ•°ï¼Œä¸ºå…¶æ·»åŠ  scause å¤„ç†å…¥å£ã€‚ç”± riscv æ–‡æ¡£ï¼Œæˆ‘ä»¬ä»…éœ€å¤„ç† 15 å· codeï¼Œè¯¥ code ä»£è¡¨ Store&#x2F;AMO page faultï¼Œè€Œ 13 å·ä»£è¡¨çš„ Load page fault ä¸åœ¨æˆ‘ä»¬å®ç° cow çš„å¤„ç†èŒƒå›´å†…ã€‚åœ¨è¿™ä¸ª scause å¤„ç†åˆ†æ”¯é‡Œï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡è°ƒç”¨ <code>r_stval()</code> å¾—çŸ¥å¯¼è‡´ page fault çš„<strong>è™šæ‹Ÿ</strong>åœ°å€ï¼Œå¹¶<strong>ä¸€å®š</strong>è¦åˆ¤æ–­è¿™ä¸ªåœ°å€æ˜¯å¦ä¸ºåˆæ³•çš„ cow åœ°å€ï¼Œè‹¥å¦ï¼Œå°†è¿›ç¨‹æ ‡è®°ä¸º killed å¹¶è¿”å›ï¼Œå¦åˆ™ï¼Œå¤åˆ¶ stval åœ°å€ä¸­ä¸€ä¸ª page çš„å†…å®¹è‡³æ–°è·‘åˆ†é…çš„ç©ºé—´ï¼Œè®¡ç®—å‡ºæ­£ç¡®çš„ pte ç›®å½•å¹¶é‡å†™ã€‚</p>
</li>
<li><p>è¿™é‡Œæ˜¯ä¸€æ­¥éå¸¸å®¹æ˜“å‡ºé”™ï¼Œå³å…³äºæ¯ä¸€ä¸ª page çš„å¼•ç”¨è®¡æ•° (Reference Count)ã€‚åŸºæœ¬æ€è·¯æ˜¯ç»´æŠ¤ä¸€ä¸ªå…³äºæ¯ä¸ª page çš„ arrayï¼Œæ¯ä¸ª page å¯¹åº”å…¶åœ¨ array ä¸­çš„ç´¢å¼•ä¸ºè¯¥ page çš„ç‰©ç†åœ°å€é™¤ä»¥ PGSIZE(4096)ï¼Œå³ <code>pa / PGSIZE</code>ï¼Œæˆ‘ä»¬è¿˜èƒ½ç²—ç•¥è®¡ç®—å‡ºè¿™ä¸ªè¡¨çš„é•¿åº¦ä¸º <code>PHYSTOP &gt;&gt; PGSHIFT</code>ã€‚å¯¹äºï¼š</p>
<ul>
<li><p>æ¯æ¬¡ <code>kalloc()</code> è°ƒç”¨ï¼Œåˆ†é…æ–°çš„ pageï¼Œæˆ‘ä»¬å¯¹è¯¥ page æ‰€å¯¹åº”çš„ rc åŠ  1</p>
</li>
<li><p>æ¯æ¬¡ <code>kfree()</code> è°ƒç”¨ï¼Œå°†è¯¥ page å¯¹åº”çš„ rc å‡ 1ï¼Œè‹¥æ­¤æ—¶ rc ä¸º 0ï¼Œåˆ™çœŸæ­£é‡Šæ”¾è¿™æ®µå†…å­˜ï¼Œå¦åˆ™ä»€ä¹ˆä¹Ÿä¸åšã€‚<br>è¿™é‡Œï¼Œæˆ‘ä»¬æœ‰å¦‚ä¸‹å®šä¹‰ï¼š<code>#define RC_SZ PHYSTOP &gt;&gt; PGSHIFT</code></p>
</li>
<li><p><code>uvmcopy()</code> ä¸­ï¼Œå¯¹æ¯ä¸ªæ·»åŠ äº† <code>PTE_COWPG</code> çš„ pte æ¡ç›®å¯¹åº”çš„<strong>ç‰©ç†åœ°å€</strong>çš„ rc åŠ  1</p>
</li>
<li><p><code>usertrap()</code> ä¸­ï¼Œåœ¨å¤„ç† cow çš„åˆ†æ”¯ä¸­ï¼Œå¯¹å¯¼è‡´ page fault çš„<strong>è™šæ‹Ÿåœ°å€</strong>æ‰€å¯¹åº”çš„<strong>ç‰©ç†åœ°å€</strong>çš„ rc å‡ 1</p>
</li>
</ul>
</li>
</ul>
<p>è€Œä»»ä½•ä¸€æ­¥å¯¹ rc çš„è¯»å†™ï¼Œéœ€è¦è¿›è¡Œ<strong>åŠ é”</strong>å¤„ç†ï¼Œå¦åˆ™ä¼šå¯¼è‡´æ¡ä»¶ç«äº‰ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œä¸º xv6 æ·»åŠ  <code>CPUS=1</code> å‚æ•°èƒ½å‹‰å¼ºé€šè¿‡æµ‹è¯•ï¼Œä½†å®é™…æµ‹è¯•ä¸­æ— æ³•å¾—åˆ°æ­£ç¡®ç»“æœã€‚</p>
<ul>
<li>ä¿®æ”¹ <code>copyout()</code> å‡½æ•°ï¼Œè¿™ä¸€æ­¥ä¸åœ¨ scause ä¸­æ‰€åšçš„ä¿®æ”¹å¦‚å‡ºä¸€è¾™ï¼Œä¸å†å¤è¿°ã€‚</li>
</ul>
<h4 id="ä»£ç ä¿®æ”¹"><a href="#ä»£ç ä¿®æ”¹" class="headerlink" title="ä»£ç ä¿®æ”¹"></a>ä»£ç ä¿®æ”¹</h4><ul>
<li><code>defs.h</code>ï¼šæ·»åŠ å‡ ä¸ªå¯¼å‡ºçš„å‡½æ•°</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">// kalloc.c</span></span><br><span class="line">+ <span class="type">void</span>            <span class="title function_">acquire_kmem</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">+ <span class="type">void</span>            <span class="title function_">release_kmem</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">+ <span class="type">void</span>            <span class="title function_">add_rc</span><span class="params">(uint64)</span>;</span><br><span class="line">+ <span class="type">void</span>            <span class="title function_">sub_rc</span><span class="params">(uint64)</span>;</span><br><span class="line">+ <span class="type">int</span>             <span class="title function_">get_rc</span><span class="params">(uint64)</span>;</span><br><span class="line">+ <span class="type">void</span>            <span class="title function_">set_rc</span><span class="params">(uint64, <span class="type">int</span>)</span>;</span><br><span class="line">  <span class="type">void</span>*           <span class="title function_">kalloc</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line">  <span class="type">void</span>            <span class="title function_">kfree</span><span class="params">(<span class="type">void</span> *)</span>;</span><br><span class="line">  <span class="type">void</span>            <span class="title function_">kinit</span><span class="params">(<span class="type">void</span>)</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// vm.c</span></span><br><span class="line">+ <span class="type">pte_t</span> *         <span class="title function_">walk</span><span class="params">(<span class="type">pagetable_t</span>, uint64, <span class="type">int</span>)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>riscv.h</code>ï¼šæ·»åŠ  <code>PTE_COWPG</code> å®šä¹‰</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> PTE_COWPG (1L &lt;&lt; 8)</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>kalloc.c</code>ï¼šæ·»åŠ ä¸€äº› rc çš„å‡½æ•°ï¼Œä¿®æ”¹ <code>kalloc()</code> å’Œ <code>kfree()</code>ã€‚éœ€è¦æ³¨æ„æ“ä½œ rc æ—¶çš„åŠ é”æ—¶æœºã€‚è¿™é‡Œçš„ä»£ç ä¼˜åŒ–ç©ºé—´å¾ˆå¤§ï¼Œæˆ‘åœ¨è¿™é‡Œçš„å®ç°æ˜¯ <code>kmem.freelist</code> å’Œ <code>kmem.rc</code> ä½¿ç”¨åŒä¸€æŠŠé”ï¼Œå¯ä»¥å†ç ”ç©¶ä¸€ä¸‹é”çš„é¢—ç²’åº¦ï¼Œæˆ–è€…ä¸º rc å•ç‹¬ç»†åˆ†å‡ºä¸€ä¸ªé”ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">+ <span class="meta">#<span class="keyword">define</span> RC_SZ PHYSTOP &gt;&gt; PGSHIFT</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">spinlock</span> <span class="title">lock</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">freelist</span>;</span></span><br><span class="line">+   uint8 rc[RC_SZ];</span><br><span class="line">  &#125; kmem;</span><br><span class="line"></span><br><span class="line">+ <span class="type">void</span> <span class="title function_">acquire_kmem</span><span class="params">()</span> &#123;</span><br><span class="line">+   acquire(&amp;kmem.lock);</span><br><span class="line">+ &#125;</span><br><span class="line"></span><br><span class="line">+ <span class="type">void</span> <span class="title function_">release_kmem</span><span class="params">()</span> &#123;</span><br><span class="line">+   release(&amp;kmem.lock);</span><br><span class="line">+ &#125;</span><br><span class="line"></span><br><span class="line">+ <span class="type">void</span> <span class="title function_">add_rc</span><span class="params">(uint64 a)</span> &#123;</span><br><span class="line">+   ++kmem.rc[a &gt;&gt; PGSHIFT];</span><br><span class="line">+ &#125;</span><br><span class="line"></span><br><span class="line">+ <span class="type">void</span> <span class="title function_">sub_rc</span><span class="params">(uint64 a)</span> &#123;</span><br><span class="line">+   --kmem.rc[a &gt;&gt; PGSHIFT];</span><br><span class="line">+ &#125;</span><br><span class="line"></span><br><span class="line">+ <span class="type">int</span> <span class="title function_">get_rc</span><span class="params">(uint64 a)</span> &#123;</span><br><span class="line">+   <span class="keyword">return</span> kmem.rc[a &gt;&gt; PGSHIFT];</span><br><span class="line">+ &#125;</span><br><span class="line"></span><br><span class="line">+ <span class="type">void</span> <span class="title function_">set_rc</span><span class="params">(uint64 a, <span class="type">int</span> rc)</span> &#123;</span><br><span class="line">+   kmem.rc[a &gt;&gt; PGSHIFT] = rc;</span><br><span class="line">+ &#125;</span><br></pre></td></tr></table></figure>

<p><strong>æ³¨æ„</strong>ä¸‹é¢å¯¹ <code>freerange()</code> å‡½æ•°çš„ä¿®æ”¹ï¼šè¯¥å‡½æ•°åœ¨ xv6 å¯åŠ¨æ—¶è°ƒç”¨ï¼Œå¹¶å¯¹æ¯ä¸ª page è°ƒç”¨ä¸€æ¬¡ <code>kfree()</code> ï¼Œç”±äº <code>kfree()</code> ä¼šå°†æ‰€å¯¹åº” page çš„ rc å‡ 1ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ <code>kfree()</code> è°ƒç”¨ä¹‹å‰å°†æ‰€å¯¹åº”çš„ page çš„ rc ç½®ä¸º 1ï¼Œå¦åˆ™ä¼šå¯¼è‡´ç³»ç»Ÿåˆå§‹åŒ–åè¿™äº› page çš„ rc ä¸º -1ï¼Œå¼•èµ·æœªçŸ¥çš„é”™è¯¯ã€‚è¿™é‡Œä¸ç”¨ä¸º rc åŠ é”çš„åŸå› æ˜¯ vx6 å¯åŠ¨æ—¶åªä¼šä½¿ç”¨ä¸€ä¸ªæ ¸ï¼Œä¸ä¼šäº§ç”Ÿç«äº‰é—®é¢˜ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">  <span class="type">void</span></span><br><span class="line">  <span class="title function_">freerange</span><span class="params">(<span class="type">void</span> *pa_start, <span class="type">void</span> *pa_end)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">char</span> *p;</span><br><span class="line">    p = (<span class="type">char</span>*)PGROUNDUP((uint64)pa_start);</span><br><span class="line">-   <span class="keyword">for</span>(; p + PGSIZE &lt;= (<span class="type">char</span>*)pa_end; p += PGSIZE)</span><br><span class="line">+   <span class="keyword">for</span>(; p + PGSIZE &lt;= (<span class="type">char</span>*)pa_end; p += PGSIZE) &#123;</span><br><span class="line">+     kmem.rc[((uint64)p) &gt;&gt; PGSHIFT] = <span class="number">1</span>;</span><br><span class="line">    kfree(p);</span><br><span class="line">+   &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯ <code>kalloc()</code> å’Œ <code>kfree()</code> çš„ä¿®æ”¹ï¼Œæ³¨æ„é”çš„æ“æ§æ—¶æœºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">  <span class="type">void</span></span><br><span class="line">  <span class="title function_">kfree</span><span class="params">(<span class="type">void</span> *pa)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(((uint64)pa % PGSIZE) != <span class="number">0</span> || (<span class="type">char</span>*)pa &lt; end || (uint64)pa &gt;= PHYSTOP)</span><br><span class="line">      panic(<span class="string">&quot;kfree&quot;</span>);</span><br><span class="line"></span><br><span class="line">+   acquire(&amp;kmem.lock);</span><br><span class="line">+   <span class="type">int</span> rc = get_rc((uint64) pa);</span><br><span class="line">+   <span class="keyword">if</span> (rc == <span class="number">0</span>)</span><br><span class="line">+     panic(<span class="string">&quot;kfree: bad rc&quot;</span>);</span><br><span class="line">+   sub_rc((uint64) pa);</span><br><span class="line">+   <span class="keyword">if</span> (get_rc((uint64) pa) != <span class="number">0</span>) &#123;</span><br><span class="line">+     release(&amp;kmem.lock);</span><br><span class="line">+     <span class="keyword">return</span>;</span><br><span class="line">+   &#125;</span><br><span class="line">    <span class="comment">// Fill with junk to catch dangling refs.</span></span><br><span class="line">    <span class="built_in">memset</span>(pa, <span class="number">1</span>, PGSIZE);</span><br><span class="line"></span><br><span class="line">    r = (<span class="keyword">struct</span> run*)pa;</span><br><span class="line">-   acquire(&amp;kmem.lock);</span><br><span class="line">    r-&gt;next = kmem.freelist;</span><br><span class="line">    kmem.freelist = r;</span><br><span class="line">    release(&amp;kmem.lock);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="type">void</span> *</span><br><span class="line">  <span class="title function_">kalloc</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">run</span> *<span class="title">r</span>;</span></span><br><span class="line"></span><br><span class="line">    acquire(&amp;kmem.lock);</span><br><span class="line">    r = kmem.freelist;</span><br><span class="line">-   <span class="keyword">if</span>(r)</span><br><span class="line">+   <span class="keyword">if</span>(r) &#123;</span><br><span class="line">+     kmem.freelist = r-&gt;next;</span><br><span class="line">+     <span class="keyword">if</span> (get_rc((uint64) r) != <span class="number">0</span>)</span><br><span class="line">+       panic(<span class="string">&quot;kalloc: bad rc&quot;</span>);</span><br><span class="line">+     add_rc((uint64) r);</span><br><span class="line">+   &#125;</span><br><span class="line">    release(&amp;kmem.lock);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(r)</span><br><span class="line">      <span class="built_in">memset</span>((<span class="type">char</span>*)r, <span class="number">5</span>, PGSIZE); <span class="comment">// fill with junk</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="type">void</span>*)r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>vm.c:uvmcopy</code>ï¼šåˆ é™¤åŸæ¥çš„åˆ†é…å†…å­˜çš„ä»£ç ï¼Œå–è€Œä»£ä¹‹çš„æ˜¯ä»…å¯¹ pte çš„ä¿®æ”¹ã€‚æ³¨æ„ï¼šå¯¹ rc çš„æ“ä½œéœ€è¦åŠ é”ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">+ <span class="meta">#<span class="keyword">include</span> <span class="string">&quot;spinlock.h&quot;</span></span></span><br><span class="line">  <span class="type">int</span> <span class="title function_">uvmcopy</span><span class="params">(<span class="type">pagetable_t</span> old, <span class="type">pagetable_t</span> new, uint64 sz)</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">pte_t</span> *pte;</span><br><span class="line">    uint64 pa, i;</span><br><span class="line">    uint flags;</span><br><span class="line">-   <span class="type">char</span> *mem;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; sz; i += PGSIZE)&#123;</span><br><span class="line">      <span class="keyword">if</span>((pte = walk(old, i, <span class="number">0</span>)) == <span class="number">0</span>)</span><br><span class="line">        panic(<span class="string">&quot;uvmcopy: pte should exist&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span>((*pte &amp; PTE_V) == <span class="number">0</span>)</span><br><span class="line">        panic(<span class="string">&quot;uvmcopy: page not present&quot;</span>);</span><br><span class="line">      pa = PTE2PA(*pte);</span><br><span class="line">      flags = PTE_FLAGS(*pte);</span><br><span class="line">-     <span class="keyword">if</span>((mem = kalloc()) == <span class="number">0</span>)</span><br><span class="line">-       <span class="keyword">goto</span> err;</span><br><span class="line">-     memmove(mem, (<span class="type">char</span>*)pa, PGSIZE);</span><br><span class="line">+     <span class="keyword">if</span> (flags &amp; PTE_W) &#123;</span><br><span class="line">+       flags &amp;= ~PTE_W;</span><br><span class="line">+       flags |= PTE_COWPG;</span><br><span class="line">+       *pte = PA2PTE(pa) | flags;</span><br><span class="line">+     &#125;</span><br><span class="line">-     <span class="keyword">if</span>(mappages(new, i, PGSIZE, (uint64)mem, flags) != <span class="number">0</span>)&#123;</span><br><span class="line">+     <span class="keyword">if</span>(mappages(new, i, PGSIZE, pa, flags) != <span class="number">0</span>)&#123;</span><br><span class="line">-       kfree(mem);</span><br><span class="line">        <span class="keyword">goto</span> err;</span><br><span class="line">      &#125;</span><br><span class="line">+     acquire_kmem();  <span class="comment">// NOTE!!!</span></span><br><span class="line">+     add_rc(pa);</span><br><span class="line">+     release_kmem();  <span class="comment">// NOTE!!!</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">   err:</span><br><span class="line">    uvmunmap(new, <span class="number">0</span>, i / PGSIZE, <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>trap.c:usertrap</code>ï¼šåœ¨åˆ¤æ–­ scause çš„åˆ†æ”¯ä¸­æ’å…¥ä¸€æ®µåˆ¤æ–­ 15 å· code çš„ä»£ç å³å¯ï¼Œè¿™é‡Œæˆ‘åœ¨å¤„ç† <code>PTE_COWPG</code> çš„ page æ—¶åšäº†ä¸€ä¸ªä¼˜åŒ–ï¼šå½“äº§ç”Ÿ page fault çš„åœ°å€çš„ rc ä¸º 1 æ—¶ä¸å†åšé‡æ–°åˆ†é…å†…å­˜ï¼Œå¤åˆ¶ï¼Œé‡Šæ”¾åŸå†…å­˜çš„æ“ä½œï¼Œè€Œæ˜¯ç›´æ¥ä¿®æ”¹åŸæ¥ pte çš„ flag ä½¿å…¶æ‹¥æœ‰ <code>PTE_W</code>ï¼Œå¹¶ç§»é™¤æ‰ <code>PTE_COWPG</code> æ ‡è®°ã€‚è€æ ·å­ï¼Œè¿˜æ˜¯å¾—æ³¨æ„é”çš„ä½¿ç”¨ã€‚</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line"><span class="keyword">else</span> <span class="keyword">if</span> (cause == <span class="number">15</span>) &#123;</span><br><span class="line">    uint64 stval = r_stval();</span><br><span class="line">    <span class="keyword">if</span> (stval &gt; p-&gt;sz || stval &gt;= MAXVA) &#123;</span><br><span class="line">      p-&gt;killed = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    stval = PGROUNDDOWN(stval);</span><br><span class="line">    <span class="type">pte_t</span> *pte = walk(p-&gt;pagetable, stval, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span>(pte == <span class="number">0</span> || (*pte &amp; PTE_V) == <span class="number">0</span>) &#123;</span><br><span class="line">      p-&gt;killed = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    uint64 pa = PTE2PA(*pte);</span><br><span class="line">    uint flags = PTE_FLAGS(*pte);</span><br><span class="line">    <span class="keyword">if</span> (pa == <span class="number">0</span> || (flags &amp; PTE_COWPG) == <span class="number">0</span>) &#123;</span><br><span class="line">      p-&gt;killed = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">goto</span> out;</span><br><span class="line">    &#125;</span><br><span class="line">    flags &amp;= ~PTE_COWPG;</span><br><span class="line">    flags |= PTE_W;</span><br><span class="line">    acquire_kmem();</span><br><span class="line">    <span class="type">int</span> rc = get_rc(pa);</span><br><span class="line">    <span class="keyword">if</span> (rc == <span class="number">0</span>) &#123;</span><br><span class="line">      panic(<span class="string">&quot;usertrap: bad rc&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (rc == <span class="number">1</span>) &#123;</span><br><span class="line">      *pte |= PTE_W;</span><br><span class="line">      *pte &amp;= ~PTE_COWPG;</span><br><span class="line">      release_kmem();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      release_kmem();</span><br><span class="line">      uint64 mem = (uint64) kalloc();</span><br><span class="line">      <span class="keyword">if</span> (mem == <span class="number">0</span>) &#123;</span><br><span class="line">        p-&gt;killed = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">      &#125;</span><br><span class="line">      memmove((<span class="type">char</span>*)mem, (<span class="type">char</span>*)pa, PGSIZE);</span><br><span class="line">      <span class="comment">// <span class="doctag">NOTE:</span> cannot use sub_rc(pa)</span></span><br><span class="line">      kfree((<span class="type">void</span> *) pa);</span><br><span class="line">      *pte = PA2PTE(mem) | flags;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>ä»£ç ä¸­æœ‰ä¸€æ®µä¸èƒ½ä½¿ç”¨ <code>sub_rc()</code> çš„æ³¨é‡Šï¼ŒåŸå› å¦‚ä¸‹ï¼šåœ¨ <code>CPUS=1</code> çš„å‚æ•°ä¸‹ä½¿ç”¨æ˜¯æ²¡æœ‰é—®é¢˜çš„ï¼Œä½†è‹¥æ˜¯åœ¨å¤šæ ¸æ¨¡å¼ä¸­è¿è¡Œï¼Œåœ¨ä¸­é—´ä¸€æ®µæ²¡æœ‰æŒæœ‰é”çš„æ—¶æœŸï¼Œå…¶ä»–è¿›ç¨‹ä¹Ÿè®¸ä¼šä¿®æ”¹ rc çš„æ•°é‡ï¼Œæ­¤æ—¶ä»…ä»…è°ƒç”¨ <code>sub_rc()</code> å¯èƒ½å¯¼è‡´ rc ä¸º 0 å´æ²¡æœ‰è¢«é‡Šæ”¾çš„æƒ…å†µã€‚</p>
<ul>
<li><code>vm.c:copyout</code>ï¼šå’Œ <code>usertrap()</code> çš„ä¿®æ”¹å¦‚å‡ºä¸€è¾™ï¼Œä¸å¤šè§£é‡Šï¼š</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">  <span class="type">int</span></span><br><span class="line">  <span class="title function_">copyout</span><span class="params">(<span class="type">pagetable_t</span> pagetable, uint64 dstva, <span class="type">char</span> *src, uint64 len)</span></span><br><span class="line">  &#123;</span><br><span class="line">    uint64 n, va0, pa0;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">while</span>(len &gt; <span class="number">0</span>)&#123;</span><br><span class="line">      va0 = PGROUNDDOWN(dstva);</span><br><span class="line">      pa0 = walkaddr(pagetable, va0);</span><br><span class="line">      <span class="keyword">if</span>(pa0 == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">+     <span class="keyword">if</span> (va0 &gt;= MAXVA)</span><br><span class="line">+       <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">+     va0 = PGROUNDDOWN(va0);</span><br><span class="line">+     <span class="type">pte_t</span> *pte = walk(pagetable, va0, <span class="number">0</span>);</span><br><span class="line">+     <span class="keyword">if</span> (*pte &amp; PTE_COWPG) &#123;</span><br><span class="line">+       uint64 pa = PTE2PA(*pte);</span><br><span class="line">+       uint16 flag = PTE_FLAGS(*pte);</span><br><span class="line">+       flag &amp;= ~PTE_COWPG;</span><br><span class="line">+       flag |= PTE_W;</span><br><span class="line">+       acquire_kmem();</span><br><span class="line">+       <span class="type">int</span> rc = get_rc(pa);</span><br><span class="line">+       <span class="keyword">if</span> (rc == <span class="number">1</span>) &#123;</span><br><span class="line">+         *pte = PA2PTE(pa) | flag;</span><br><span class="line">+         release_kmem();</span><br><span class="line">+       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">+         release_kmem();</span><br><span class="line">+         uint64 mem = (uint64) kalloc();</span><br><span class="line">+         <span class="keyword">if</span> (mem == <span class="number">0</span>) &#123;</span><br><span class="line">+           <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">+         &#125;</span><br><span class="line">+         memmove((<span class="type">char</span> *) mem, (<span class="type">char</span> *) pa, PGSIZE);</span><br><span class="line">+         acquire_kmem();</span><br><span class="line">+         sub_rc(pa);</span><br><span class="line">+         release_kmem();</span><br><span class="line">+         *pte = PA2PTE(mem) | flag;</span><br><span class="line">+         pa0 = mem;</span><br><span class="line">+       &#125;</span><br><span class="line">+     &#125;</span><br><span class="line">  </span><br><span class="line">      n = PGSIZE - (dstva - va0);</span><br><span class="line">      <span class="keyword">if</span>(n &gt; len)</span><br><span class="line">        n = len;</span><br><span class="line">      memmove((<span class="type">void</span> *)(pa0 + (dstva - va0)), src, n);</span><br><span class="line">  </span><br><span class="line">      len -= n;</span><br><span class="line">      src += n;</span><br><span class="line">      dstva = va0 + PGSIZE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<h4 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h4><p>è¿™ä¸ª lab æ€»ä½“æ€è·¯å’Œå®ç°ä¸æ˜¯å¾ˆéš¾ï¼Œä½†å´è®©æˆ‘ç©¶ç«Ÿäº†å‡ ä¸ªå°æ—¶ï¼Œä¸»è¦å°±æ˜¯å¡åœ¨äº†å¼•ç”¨è®¡æ•°çš„åŒæ­¥é—®é¢˜ä¸Šï¼Œè¿™ä¸ªä¸€å®šè¦å¤šåŠ æ³¨æ„ã€‚å¯ä»¥é€šè¿‡å…ˆæ·»åŠ  <code>CPUS=1</code> å‚æ•°çœ‹çœ‹æµ‹è¯•èƒ½å¦é€šè¿‡ï¼Œç”¨è¿™ç§æ–¹å¼åˆ¤æ–­æ˜¯å¦é—®é¢˜å‡ºåœ¨åŒæ­¥ä¸Šã€‚</p>
<p>æµ‹è¯•é€šè¿‡ç»“æœæ²¡æœ‰ä»€ä¹ˆæ„ä¹‰ï¼Œå°±æ‡’å¾—è´´ä¸Šæ¥äº†ï¼ˆ</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kujourinka.github.io/2022/12/04/6s018_lab5cow/" data-id="cll2gun8p0002d8p01fc97get" data-title="6.s018 lab5 cow(Copy-on-write fork) è¸©å‘æŒ‡å—" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-linux_kernel_stack_switch" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/06/13/linux_kernel_stack_switch/" class="article-date">
  <time class="dt-published" datetime="2022-06-13T11:00:00.000Z" itemprop="datePublished">2022-06-13</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/06/13/linux_kernel_stack_switch/">å°† linux 0.11 è¿›ç¨‹åˆ‡æ¢ç”±åŸºäº tss æ”¹å†™ä¸ºåŸºäºå†…æ ¸æ ˆ</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>æ¥è‡ªå“ˆå·¥å¤§ææ²»å†›è€å¸ˆçš„æ“ä½œç³»ç»Ÿç½‘è¯¾ <a target="_blank" rel="noopener" href="https://www.icourse163.org/learn/HIT-1002531008">link</a> å®éªŒå››ã€‚</p>
<p>å…·ä½“æ˜¯ linux 0.11 ä½¿ç”¨ CPU æä¾›çš„ TSS è¿›è¡Œè¿›ç¨‹çš„åˆ‡æ¢ï¼Œè™½ç„¶ä½¿ç”¨è¿™ä¸ªæœºåˆ¶èƒ½å¾ˆæ–¹ä¾¿åœ°è¿›è¡Œè¿›ç¨‹åˆ‡æ¢ï¼Œä½†æ˜¯æ•ˆç‡ä¸å¤ªé«˜ï¼Œäºæ˜¯è¦æ±‚æˆ‘ä»¬åœ¨è¯¾ç¨‹çš„ç†è§£ä¸Šå°†å…¶æ”¹å†™ä¸ºåŸºäºå†…æ ¸æ ˆï¼ˆkernel stackï¼‰çš„è¿›ç¨‹åˆ‡æ¢ã€‚</p>
<h4 id="å†™åœ¨å‰é¢çš„åºŸè¯"><a href="#å†™åœ¨å‰é¢çš„åºŸè¯" class="headerlink" title="å†™åœ¨å‰é¢çš„åºŸè¯"></a>å†™åœ¨å‰é¢çš„åºŸè¯</h4><p>æˆ‘çš„ç†è§£èƒ½åŠ›æœ‰é™ï¼Œå¤–åŠ å‘¨å›´æ²¡æœ‰äººèƒ½æŒ‡å¯¼ï¼Œæ‘¸çˆ¬æ»šæ‰“æŸ¥é˜…äº†æ•°å¤©çš„èµ„æ–™ï¼Œç†è§£äº†å…¶ä¸­å¤§è‡´çš„åŸç†ï¼Œæ•…æ‰æœ‰äº†ä¸‹é¢è¿™ç¯‡æ–‡ç« ã€‚æˆ‘è®¤ä¸ºåªæ˜¯çœ‹çœ‹ç½‘æ–‡ï¼Œå¤§è‡´äº†è§£ä¸ªæ€è·¯ç„¶åå¿ƒé‡Œæƒ³ç€â€œå“¦å¥½åƒæ˜¯è¿™æ ·â€ï¼Œç„¶åè‰è‰äº†ç„¶è¿›å…¥ä¸‹ä¸€è¯¾æ˜¯ä¸è¡Œçš„ã€‚ä½ å¾—äº†è§£æ ¸å¿ƒä»£ç æ¯ä¸€è¡Œåšäº†ä»€ä¹ˆï¼Œä¸ºä»€ä¹ˆè¿™æ ·åšï¼Œåå¤é—®è‡ªå·±ã€‚</p>
<h4 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h4><p>ä¸‹é¢å†™ä¸€äº›å‰ç½®çŸ¥è¯†ï¼Œäº†è§£çš„å¯ä»¥å½“åšå¤ä¹ ï¼Œä¸äº†è§£çš„å¿…é¡»äº†è§£å•Šï¼Œæœ‰åŠ©äºä¸‹æ–‡çš„ç†è§£ã€‚</p>
<h5 id="ä¸­æ–­åšäº†ä»€ä¹ˆ"><a href="#ä¸­æ–­åšäº†ä»€ä¹ˆ" class="headerlink" title="ä¸­æ–­åšäº†ä»€ä¹ˆ"></a>ä¸­æ–­åšäº†ä»€ä¹ˆ</h5><p>æè€å¸ˆåœ¨<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1d4411v7u7?p=5">ç¬¬äº”è¯¾</a>ä¸­å€Ÿç”¨ç³»ç»Ÿè°ƒç”¨çš„å®ç°é¡ºä¾¿è®²äº†è®²ä¸­æ–­æ˜¯æ€ä¹ˆåšçš„ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯ç”¨ <code>int</code> æŒ‡ä»¤å‘å‡ºä¸­æ–­ä¿¡å·ï¼Œç³»ç»Ÿæ ¹æ® <code>int</code> åçš„æ“ä½œæ•°é€‰æ‹©æå‰æ³¨å†Œå¥½çš„ä¸­æ–­å¤„ç†å‡½æ•°è¿›è¡Œä¸­æ–­å¤„ç†ã€‚ä¸¾ä¸ªä¾‹ï¼Œ<code>int 0x80</code> æŒ‡ä»¤å‘å‡ºåä¼šé™·å…¥åˆ°ç³»ç»Ÿè°ƒç”¨ï¼Œæ‰§è¡Œ <code>system_call</code> ï¼ˆå®šä¹‰äº <code>kernel/system_call.s</code>ï¼‰ä¸­çš„æŒ‡ä»¤ã€‚ä¸ºä»€ä¹ˆè¿™æ¡æŒ‡ä»¤æ‰§è¡Œåä¼šç›´æ¥æ‰§è¡Œ <code>system_call</code>ï¼Ÿlinux åœ¨åˆå§‹åŒ–æ—¶è°ƒç”¨äº† <code>set_system_gate(0x80, &amp;system_call)</code> å°† <code>system_call</code> æ³¨å†Œä¸º <code>0x80</code> å·ä¸­æ–­çš„å¤„ç†å‡½æ•°ã€‚<strong>åæ–‡æåˆ°çš„ä¸­æ–­é»˜è®¤ä»¥ç³»ç»Ÿè°ƒç”¨ä½œä¸ºä¾‹å­ã€‚</strong></p>
<p>æ‰§è¡Œ <code>int</code> æŒ‡ä»¤åç”±ç”¨æˆ·æ ˆé™·å…¥å†…æ ¸æ ˆï¼Œ<strong>è¯·æ³¨æ„ï¼Œ<code>int</code> è°ƒç”¨åå¹¶ä¸æ˜¯é©¬ä¸Šæ‰§è¡Œ <code>system_call</code> ä¸­çš„ä»£ç </strong>ã€‚åœ¨ <code>int</code> è°ƒç”¨åï¼Œ<code>system_call</code> æ‰§è¡Œå‰ï¼Œéœ€è¦æŠŠç”¨æˆ·æ€å¯¹åº”çš„ä¸€äº›é‡è¦å¯„å­˜å™¨ä¿å­˜ï¼Œç”¨ä»¥ä¸­æ–­è¿”å›åçš„ç°åœºæ¢å¤ã€‚å…·ä½“çš„ï¼Œæˆ‘ä»¬éœ€è¦ä¾æ¬¡ä¿å­˜ <code>ss</code>ï¼ˆç”¨æˆ·æ•°æ®æ ˆåº•ï¼‰ï¼Œ<code>sp</code>ï¼ˆç”¨æˆ·æ•°æ®æ ˆé¡¶ï¼‰ï¼Œ<code>eflags</code>ï¼ˆæ ‡å¿—å¯„å­˜å™¨ï¼‰ï¼Œ<code>cs</code>ï¼Œ<code>ip</code> è¿™äº”ä¸ªå¯„å­˜å™¨çš„å€¼åˆ°å†…æ ¸æ ˆã€‚éšåè¿›å…¥åˆ° <code>syscall</code>ï¼Œæ­¤æ—¶å†…æ ¸æ ˆæ˜¯è¿™æ ·çš„ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KujouRinka/flowchart/master/20220613/kernel_stack0.svg" alt="kernel stack0"></p>
<p>éšåæ‰§è¡Œ <code>system_call</code> ä¸­çš„ä»£ç ã€‚è€Œè¦ä»å†…æ ¸æ ˆè¿”å›åˆ°ç”¨æˆ·æ ˆï¼Œéœ€è¦ä½¿ç”¨ <code>iret</code> æŒ‡ä»¤ï¼Œæ­¤æ—¶å¿…é¡»ä¿è¯å†…æ ¸æ ˆä¸­ä¿å­˜æœ‰ç”¨äºæ¢å¤ç”¨æˆ·æ€çš„ä¿¡æ¯ï¼Œå¦‚ä¸Šå›¾ã€‚</p>
<h5 id="TSS"><a href="#TSS" class="headerlink" title="TSS"></a>TSS</h5><p>TSS çš„ç»“æ„ç”± <code>include/linux/sched.h</code> ä¸­çš„ <code>struct tss_struct</code> å®šä¹‰ã€‚åœ¨ linux 0.11 ä»£ç ä¸­ï¼ŒTSS ç”¨äºåˆ‡æ¢è¿›ç¨‹æ—¶ï¼Œå°†å½“å‰ CPU ä¸­å¯„å­˜å™¨çš„æ‰€æœ‰å€¼ä¿å­˜åˆ°å½“å‰è¿›ç¨‹çš„ TSSï¼Œéšåä½¿ç”¨å³å°†åˆ‡æ¢çš„è¿›ç¨‹çš„ TSS ä¸­çš„ä¿¡æ¯æ¥å¡«å†™ CPU ä¸­çš„å¯„å­˜å™¨ï¼Œè¿™æ ·å°±å®Œæˆäº†è¿›ç¨‹çš„åˆ‡æ¢ã€‚å…¶ä¸­è¾ƒé‡è¦çš„å¯„å­˜å™¨æ˜¯ <code>ss</code>ï¼Œ<code>sp</code>ï¼Œ<code>cs</code>ï¼Œ<code>ip</code>ã€‚æ³¨æ„ï¼Œè¿™å››ä¸ªå¯„å­˜å™¨ï¼Œä¸ç®¡æ˜¯ç°åœ¨ CPU ä¸­çš„å€¼ï¼Œè¿˜æ˜¯å³å°†åˆ‡æ¢çš„è¿›ç¨‹çš„ TSS ä¸­æ‰€ä¿å­˜çš„è¿™å››ä¸ªå¯„å­˜å™¨çš„å€¼ï¼Œè®°å½•çš„éƒ½æ˜¯ç›¸åº”çš„<strong>å†…æ ¸æ€</strong>çš„çŠ¶æ€ã€‚</p>
<h5 id="switch-to-å‡½æ•°"><a href="#switch-to-å‡½æ•°" class="headerlink" title="switch_to å‡½æ•°"></a>switch_to å‡½æ•°</h5><p>å®šä¹‰äº <code>include/linux/sched.h</code>ã€‚<a target="_blank" rel="noopener" href="https://blog.csdn.net/smallmuou/article/details/6837087">è¿™ç¯‡åšæ–‡</a>è§£é‡Šåœ°éå¸¸å¥½ï¼Œé‡ç‚¹ç†è§£å…¶ä¸­çš„ <code>ljmp</code> æŒ‡ä»¤ï¼Œé¡ºä¾¿å¤ä¹ ä¸€ä¸‹ GDT è¡¨çš„ç»“æ„ã€‚</p>
<h5 id="å…¶ä»–çš„"><a href="#å…¶ä»–çš„" class="headerlink" title="å…¶ä»–çš„"></a>å…¶ä»–çš„</h5><p>æ—¶åˆ»è®°ä½ <code>call</code> ç›¸å½“äº <code>push ip</code>ï¼Œ<code>ret</code> ç›¸å½“äº <code>pop ip</code>ã€‚</p>
<h4 id="æµç¨‹åˆ†æ"><a href="#æµç¨‹åˆ†æ" class="headerlink" title="æµç¨‹åˆ†æ"></a>æµç¨‹åˆ†æ</h4><p>é¦–å…ˆåº”è¯¥æ˜ç¡®ï¼Œä¿®æ”¹è¿›ç¨‹åˆ‡æ¢çš„æ–¹æ³•åŒæ—¶éœ€è¦ä¿®æ”¹ <code>fork()</code> ç³»ç»Ÿè°ƒç”¨ï¼Œå› ä¸º linux å¯åŠ¨æ—¶éœ€è¦é€šè¿‡ <code>fork()</code> å¯åŠ¨ shellã€‚</p>
<p>é¦–å…ˆæ¥çœ‹ <code>system_call</code> ä¸­çš„éƒ¨åˆ†ä»£ç ï¼Œä¸é‡è¦çš„çœå»ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">system_call:</span><br><span class="line">	cmpl $nr_system_calls-1,%eax</span><br><span class="line">	ja bad_sys_call</span><br><span class="line">	push %ds</span><br><span class="line">	push %es</span><br><span class="line">	push %fs</span><br><span class="line">	pushl %edx</span><br><span class="line">	pushl %ecx</span><br><span class="line">	pushl %ebx</span><br><span class="line">	...</span><br><span class="line">	call sys_call_table(,%eax,4)</span><br></pre></td></tr></table></figure>

<p>å…¥æ ˆä¸€äº›å¯„å­˜å™¨ï¼Œä½¿ç”¨ <code>call</code> è°ƒç”¨çœŸæ­£çš„ç³»ç»Ÿè°ƒç”¨å‡½æ•°æ˜¯ï¼Œå†…æ ¸æ ˆå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KujouRinka/flowchart/master/20220613/kernel_stack1.svg" alt="kernel stack1"></p>
<p>ç³»ç»Ÿè°ƒç”¨æ‰§è¡Œå®Œæˆåï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pushl %eax</span><br><span class="line">movl current,%eax</span><br><span class="line">cmpl $0,state(%eax)		# state</span><br><span class="line">jne reschedule</span><br><span class="line">cmpl $0,counter(%eax)		# counter</span><br><span class="line">je reschedule</span><br></pre></td></tr></table></figure>

<p>å°† <code>eax</code> å…¥å†…æ ¸æ ˆï¼Œå…¶ä¸­ä¸¤ä¸ª <code>cmpl</code> åˆ†åˆ«åˆ¤æ–­è¿›ç¨‹çš„çŠ¶æ€ï¼ˆè¿è¡Œï¼ŸæŒ‚èµ·ï¼Ÿâ€¦ï¼‰å’Œæ—¶é—´ç‰‡ï¼Œæ ¹æ®åˆ¤æ–­ç»“æœå†³å®šæ˜¯å¦è·³è½¬åˆ° <code>reschedule</code> å¤„ï¼Œ<code>reschedule</code> å®šä¹‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">reschedule:</span><br><span class="line">	pushl $ret_from_sys_call</span><br><span class="line">	jmp schedule</span><br></pre></td></tr></table></figure>

<p>å°† <code>ret_from_sys_call</code> çš„åœ°å€å…¥æ ˆï¼Œè°ƒç”¨ <code>schedule</code> å‡½æ•°è¿›è¡Œè¿›ç¨‹åˆ‡æ¢ã€‚å…¶ä¸­ï¼Œå¯¹äº <code>ret_from_sys_call</code>ï¼Œå…¶æ ¸å¿ƒä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ret_from_sys_call:</span><br><span class="line">	...</span><br><span class="line">	popl %eax</span><br><span class="line">	popl %ebx</span><br><span class="line">	popl %ecx</span><br><span class="line">	popl %edx</span><br><span class="line">	pop %fs</span><br><span class="line">	pop %es</span><br><span class="line">	pop %ds</span><br><span class="line">	iret</span><br></pre></td></tr></table></figure>

<p>å°†å†…æ ¸æ ˆä¸­çš„å†…å®¹ pop ç›´åˆ°ä»…å‰© <code>ss</code>ï¼Œ<code>sp</code>ï¼Œ<code>eflags</code>ï¼Œ<code>cs</code>ï¼Œ<code>ip</code>ï¼Œè¿™äº›æ­£å¥½æ˜¯æ¢å¤åˆ°ç”¨æˆ·æ€éœ€è¦çš„å¯„å­˜å™¨ä¿¡æ¯ã€‚éšåè°ƒç”¨ <code>iret</code> å›åˆ°ç”¨æˆ·æ€ã€‚</p>
<h4 id="schedule-å’Œ-switch-to"><a href="#schedule-å’Œ-switch-to" class="headerlink" title="schedule å’Œ switch_to"></a>schedule å’Œ switch_to</h4><p><code>schedule</code> æ˜¯ä¸€ä¸ª C å‡½æ•°ï¼Œè·³è½¬åˆ° <code>schedule</code> å‡½æ•°æ—¶ï¼Œå†…æ ¸æ ˆä¸­çš„å†…å®¹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KujouRinka/flowchart/master/20220613/kernel_stack3.svg" alt="kernel stack3"></p>
<p>æ­¤æ—¶ <code>schedule</code>ï¼Œä¸­çš„è°ƒåº¦ç®—æ³•è®¡ç®—å‡ºä¸‹ä¸€ä¸ªåˆ‡æ¢çš„è¿›ç¨‹ï¼Œå¹¶è°ƒç”¨ <code>switch_to</code> åˆ‡æ¢è‡³è¿™ä¸ªè¿›ç¨‹ã€‚è°ƒç”¨ <code>switch_to</code> å‰ï¼Œå†…æ ¸æ ˆä¸­çš„å†…å®¹æ˜¯ä¸å˜çš„ã€‚</p>
<p><code>switch_to</code> çš„è®²è§£è§<a target="_blank" rel="noopener" href="https://blog.csdn.net/smallmuou/article/details/6837087">è¿™ç¯‡åšæ–‡</a>ï¼Œå†™å¾—éå¸¸å¥½ã€‚</p>
<h4 id="fork-å‡½æ•°"><a href="#fork-å‡½æ•°" class="headerlink" title="fork() å‡½æ•°"></a>fork() å‡½æ•°</h4><p><code>fork()</code>  åŸå§‹çš„å‡½æ•°çš„è®²è§£è§æè€å¸ˆçš„<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1d4411v7u7?p=12">è§†é¢‘</a>ååŠæ®µï¼Œè§£é‡Šåœ°éå¸¸æ¸…æ¥šã€‚</p>
<h4 id="æ”¹å†™æ³¨æ„äº‹é¡¹"><a href="#æ”¹å†™æ³¨æ„äº‹é¡¹" class="headerlink" title="æ”¹å†™æ³¨æ„äº‹é¡¹"></a>æ”¹å†™æ³¨æ„äº‹é¡¹</h4><p>æ”¹å†™æ—¶ä¸€å®šè¦æ¸…æ¥šç¨‹åºè¿è¡Œåˆ°æ”¹å†™å¤„æ—¶ï¼Œæ­¤æ—¶å¯„å­˜å™¨ä¸­çš„å€¼å’Œå†…æ ¸æ ˆä¸­çš„å€¼ã€‚</p>
<h4 id="æ”¹å†™-switch-to-å‡½æ•°"><a href="#æ”¹å†™-switch-to-å‡½æ•°" class="headerlink" title="æ”¹å†™ switch_to() å‡½æ•°"></a>æ”¹å†™ switch_to() å‡½æ•°</h4><p>å°†åŸå…ˆçš„ <code>switch_to</code> å®å®šä¹‰åˆ é™¤ï¼Œåœ¨ <code>system_call.s</code> æ·»åŠ  <code>switch_to</code> çš„<strong>æ±‡ç¼–</strong>å®ç°ã€‚</p>
<p>æˆ‘ä»¬å®šä¹‰ <code>long switch_to(long pnext, long ldt)</code> ä¸ºå‡½æ•°ç­¾åï¼Œå…¶ä¸­ <code>pnext</code> ä¸ºæŒ‡å‘ä¸€ä¸ª <code>task_struct</code> çš„æŒ‡é’ˆï¼Œå³ä¸º PCBï¼Œ<code>ldt</code> ä¸ºå…¶å¯¹åº”çš„ LDT æè¿°ç¬¦åœ°å€ã€‚å› æ­¤åœ¨ <code>schedule()</code> ä¸­è°ƒç”¨ <code>switch(pnext, _LDT(next))</code> å¹¶è¿›å…¥ <code>switch_to</code> å‡½æ•°ä½“åï¼Œ<code>8(%ebp)</code> ä¸º <code>pnext</code>ï¼Œ<code>12(%ebp)</code>ä¸º<code>_LDT(next)</code>ï¼Œè¿™æ˜¯ç”± C å‡½æ•°è°ƒç”¨æ—¶å°†å‚æ•°å’Œè¿”å›å€¼é€†åºå‹å…¥æ ˆä¸­æ‰€å†³å®šçš„ã€‚ä¸‹é¢è´´ä¸Šç½‘ç»œä¸Šç»™å‡ºçš„ <code>switch_to</code> å®Œæ•´å…·ä½“å®ç°ï¼Œå¹¶é€‰æ‹©ä¸€äº›è§£é‡Šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">switch_to:</span><br><span class="line">	pushl %ebp</span><br><span class="line">	movl %esp,%ebp</span><br><span class="line">	pushl %ecx</span><br><span class="line">	pushl %ebx</span><br><span class="line">	pushl %eax</span><br><span class="line">	movl 8(%ebp),%ebx</span><br><span class="line">	cmpl %ebx,current</span><br><span class="line">	je 1f</span><br><span class="line">	movl %ebx,%eax</span><br><span class="line">	xchgl %eax,current</span><br><span class="line">	movl tss,%ecx</span><br><span class="line">	addl $4096,%ebx</span><br><span class="line">	movl %ebx,4(%ecx)</span><br><span class="line">	movl %esp,12(%eax)</span><br><span class="line">	movl 8(%ebp),%ebx</span><br><span class="line">	movl 12(%ebx),%esp</span><br><span class="line">	movl 12(%ebp),%ecx	</span><br><span class="line">	lldt %cx</span><br><span class="line">	movl $0x17,%ecx</span><br><span class="line">	mov %cx,%fs</span><br><span class="line">	cmpl %eax,last_task_used_math</span><br><span class="line">	jne 1f</span><br><span class="line">	clts</span><br><span class="line">1:</span><br><span class="line">	popl %eax</span><br><span class="line">	popl %ebx</span><br><span class="line">	popl %ecx</span><br><span class="line">	popl %ebp</span><br><span class="line">	ret</span><br></pre></td></tr></table></figure>

<p>ä»ç¬¬ 1 è¡Œåˆ°ç¬¬ 7 è¡Œæ‰€ä½œçš„ä»»åŠ¡æ˜¯å¤„ç† C è°ƒç”¨çš„å¸§æ ˆï¼›ä¿å­˜ä¸€äº›å¯„å­˜å™¨çš„å€¼ï¼Œå› ä¸ºè¿™äº›å¯„å­˜å™¨ç¨åå°†ä½¿ç”¨ï¼Œç¬¬ 7 è¡Œ <code>movl 8(%ebp),%ebx</code> æ‰§è¡Œå®Œæ¯•åï¼Œå†…æ ¸æ ˆçš„çŠ¶æ€ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KujouRinka/flowchart/master/20220613/kernel_stack4.svg" alt="kernel stack4"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">movl 8(%ebp),%ebx</span><br></pre></td></tr></table></figure>

<p>å°† <code>pnext</code>ï¼Œå³æ–°è¿›ç¨‹çš„ PCB èµ‹ç»™ <code>ebx</code></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cmpl %ebx,current</span><br><span class="line">je 1f</span><br></pre></td></tr></table></figure>

<p>æ¯”è¾ƒæ–°è¿›ç¨‹çš„ PBC ä¸å½“å‰è¿›ç¨‹çš„ PCBï¼Œè‹¥ç›¸åŒï¼Œè°ƒåˆ°æ ‡ç­¾ 1 å¤„ï¼Œå³ä»€ä¹ˆä¹Ÿä¸åšè¿”å›å‡½æ•°ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">movl %ebx,%eax</span><br><span class="line">xchgl %eax,current</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œå®Œè¿™ä¸¤å¥ï¼Œ<code>ebx</code> å’Œ <code>current</code> å€¼ä¸ºæ–°çš„è¿›ç¨‹ï¼Œ<code>eax</code> ä¸ºå½“å‰è¿›ç¨‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movl tss,%ecx</span><br><span class="line">addl $4096,%ebx</span><br><span class="line">movl %ebx,4(%ecx)</span><br></pre></td></tr></table></figure>

<p>æ­¤å¤„çš„ tss ä¸ºæˆ‘ä»¬è‡ªå·±å®šä¹‰çš„å…¨å±€å˜é‡ï¼Œä½œä¸ºæ‰€æœ‰è¿›ç¨‹å…¬å…±çš„ TSS è¡¨ï¼Œæˆ‘ä»¬åœ¨ <code>kernel/sched.h</code> ä¸­åŠ ä¸Š <code>struct tss_struct *global_tss = &amp;(init_task.task.tss);</code> ä¸€å¥ï¼Œå®šä¹‰å…¨å±€ TSSã€‚</p>
<p>å¯¹äº <code>addl $4096,%ebx</code>ï¼Œç”±äº <code>ebx</code> ä¸­æ­¤å‰çš„å€¼ä¸ºæ–°çš„è¿›ç¨‹çš„ PCBï¼Œå¯¹äº linux 0.11 å…¶ä¸€é¡µå†…å­˜å¤§å°ä¸º 4kã€‚å¯¹äºä¸€ä¸ªè¿›ç¨‹ï¼Œå…¶ PCB å­˜å‚¨åœ¨ä¸€é¡µå†…å­˜çš„ä½åœ°å€ï¼Œå…¶å†…æ ¸æ ˆåœ¨è¯¥é¡µå†…å­˜çš„é«˜åœ°å€ï¼Œç»“æ„å¦‚å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KujouRinka/flowchart/master/20220613/pcb.svg" alt="pcb"></p>
<p>éšå <code>movl %ebx,4(%ecx)</code>ï¼Œå°†å†…æ ¸æ ˆæ ˆé¡¶èµ‹å€¼ç»™ TSS çš„ <code>sp0</code> å­—æ®µï¼Œè¯¥å­—æ®µåœ¨ <code>tss_struct</code> ç»“æ„çš„ç¬¬ 4 ä¸ªåç§»ä½ç½®ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦è®¾ç½® <code>sp0</code>ï¼Œå¼•ç”¨ä¸€æ®µæ¥è‡ª<a target="_blank" rel="noopener" href="https://github.com/Wangzhike/HIT-Linux-0.11/blob/master/exp4_process/%E5%9C%A8Linux-0.11%E4%B8%AD%E5%AE%9E%E7%8E%B0%E5%9F%BA%E4%BA%8E%E5%86%85%E6%A0%B8%E6%A0%88%E5%88%87%E6%8D%A2%E7%9A%84%E8%BF%9B%E7%A8%8B%E5%88%87%E6%8D%A2.md">è¿™é‡Œ</a>çš„è§£é‡Šï¼š</p>
<blockquote>
<p>è™½ç„¶æ‰€æœ‰è¿›ç¨‹å…±ç”¨ä¸€ä¸ª tssï¼Œä½†ä¸åŒè¿›ç¨‹çš„å†…æ ¸æ ˆæ˜¯ä¸åŒçš„ï¼Œæ‰€ä»¥åœ¨æ¯æ¬¡è¿›ç¨‹åˆ‡æ¢æ—¶ï¼Œéœ€è¦æ›´æ–° tss ä¸­ esp0 çš„å€¼ï¼Œè®©å®ƒæŒ‡å‘æ–°çš„è¿›ç¨‹çš„å†…æ ¸æ ˆï¼Œå¹¶ä¸”è¦æŒ‡å‘æ–°çš„è¿›ç¨‹çš„å†…æ ¸æ ˆçš„æ ˆåº•ï¼Œå³è¦ä¿è¯æ­¤æ—¶çš„å†…æ ¸æ ˆæ˜¯ä¸ªç©ºæ ˆï¼Œå¸§æŒ‡é’ˆå’Œæ ˆæŒ‡é’ˆéƒ½æŒ‡å‘å†…æ ¸æ ˆçš„æ ˆåº•ã€‚ è¿™æ˜¯å› ä¸ºæ–°è¿›ç¨‹æ¯æ¬¡ä¸­æ–­è¿›å…¥å†…æ ¸æ—¶ï¼Œå…¶å†…æ ¸æ ˆåº”è¯¥æ˜¯ä¸€ä¸ªç©ºæ ˆã€‚</p>
</blockquote>
<p>æ¥ä¸‹æ¥ä¸‰å¥ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">movl %esp,12(%eax)</span><br><span class="line">movl 8(%ebp),%ebx</span><br><span class="line">movl 12(%ebx),%esp</span><br></pre></td></tr></table></figure>

<p><code>eax</code> ä¸ºå½“å‰è¿›ç¨‹ PCBã€‚</p>
<p>è¿™é‡Œæˆ‘ä»¬éœ€è¦å…ˆä¿®æ”¹ <code>include/linux/sched.h</code> ä¸­ <code>task_struct</code> ï¼Œå³ PCB çš„å®šä¹‰ã€‚æ–°å¢ä¸€ä¸ª <code>long kernel_stack</code> å­—æ®µäºç»“æ„ä½“ç¬¬å››ä¸ªå­—æ®µï¼Œå› æ­¤è¡¨ç°ä¸ºç›¸å¯¹äºç»“æ„ä½“é¦–åœ°å€åç§» 12 ä¸ªå•ä½ã€‚</p>
<p>è¿™ä¸‰å¥çš„ä½œç”¨æ˜¯ï¼Œå°†å½“å‰ <code>esp</code> ï¼Œå³å½“å‰å†…æ ¸æ ˆæ ˆé¡¶æŒ‡é’ˆå­˜å‚¨åˆ° PCB ä¸­ï¼›ä½¿ <code>ebx</code> æŒ‡å‘æ–°è¿›ç¨‹ PCBï¼Œå°†æ–°è¿›ç¨‹ PCB çš„ <code>esp</code> å³å†…æ ¸æ ˆæ ˆé¡¶æŒ‡é’ˆèµ‹å€¼ç»™ <code>esp</code> å¯„å­˜å™¨ã€‚<strong>æ­¤æ—¶å·²ç»å®Œæˆå†…æ ¸æ ˆç”±å½“å‰è¿›ç¨‹åˆ°æ–°è¿›ç¨‹çš„åˆ‡æ¢</strong>ã€‚</p>
<p>æ¥ä¸‹æ¥ä¸¤å¥ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">movl 12(%ebp),%ecx</span><br><span class="line">lldt %cx</span><br></pre></td></tr></table></figure>

<p>åˆ‡æ¢ LDTã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">movl $0x17,%ecx</span><br><span class="line">mov %cx,%fs</span><br><span class="line">cmpl %eax,last_task_used_math</span><br><span class="line">jne 1f</span><br><span class="line">clts</span><br></pre></td></tr></table></figure>

<p>ä¸ºå›ºå®šæŒ‡ä»¤ï¼Œåç»­è¯¾ç¨‹ä¼šè®²åˆ°ï¼Œç›®å‰ä¸åšè¦æ±‚ã€‚å…·ä½“è§£é‡Šå¼•ç”¨<a target="_blank" rel="noopener" href="https://www.lanqiao.cn/courses/115/learning">è“æ¡¥äº‘è¯¾</a>ä¸­ä¸€æ®µè§£é‡Šï¼Œç›®å‰æˆ‘è¿˜ä¸äº†è§£ï¼š</p>
<blockquote>
<p>è¿™ä¸¤å¥ä»£ç çš„å«ä¹‰æ˜¯é‡æ–°å–ä¸€ä¸‹æ®µå¯„å­˜å™¨ fs çš„å€¼ï¼Œè¿™ä¸¤å¥è¯å¿…é¡»è¦åŠ ã€ä¹Ÿå¿…é¡»è¦å‡ºç°åœ¨åˆ‡æ¢å®Œ LDT ä¹‹åï¼Œè¿™æ˜¯å› ä¸ºåœ¨å®è·µé¡¹ç›® 2 ä¸­æ›¾ç»çœ‹åˆ°è¿‡ fs çš„ä½œç”¨â€”â€”é€šè¿‡ fs è®¿é—®è¿›ç¨‹çš„ç”¨æˆ·æ€å†…å­˜ï¼ŒLDT åˆ‡æ¢å®Œæˆå°±æ„å‘³ç€åˆ‡æ¢äº†åˆ†é…ç»™è¿›ç¨‹çš„ç”¨æˆ·æ€å†…å­˜åœ°å€ç©ºé—´ï¼Œæ‰€ä»¥å‰ä¸€ä¸ª fs æŒ‡å‘çš„æ˜¯ä¸Šä¸€ä¸ªè¿›ç¨‹çš„ç”¨æˆ·æ€å†…å­˜ï¼Œè€Œç°åœ¨éœ€è¦æ‰§è¡Œä¸‹ä¸€ä¸ªè¿›ç¨‹çš„ç”¨æˆ·æ€å†…å­˜ï¼Œæ‰€ä»¥å°±éœ€è¦ç”¨è¿™ä¸¤æ¡æŒ‡ä»¤æ¥é‡å– fsã€‚</p>
<p>ä¸è¿‡ï¼Œç»†å¿ƒçš„è¯»è€…å¯èƒ½ä¼šå‘ç°ï¼šfs æ˜¯ä¸€ä¸ªé€‰æ‹©å­ï¼Œå³ fs æ˜¯ä¸€ä¸ªæŒ‡å‘æè¿°ç¬¦è¡¨é¡¹çš„æŒ‡é’ˆï¼Œè¿™ä¸ªæè¿°ç¬¦æ‰æ˜¯æŒ‡å‘å®é™…çš„ç”¨æˆ·æ€å†…å­˜çš„æŒ‡é’ˆï¼Œæ‰€ä»¥ä¸Šä¸€ä¸ªè¿›ç¨‹å’Œä¸‹ä¸€ä¸ªè¿›ç¨‹çš„ fs å®é™…ä¸Šéƒ½æ˜¯ 0x17ï¼ŒçœŸæ­£æ‰¾åˆ°ä¸åŒçš„ç”¨æˆ·æ€å†…å­˜æ˜¯å› ä¸ºä¸¤ä¸ªè¿›ç¨‹æŸ¥çš„ LDT è¡¨ä¸ä¸€æ ·ï¼Œæ‰€ä»¥è¿™æ ·é‡ç½®ä¸€ä¸‹ <code>fs=0x17</code> æœ‰ç”¨å—ï¼Œæœ‰ä»€ä¹ˆç”¨ï¼Ÿè¦å›ç­”è¿™ä¸ªé—®é¢˜å°±éœ€è¦å¯¹æ®µå¯„å­˜å™¨æœ‰æ›´æ·±åˆ»çš„è®¤è¯†ï¼Œå®é™…ä¸Šæ®µå¯„å­˜å™¨åŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼šæ˜¾å¼éƒ¨åˆ†å’Œéšå¼éƒ¨åˆ†ï¼Œå¦‚ä¸‹å›¾ç»™å‡ºå®ä¾‹æ‰€ç¤ºï¼Œå°±æ˜¯é‚£ä¸ªè‘—åçš„ <code>jmpi 0, 8</code>ï¼Œè™½ç„¶æˆ‘ä»¬çš„æŒ‡ä»¤æ˜¯è®© <code>cs=8</code>ï¼Œä½†åœ¨æ‰§è¡Œè¿™æ¡æŒ‡ä»¤æ—¶ï¼Œä¼šåœ¨æ®µè¡¨ï¼ˆGDTï¼‰ä¸­æ‰¾åˆ° 8 å¯¹åº”çš„é‚£ä¸ªæè¿°ç¬¦è¡¨é¡¹ï¼Œå–å‡ºåŸºåœ°å€å’Œæ®µé™é•¿ï¼Œé™¤äº†å®Œæˆå’Œ eip çš„ç´¯åŠ ç®—å‡º PC ä»¥å¤–ï¼Œè¿˜ä¼šå°†å–å‡ºçš„åŸºåœ°å€å’Œæ®µé™é•¿æ”¾åœ¨ cs çš„éšè—éƒ¨åˆ†ï¼Œå³å›¾ä¸­çš„åŸºåœ°å€ 0 å’Œæ®µé™é•¿ 7FFã€‚ä¸ºä»€ä¹ˆè¦è¿™æ ·åšï¼Ÿä¸‹æ¬¡æ‰§è¡Œ <code>jmp 100</code> æ—¶ï¼Œç”±äº cs æ²¡æœ‰æ”¹è¿‡ï¼Œä»ç„¶æ˜¯ 8ï¼Œæ‰€ä»¥å¯ä»¥ä¸å†å»æŸ¥ GDT è¡¨ï¼Œè€Œæ˜¯ç›´æ¥ç”¨å…¶éšè—éƒ¨åˆ†ä¸­çš„åŸºåœ°å€ 0 å’Œ 100 ç´¯åŠ ç›´æ¥å¾—åˆ° PCï¼Œå¢åŠ äº†æ‰§è¡ŒæŒ‡ä»¤çš„æ•ˆç‡ã€‚ç°åœ¨æƒ³å¿…æ˜ç™½äº†ä¸ºä»€ä¹ˆé‡æ–°è®¾ç½® fs&#x3D;0x17 äº†å§ï¼Ÿè€Œä¸”ä¸ºä»€ä¹ˆè¦å‡ºç°åœ¨åˆ‡æ¢å®Œ LDT ä¹‹åï¼Ÿ</p>
</blockquote>
<p>æœ€åï¼Œæ ‡ç­¾ 1 åçš„ä»£ç ä¸ºå‡½æ•°è¿”å›æ‰€åšçš„å·¥ä½œï¼Œæœ€åè¿”å›åˆ°ç³»ç»Ÿè°ƒç”¨ <code>iret</code>ï¼Œé€€å‡ºä¸­æ–­ã€‚</p>
<h4 id="æ”¹å†™-fork-å‡½æ•°"><a href="#æ”¹å†™-fork-å‡½æ•°" class="headerlink" title="æ”¹å†™ fork() å‡½æ•°"></a>æ”¹å†™ fork() å‡½æ•°</h4><p>è°ƒç”¨ <code>fork()</code> å‡½æ•°æ—¶ï¼Œå‡½æ•°è°ƒç”¨é“¾å¤§è‡´ä¸º <code>fork(C)-&gt;syscall(asm)-&gt;sys_fork(asm)-&gt;copy_process(C)</code>ã€‚</p>
<p>è¿›å…¥ <code>copy_process</code> å‰ï¼Œå†…æ ¸æ ˆå†…å®¹å¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KujouRinka/flowchart/master/20220613/kernel_stack5.svg" alt="kernel stack5"></p>
<p>å¯¹åº”å‡½æ•°ç­¾åï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">copy_process</span><span class="params">(<span class="type">int</span> nr,<span class="type">long</span> ebp,<span class="type">long</span> edi,<span class="type">long</span> esi,<span class="type">long</span> gs,<span class="type">long</span> none,</span></span><br><span class="line"><span class="params">      <span class="type">long</span> ebx,<span class="type">long</span> ecx,<span class="type">long</span> edx,</span></span><br><span class="line"><span class="params">      <span class="type">long</span> fs,<span class="type">long</span> es,<span class="type">long</span> ds,</span></span><br><span class="line"><span class="params">      <span class="type">long</span> eip,<span class="type">long</span> cs,<span class="type">long</span> eflags,<span class="type">long</span> esp,<span class="type">long</span> ss)</span></span><br></pre></td></tr></table></figure>

<p>åœ¨ <code>copy_process</code> ä¸­ä½¿ç”¨ <code>p = get_free_page()</code> è·å¾—ä¸€é¡µæ–°çš„å†…å­˜ï¼Œè¯¥å†…å­˜å³ä¸ºæ–°è¿›ç¨‹çš„å†…æ ¸æ ˆå’Œ PCB æ‰€ä½¿ç”¨çš„çš„ç©ºé—´ï¼Œ<code>p</code> æŒ‡å‘ PCB é¦–åœ°å€ï¼Œæˆ‘ä»¬æ·»åŠ ä¸‹é¢çš„ä»£ç è®¾ç½®å­è¿›ç¨‹çš„å†…æ ¸æ ˆï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> *kernel_stack_top = (<span class="type">long</span> *)(PAGE_SIZE + (<span class="type">long</span>)p);</span><br><span class="line"><span class="comment">// prepare info for user stack</span></span><br><span class="line">*(--kernel_stack_top) = ss &amp; <span class="number">0xffff</span>;</span><br><span class="line">*(--kernel_stack_top) = esp;</span><br><span class="line">*(--kernel_stack_top) = eflags;</span><br><span class="line">*(--kernel_stack_top) = cs &amp; <span class="number">0xffff</span>;</span><br><span class="line">*(--kernel_stack_top) = eip;</span><br><span class="line">*(--kernel_stack_top) = ds &amp; <span class="number">0xffff</span>;</span><br><span class="line">*(--kernel_stack_top) = es &amp; <span class="number">0xffff</span>;</span><br><span class="line">*(--kernel_stack_top) = fs &amp; <span class="number">0xffff</span>;</span><br><span class="line">*(--kernel_stack_top) = gs &amp; <span class="number">0xffff</span>;</span><br><span class="line">*(--kernel_stack_top) = esi;</span><br><span class="line">*(--kernel_stack_top) = edi;</span><br><span class="line">*(--kernel_stack_top) = edx;</span><br><span class="line">*(--kernel_stack_top) = (<span class="type">long</span>)first_ret_from_fork;</span><br><span class="line">*(--kernel_stack_top) = ebp;</span><br><span class="line">*(--kernel_stack_top) = ecx;</span><br><span class="line">*(--kernel_stack_top) = ebx;</span><br><span class="line">*(--kernel_stack_top) = <span class="number">0</span>;	<span class="comment">// fork return 0 in child process</span></span><br><span class="line">p-&gt;kernel_stack = (<span class="type">long</span>)kernel_stack_top;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€æ¡æŒ‡ä»¤å°† <code>kernel_stack_top</code> è®¾ç½®ä¸ºå†…æ ¸æ ˆæ ˆé¡¶ï¼Œåé¢ä¾æ¬¡å¡«å†™æ•°æ®ï¼Œæœ€åä¸€æ¡æŒ‡ä»¤è®°å½•å­è¿›ç¨‹çš„å†…æ ¸æ ˆæ ˆé¡¶ï¼Œä¹Ÿå°±æ˜¯ <code>sp</code> æŒ‡é’ˆä½ç½®ã€‚</p>
<p>å¯¹äºå­è¿›ç¨‹ï¼Œ<code>fork()</code> è¿”å› 0ï¼Œå› æ­¤å°†å†…æ ¸æ ˆæ ˆé¡¶ï¼Œä¹Ÿå°±æ˜¯å¯¹åº”çš„ <code>eax</code> çš„ä½ç½®è®¾ç½®ä¸º 0ã€‚åŒæ—¶å¯ä»¥åˆ æ‰ <code>copy_process </code> ä¸­ä¸€äº›ä¸å¿…è¦çš„ä»£ç ï¼Œä¸åˆ é™¤ä¸å½±å“ç»“æœã€‚</p>
<h4 id="æ”¹å†™åçš„è¿è¡Œé€»è¾‘"><a href="#æ”¹å†™åçš„è¿è¡Œé€»è¾‘" class="headerlink" title="æ”¹å†™åçš„è¿è¡Œé€»è¾‘"></a>æ”¹å†™åçš„è¿è¡Œé€»è¾‘</h4><p>ç°åœ¨å‡è®¾æˆ‘ä»¬å°†æ‰€æœ‰ä¿®æ”¹åº”ç”¨ï¼Œæˆ‘ä»¬ç°åœ¨åˆ†æ <code>fork()</code> åå­è¿›ç¨‹çš„è¡Œä¸ºã€‚</p>
<p>å½“ <code>switch_to</code> åˆ‡æ¢åˆ°å­è¿›ç¨‹å¹¶è¿è¡Œåˆ°å…¶ä¸­çš„æ ‡ç­¾ 1 å¤„ï¼Œä¾æ¬¡å¯¹ <code>eax</code>ï¼Œ<code>ebx</code>ï¼Œ<code>ecx</code>ï¼Œ<code>ebp</code> è¿›è¡Œå‡ºæ ˆå¹¶è°ƒç”¨ <code>ret</code>ï¼Œè°ƒç”¨ <code>ret</code> æ—¶å†…æ ¸æ ˆæ ˆé¡¶ä¸º <code>first_ret_from_fork()</code> å‡½æ•°ï¼Œè€ƒè™‘è¿™ä¸ªå‡½æ•°åº”è¯¥åšä»€ä¹ˆã€‚æ—¢ç„¶å­è¿›ç¨‹å·²ç»åˆ‡æ¢å®Œæ¯•ï¼Œæˆ‘ä»¬åˆ™éœ€è¦ä»å†…æ ¸æ€è¿”å›åˆ°ç”¨æˆ·æ€æ‰§è¡Œç”¨æˆ·ä»£ç ï¼Œå› æ­¤è¯¥å‡½æ•°éœ€è¦æ‰¿æ‹…ä»å†…æ ¸æ€è¿”å›çš„ä»»åŠ¡ï¼Œè°ƒç”¨ <code>first_ret_from_fork()</code> æ—¶ï¼Œæ­¤æ—¶å¯¹åº”çš„<strong>å­è¿›ç¨‹</strong>å†…æ ¸æ ˆçš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/KujouRinka/flowchart/master/20220613/kernel_stack6.svg" alt="kernel stack6"></p>
<p>å¾ˆè‡ªç„¶å†™å‡º <code>first_ret_from_fork()</code> çš„å®šä¹‰ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">first_ret_from_fork:</span><br><span class="line">	popl %edx</span><br><span class="line">	popl %edi</span><br><span class="line">	popl %esi</span><br><span class="line">	pop %gs</span><br><span class="line">	pop %fs</span><br><span class="line">	pop %es</span><br><span class="line">	pop %ds</span><br><span class="line">	iret</span><br></pre></td></tr></table></figure>

<h4 id="å†™åœ¨åé¢çš„åºŸè¯"><a href="#å†™åœ¨åé¢çš„åºŸè¯" class="headerlink" title="å†™åœ¨åé¢çš„åºŸè¯"></a>å†™åœ¨åé¢çš„åºŸè¯</h4><p>ä¸Šé¢è®°å½•äº†ä¸€äº›æˆ‘è®¤ä¸ºè¾ƒéš¾ç†è§£çš„ç»†èŠ‚ï¼Œæˆ‘çš„å®Œæ•´çš„ä¿®æ”¹è¿‡ç¨‹è®°å½•åœ¨äº†<a target="_blank" rel="noopener" href="https://github.com/KujouRinka/linux-0.11/commit/264072e0d97567eada96cb3b47d4d3d5193e3da0">è¿™ä¸ª commit</a> é‡Œã€‚ä¸ªäººè®¤ä¸ºè¿™ä¸ªæ›´åƒæ˜¯å¯¹äºçº¿ç¨‹çš„ä¿®æ”¹ï¼Œå› ä¸ºçˆ¶å­è¿›ç¨‹å…±äº«äº†ä¸€ä¸ªç”¨æˆ·æ•°æ®æ ˆï¼Œå®é™…å†™ä»£ç éªŒè¯ä¹Ÿæ­£æ˜¯å¦‚æ­¤ï¼Œä¿®æ”¹ <code>fork()</code> åå­è¿›ç¨‹ä¸­çš„å˜é‡ä¼šå¯¹çˆ¶è¿›ç¨‹ä¸­çš„å˜é‡é€ æˆå½±å“ï¼Œåä¹‹äº¦ç„¶ã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kujourinka.github.io/2022/06/13/linux_kernel_stack_switch/" data-id="cll2gun8s0005d8p0eajq52kl" data-title="å°† linux 0.11 è¿›ç¨‹åˆ‡æ¢ç”±åŸºäº tss æ”¹å†™ä¸ºåŸºäºå†…æ ¸æ ˆ" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-brief_taking_on_creational" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/03/07/brief_taking_on_creational/" class="article-date">
  <time class="dt-published" datetime="2022-03-07T06:18:00.000Z" itemprop="datePublished">2022-03-07</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/03/07/brief_taking_on_creational/">æµ…è°ˆåˆ›å»ºå‹è®¾è®¡æ¨¡å¼</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>é€šå¸¸è®¤ä¸ºåˆ›å»ºå‹æ„é€ æ¨¡å¼ï¼ˆcreational design patternï¼‰å…±æœ‰è¿™äº”ç§ <code>Abstract Factory</code>ï¼Œ<code>Builder</code>ï¼Œ<code>Factory Method</code>ï¼Œ<code>Prototype</code>ï¼Œ<code>Singleton</code>ã€‚ä¹¦ä¸­æ‰€å¯¹åº”çš„ä¸­æ–‡ä¸€èˆ¬åˆ†åˆ«ä¸ºæŠ½è±¡å·¥å‚ï¼Œç”Ÿæˆå™¨ï¼Œå·¥å‚æ–¹æ³•ï¼ŒåŸå‹ï¼Œå•ä»¶ã€‚</p>
<p>This is a draft.</p>
<p>To be continueâ€¦</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kujourinka.github.io/2022/03/07/brief_taking_on_creational/" data-id="cll2gun8q0003d8p0d7jc7kvb" data-title="æµ…è°ˆåˆ›å»ºå‹è®¾è®¡æ¨¡å¼" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  
    <article id="post-implement_dup2" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/02/24/implement_dup2/" class="article-date">
  <time class="dt-published" datetime="2022-02-24T13:58:00.000Z" itemprop="datePublished">2022-02-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="p-name article-title" href="/2022/02/24/implement_dup2/">å®ç° dup2() å‡½æ•°</a>
    </h1>
  

      </header>
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>æ¥è‡ª APUE ä¸Šçš„ç¬¬ 3.3 é¢˜ï¼ŒåŸæ–‡å¦‚ä¸‹ï¼š</p>
<blockquote>
<p>ç¼–å†™ä¸€ä¸ªä¸ 3.12 èŠ‚ä¸­ <a target="_blank" rel="noopener" href="https://man7.org/linux/man-pages/man2/dup.2.html">dup2</a> åŠŸèƒ½ç›¸åŒçš„å‡½æ•°ï¼Œè¦æ±‚ä¸è°ƒç”¨ fcntl å‡½æ•°ï¼Œå¹¶ä¸”è¦æœ‰æ­£ç¡®çš„å‡ºé”™å¤„ç†ã€‚</p>
</blockquote>
<p>å‡½æ•°åŸå‹æ˜¯ <code>int dup2(int fd, int fd2)</code> ï¼Œä½œç”¨æ˜¯å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦ <code>fd</code>  ï¼Œä½¿ <code>fd2</code> ä¸ºæ–°çš„æè¿°ç¬¦çš„å€¼ï¼Œå³ <code>fd</code> ä¸ <code>fd2</code> å…±äº«åŒä¸€ä¸ªæ–‡ä»¶è¡¨é¡¹ã€‚è‹¥ <code>fd2</code> å·²ç»æ‰“å¼€ï¼Œåˆ™å…ˆå°†å…¶å…³é—­ã€‚</p>
<p>å¾ˆæœ‰æ„æ€çš„ä¸€ä¸ªé¢˜ã€‚ç”±äºè¦æ±‚ä¸è°ƒç”¨ <code>fcntl</code> ï¼Œåˆ™åŸºæœ¬æ€è·¯ä¸ºä½¿ç”¨ <code>dup</code> å‡½æ•°å®ç°ä¹‹ã€‚</p>
<h4 id="å®ç°åŸºæœ¬é€»è¾‘-myDup2"><a href="#å®ç°åŸºæœ¬é€»è¾‘-myDup2" class="headerlink" title="å®ç°åŸºæœ¬é€»è¾‘ myDup2"></a>å®ç°åŸºæœ¬é€»è¾‘ <code>myDup2</code></h4><p>æˆ‘ä»¬ä»¤è‡ªå·±å®ç°çš„å‡½æ•°åŸå‹ä¸º <code>int myDup2(int fd, int fd2)</code> ï¼Œå…ˆè€ƒè™‘è¯¥å‡½æ•°çš„åŸºæœ¬é€»è¾‘ã€‚</p>
<p>æˆ‘ä»¬è®©æ‰€æœ‰çš„ <code>errno</code> å¤„ç†åœ¨è¯¥å‡½æ•°è¿›è¡Œå¤„ç†ã€‚</p>
<p>é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦è¦æ±‚ä¼ å…¥å‡½æ•°çš„ä¸¤ä¸ªæ–‡ä»¶æè¿°ç¬¦å¿…é¡»æœ‰æ•ˆï¼Œäºæ˜¯æœ‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">myDup2</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> fd2)</span> &#123;</span><br><span class="line">    <span class="type">int</span> max_fd = getdtablesize();    <span class="comment">// è·å–æ–‡ä»¶æè¿°ç¬¦è¡¨çš„å¤§å°</span></span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span> || fd &gt;= max_fd || fd2 &lt; <span class="number">0</span> || fd2 &gt;= max_fd || !isOpen(fd)) &#123;</span><br><span class="line">        errno = EBADF;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ <code>getdtablesize()</code> ç”¨äºè·å–æ–‡ä»¶æè¿°ç¬¦è¡¨çš„çš„å¤§å°ï¼Œé™åˆ¶äº†ç³»ç»Ÿæœ€å¤§çš„æ–‡ä»¶æè¿°ç¬¦ã€‚</p>
<p><code>isOpen</code> å‡½æ•°ç”¨äºåˆ¤æ–­ç»™å®šæ–‡ä»¶æè¿°ç¬¦æ˜¯å¦ä¸ºå·²æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦ï¼Œåç»­å®ç°ã€‚</p>
<p>è‹¥ç»™å®šçš„æ–‡ä»¶æè¿°ç¬¦ <code>fd</code> å’Œ <code>fd2</code> æ— æ•ˆï¼Œåˆ™è®¾ç½® <code>errno</code> å¹¶è¿”å› <code>-1</code> ã€‚</p>
<p>æ¥ä¸‹æ¥ï¼Œç”± <code>dup2</code> çš„å®šä¹‰ï¼Œè‹¥ <code>fd</code> ç­‰äº <code>fd2</code> ï¼Œåˆ™ <code>dup2</code> è¿”å› <code>fd2</code> ï¼Œè€Œä¸å…³é—­å®ƒï¼›ä»¥åŠå¦‚æœ <code>fd2</code> å·²ç»æ‰“å¼€ï¼Œåˆ™å…ˆå°†å…¶å…³é—­ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> (fd == fd2)</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    <span class="keyword">if</span> (isOpen(fd2))</span><br><span class="line">        close(fd2);</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥ä¸º <code>myDup2</code> çš„æ ¸å¿ƒé€»è¾‘ã€‚æ ¹æ®ã€Œ <code>dup</code> è¿”å›çš„æ–°æ–‡ä»¶æè¿°ç¬¦ä¸€å®šæ˜¯å½“å‰å¯ç”¨æ–‡ä»¶æè¿°ç¬¦çš„æœ€å°æ•°å€¼ã€ï¼ŒåŸºæœ¬æ€è·¯ä¸ºä¸æ–­ä½¿ç”¨ <code>dup(fd)</code> ç›´è‡³å…¶è¿”å›å€¼ä¸ <code>fd2</code> ç›¸ç­‰ï¼Œéšåå°†ä¹‹å‰ä½¿ç”¨ <code>dup</code> æ‰“å¼€çš„æ–‡ä»¶æè¿°ç¬¦å…³é—­å³å¯ã€‚</p>
<p>è€ƒè™‘åˆ°éœ€è¦è®°å½•ç”± <code>dup(fd)</code> åˆ›å»ºçš„æ–‡ä»¶æè¿°ç¬¦ç”¨äºåˆ é™¤ï¼ŒåŠ ä¹‹ <code>C</code> éœ€è¦æ‰‹åŠ¨å®ç°ç±»ä¼¼åŠ¨æ€æ•°ç»„ä¹‹ç±»çš„æ•°æ®ç»“æ„ï¼Œæˆ‘ä»¬<del>å·æ‡’</del>ä½¿ç”¨é€’å½’æ›¿ä»£æ‰‹åŠ¨å­˜å‚¨çš„å·¥ä½œã€‚æˆ‘ä»¬å°†è¿™ä¸ªæ“ä½œä½¿ç”¨ <code>int recursiveDup(int fd, int fd2)</code> å®Œæˆï¼Œæˆ‘ä»¬å®šä¹‰è¿”å›å€¼ä¸ºæˆåŠŸå¤åˆ¶åçš„ <code>fd2</code> ï¼Œè‹¥å¤±è´¥ï¼Œåˆ™è¿”å› <code>-1</code> ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">    <span class="keyword">if</span> ((fd2 = recursiveDup(fd, fd2)) == <span class="number">-1</span>)</span><br><span class="line">        errno = EBADF;</span><br><span class="line">    <span class="keyword">return</span> fd2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è°ƒç”¨ <code>recursiveDup</code> åæœŸæœ›å¾—åˆ° <code>fd2</code> çš„å€¼ï¼Œè‹¥å¤±è´¥ï¼Œåˆ™è®¾ç½® <code>errno</code> ã€‚</p>
<h4 id="å®ç°æ ¸å¿ƒé€’å½’å‡½æ•°-recursiveDup"><a href="#å®ç°æ ¸å¿ƒé€’å½’å‡½æ•°-recursiveDup" class="headerlink" title="å®ç°æ ¸å¿ƒé€’å½’å‡½æ•° recursiveDup"></a>å®ç°æ ¸å¿ƒé€’å½’å‡½æ•° <code>recursiveDup</code></h4><p>é¦–å…ˆï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">recursiveDup</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> fd2)</span> &#123;</span><br><span class="line">    <span class="type">int</span> nf = dup(fd);</span><br><span class="line">    <span class="keyword">if</span> (nf == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (nf == fd2)</span><br><span class="line">        <span class="keyword">return</span> nf;</span><br><span class="line">    <span class="type">int</span> rf = recursiveDup(fd, fd2);</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨ <code>dup</code> å¤åˆ¶æ–‡ä»¶æè¿°ç¬¦ï¼Œè‹¥å¤±è´¥ï¼Œè¿”å› <code>-1</code> ï¼Œè¿™é‡Œå¹¶ä¸å¤„ç† <code>errno</code> å› ä¸ºæˆ‘ä»¬å°†æ‰€æœ‰çš„ <code>errno</code> å¤„ç†æ”¾åœ¨ <code>myDup</code> ä¸­ã€‚è‹¥å¾—åˆ°æœŸæœ›çš„æ–‡ä»¶æè¿°ç¬¦çš„å€¼ï¼Œè¿”å›ä¹‹ã€‚è‹¥å¦ï¼Œç»§ç»­é€’å½’è°ƒç”¨ <code>recursiveDup</code> ç›´è‡³å…¶äº§ç”Ÿã€‚</p>
<p>ä¹‹åï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ...</span></span><br><span class="line">    close(nf);</span><br><span class="line">    <span class="keyword">return</span> rf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³é—­ä¸åˆè¦æ±‚çš„ <code>nf</code> è¿”å›ç»“æœï¼ˆä¸è®ºæ˜¯å¦ä¸º <code>-1</code>ï¼‰ã€‚</p>
<h4 id="æ”¶å°¾ï¼Œå®ç°-isOpen"><a href="#æ”¶å°¾ï¼Œå®ç°-isOpen" class="headerlink" title="æ”¶å°¾ï¼Œå®ç° isOpen"></a>æ”¶å°¾ï¼Œå®ç° <code>isOpen</code></h4><p>å®ç°å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">isOpen</span><span class="params">(<span class="type">int</span> fd)</span> &#123;</span><br><span class="line">    <span class="type">int</span> old_errno = errno;</span><br><span class="line">    <span class="type">int</span> test_f = dup(fd);</span><br><span class="line">    errno = old_errno;</span><br><span class="line">    <span class="keyword">if</span> (test_f == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close(test_f);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬åˆ©ç”¨ <code>dup</code> å‡½æ•°åªèƒ½ä½œç”¨äºå·²æ‰“å¼€æ–‡ä»¶æè¿°ç¬¦çš„æœºåˆ¶è¿›è¡Œåˆ¤æ–­ã€‚æ³¨æ„ï¼Œæˆ‘ä»¬éœ€è¦å¯¹æœ¬æ¥çš„ <code>errno</code> è¿›è¡Œå¤„ç†ï¼Œç”±äºæˆ‘ä»¬çš„ <code>isOpen</code> ä»…è¿›è¡Œåˆ¤æ–­ï¼Œä¸åº”å¯¹ç³»ç»Ÿæœ¬æ¥çš„ <code>errno</code> æœ‰å½±å“ï¼Œ<code>dup</code> åéœ€è¦åŠæ—¶æ¢å¤ã€‚</p>
<h4 id="å®Œæ•´ä»£ç "><a href="#å®Œæ•´ä»£ç " class="headerlink" title="å®Œæ•´ä»£ç "></a>å®Œæ•´ä»£ç </h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">isOpen</span><span class="params">(<span class="type">int</span> fd)</span> &#123;</span><br><span class="line">    <span class="type">int</span> old_errno = errno;</span><br><span class="line">    <span class="type">int</span> test_f = dup(fd);</span><br><span class="line">    errno = old_errno;</span><br><span class="line">    <span class="keyword">if</span> (test_f == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    close(test_f);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">recursiveDup</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> fd2)</span> &#123;</span><br><span class="line">    <span class="type">int</span> nf = dup(fd);</span><br><span class="line">    <span class="keyword">if</span> (nf == <span class="number">-1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">if</span> (nf == fd2)</span><br><span class="line">        <span class="keyword">return</span> nf;</span><br><span class="line">    <span class="type">int</span> rf = recursiveDup(fd, fd2);</span><br><span class="line">    close(nf);</span><br><span class="line">    <span class="keyword">return</span> rf;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">myDup2</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> fd2)</span> &#123;</span><br><span class="line">    <span class="type">int</span> max_fd = getdtablesize();</span><br><span class="line">    <span class="keyword">if</span> (fd &lt; <span class="number">0</span> || fd &gt;= max_fd || fd2 &lt; <span class="number">0</span> || fd2 &gt;= max_fd || !isOpen(fd)) &#123;</span><br><span class="line">        errno = EBADF;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (fd == fd2)</span><br><span class="line">        <span class="keyword">return</span> fd;</span><br><span class="line">    <span class="keyword">if</span> (isOpen(fd2))</span><br><span class="line">        close(fd2);</span><br><span class="line">    <span class="keyword">if</span> ((fd2 = recursiveDup(fd, fd2)) == <span class="number">-1</span>)</span><br><span class="line">        errno = EBADF;</span><br><span class="line">    <span class="keyword">return</span> fd2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸ªäººæ„Ÿè§‰å¾ˆæœ‰æ„æ€çš„ä¸€ä¸ªé¢˜ï¼Œä¸æ–­åå¤åˆ©ç”¨ <code>dup</code> å‡½æ•°çš„æ€§è´¨å¾—åˆ°ç»“æœã€‚</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://kujourinka.github.io/2022/02/24/implement_dup2/" data-id="cll2gun8r0004d8p01j2bdvmf" data-title="å®ç° dup2() å‡½æ•°" class="article-share-link">Teilen</a>
      
      
      
    </footer>
  </div>
  
</article>



  


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archiv</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/08/">August 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/04/">April 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/03/">March 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2023/02/">February 2023</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/12/">December 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/06/">June 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/03/">March 2022</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/02/">February 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">letzter Beitrag</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2023/08/08/re0_ss1/">ä»é›¶å†™ä¸€ä¸ª shadowsocksï¼ˆ1ï¼‰</a>
          </li>
        
          <li>
            <a href="/2023/04/20/simple_impl_for_lazy/">ç®€è®°ä¸€æ¬¡ rCore ä¸­ sys_sbrk() ä¸ lazy allocation çš„å®ç°</a>
          </li>
        
          <li>
            <a href="/2023/03/21/nic_driver_kara_syscall_he/">ä»ç½‘å¡é©±åŠ¨åˆ°ç³»ç»Ÿè°ƒç”¨</a>
          </li>
        
          <li>
            <a href="/2023/02/08/6824_lab2a_leader_election/">6.824 Lab2A Leader Election å¯è¡Œæ–¹æ¡ˆ</a>
          </li>
        
          <li>
            <a href="/2022/12/23/6824_lab1_MapReduce/">6.824 Lab1 MapReduce å¿«é€Ÿå®ç°</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2023 Kujou Rinka<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>